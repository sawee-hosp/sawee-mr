<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sawee Rxfill 2.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíä</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      --primary: #003d82;
      --bg: #f4f6f9;
      --text: #2c3e50;
      --ha-color: #ffebee;
      --cool-color: #e3f2fd;
    }
    body { background-color: var(--bg); color: var(--text); font-family: var(--font-main) !important; padding-bottom: 60px; user-select: none; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--primary); color: white; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .nav-brand { font-weight: 600; font-size: 1.1rem; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
    .profile-mini img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid white; }

    .box-scroller { display: flex; overflow-x: auto; padding: 10px; gap: 8px; scrollbar-width: none; }
    
    .box-btn { 
      min-width: 85px; width: 85px; height: auto; min-height: 85px; padding: 5px; 
      background: var(--primary); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; 
      text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.2s; position: relative; 
    }
    .box-btn span.box-name {
        font-size: 0.7rem; line-height: 1.1; 
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        margin-top: 2px;
    }
    .box-btn.active { background: white; color: var(--primary); border: 2px solid var(--primary); transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .box-icon { font-size: 1.8rem; margin-bottom: 0px; display: block; line-height: 1; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }
    .box-btn .badge-exp { position: absolute; top: -5px; right: -5px; font-size: 9px; padding: 2px 4px; border-radius: 4px; background: red; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; animation: blink 1s linear infinite; }
    .box-btn .badge-hist-count { position: absolute; top: -5px; right: -5px; font-size: 10px; padding: 2px 5px; border-radius: 10px; background: red; color: white; border:1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 10; font-weight:bold; }

    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
    .drug-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; display: flex; flex-direction: column; position: relative; }
    .drug-img-wrap { width: 100%; aspect-ratio: 1/1; background: #e0e0e0; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #f8f8f8; padding: 5px; }
    .drug-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .drug-info { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; background: white; }

    .shelf-row-label { font-weight: bold; margin: 10px 0; padding-left: 10px; border-left: 4px solid var(--primary); color: #333; width: 100%; border-bottom: 2px solid #555; padding-bottom: 5px; }
    .shelf-item { position: relative; border:1px solid #eee; border-radius:8px; padding:5px; text-align:center; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.08); width: 31%; max-width: 130px; margin-bottom: 5px; }
    .shelf-item img { width: 90px; height: 90px; object-fit: cover; border-radius: 6px; margin-bottom: 5px; background: #e0e0e0; }
    .bg-ha { background-color: var(--ha-color); border: 1px solid red; }
    .bg-cool { background-color: var(--cool-color); border: 1px solid #2196f3; }
    .exp-badge-stock { position: absolute; top: 0; right: 0; font-size: 10px; padding: 2px 4px; border-radius: 0 8px 0 4px; color: white; font-weight: bold; z-index: 5; }
    .badge-ha { position: absolute; top: 0; left: 0; background: red; color: white; font-size: 10px; padding: 2px 4px; border-bottom-right-radius: 8px; font-weight: bold; z-index: 5; }

    .btm-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 55px; background: var(--primary); display: flex; justify-content: space-around; align-items: flex-end; z-index: 1000; padding-bottom: 2px; }
    .nav-item { text-align: center; color: rgba(255,255,255,0.6); font-size: 0.7rem; width: 25%; cursor: pointer; transition: 0.2s; padding-bottom: 4px; }
    .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 0; }
    .nav-item.active { color: white; font-weight: 600; }
    .nav-badge { position: absolute; top: 5px; right: 20px; background: red; color: white; border-radius: 50%; width: 10px; height: 10px; }
    .nav-badge-large { position: absolute; top: -5px; right: 15px; background: red; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; border: 2px solid var(--primary); }
    
    .fab-print { position: fixed; bottom: 70px; left: 15px; background: #333; color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    .fab-edit-lg { position: fixed; bottom: 70px; right: 15px; background: var(--primary); color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    
    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 32px; height: 32px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; user-select: none; }
    .btn-qty:active { background: #eee; }
    .inp-qty { width: 40px; border: none; background: transparent; text-align: center; font-weight: bold; font-size: 1.1rem; }

    /* Timeline */
    .timeline { display: flex; justify-content: space-between; position: relative; margin: 25px 0; align-items: center; }
    .timeline-line { position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: #ddd; z-index: 0; }
    .tl-step { position: relative; z-index: 1; text-align: center; background: transparent; padding: 0 5px; width: 33%; }
    .tl-icon { width: 35px; height: 35px; border-radius: 50%; background: #fff; color: #ccc; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-size: 1rem; border: 2px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .tl-time { font-size: 0.7rem; color: #666; margin-top: 2px; font-weight: bold; }
    .tl-duration { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 0.65rem; color: #0d6efd; font-weight:bold; background: rgba(255,255,255,0.9); padding: 0 2px; }
    .tl-step.step-order .tl-icon { color: #ffc107; border-color: #ffc107; }
    .tl-step.step-check .tl-icon { color: #198754; border-color: #198754; }
    .tl-step.step-recv .tl-icon { color: #0d6efd; border-color: #0d6efd; }

    .fab-qr { position: fixed; bottom: 80px; right: 20px; background: #333; color: white; border-radius: 30px; padding: 10px 20px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; font-weight: bold; border: 3px solid white; cursor: pointer; }
    #qr-overlay { position: fixed; inset: 0; background: black; z-index: 3000; display: none; flex-direction: column; }
    #reader { width: 100%; flex-grow: 1; background: black; }
    .scan-ctrl { padding: 20px; background: rgba(0,0,0,0.8); text-align: center; }
    
    .nav-tabs .nav-link { color: #666; font-size: 0.9rem; }
    .nav-tabs .nav-link.active { color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }
    .tab-badge { background: #eee; color: #333; border-radius: 12px; padding: 3px 8px; font-size: 11px; margin-left: 5px; font-weight: bold; }
    .nav-link.active .tab-badge { background: var(--primary); color: white; }
    
    .card-wait { background-color: #fffde7; border-left: 4px solid #fbc02d; }
    .card-done { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
    .card-recv { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
    
    .text-message-start { font-size: 24pt; font-weight: bold; text-align: center; color: #555; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; }
    #group-filter .badge { padding: 5px 10px !important; }
    #group-filter .badge .badge { width: 24px; height: 24px; border-radius: 50% !important; padding: 0; display: flex; align-items: center; justify-content: center; }

    .list-group-suggestion {
        position: absolute; top: 100%; left: 0; right: 0; z-index: 1050;
        max-height: 250px; overflow-y: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-top: 5px;
        background: white; border-radius: 12px; border: 1px solid #ddd;
    }
    
    .cursor-pointer { cursor: pointer; }
    .hover-bg-light:hover { background-color: #f8f9fa; }

    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; }
    .badge-expired { background: red; color: white; border-radius: 4px; padding: 2px 4px; font-weight: bold; animation: blink 1s linear infinite; }
    .badge-near-exp { background: #ffc107; color: black; border-radius: 4px; padding: 2px 4px; font-weight: bold; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>
<body>

  <div id="login-overlay" style="position:fixed;inset:0;background:#f4f6f9;z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column;">
     <div style="font-size:3.5rem;color:var(--primary);margin-bottom:15px">üíä</div>
     <h3 class="fw-bold m-0" style="font-size:1.8rem">Sawee Rxfill 2.0</h3>
     <div class="animate-pulse text-primary fw-bold mt-2" style="font-size:0.8rem; letter-spacing: 1px;">CONNECTING...</div>
     <div class="spinner-border text-primary mt-4" style="width: 2rem; height: 2rem;"></div>
     <div id="status-text" class="text-danger mt-3 text-center px-4 small"></div>
  </div>

  <div id="qr-overlay">
     <div class="d-flex justify-content-between p-3 text-white align-items-center">
        <h5 class="m-0"><i class="fas fa-qrcode"></i> Scan Drug</h5>
        <button class="btn btn-sm btn-outline-light rounded-circle" onclick="stopScan()"><i class="fas fa-times"></i></button>
     </div>
     <div id="reader"></div>
     <div class="scan-ctrl">
        <div class="text-white small mb-2">‡∏™‡πà‡∏≠‡∏á QR Code ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</div>
     </div>
  </div>

  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand">Sawee Rxfill 2.0</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini" onclick="openProfile()"><img id="nav-img" src="" referrerpolicy="no-referrer"><span id="nav-name">User</span></div>
         <div style="position:relative;padding:5px;" onclick="openStickerModal()">
            <i class="fas fa-print" style="font-size:1.3rem;"></i>
            <div id="badge-sticker" class="badge bg-warning text-dark rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
         <div style="position:relative;padding:5px;" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.3rem;"></i>
            <div id="badge" class="badge bg-danger rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:60px">
      <!-- TAB ORDER -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:50px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ..." onkeyup="filterOrder()">
        </div>
        <div style="position:relative;min-height:50vh">
            <div id="order-start-msg" class="text-message-start">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
            <div id="order-grid" class="drug-grid hidden"></div>
        </div>
      </div>

      <!-- TAB STOCK -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="group-filter" class="d-flex gap-2 px-3 pb-2 overflow-auto" style="white-space:nowrap"></div>
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5 px-3 d-flex flex-wrap gap-2 justify-content-start">
           <div class="text-message-start">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
        </div>
        
        <div class="fab-qr" onclick="startScan()"><i class="fas fa-qrcode"></i> ‡πÅ‡∏™‡∏Å‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</div>
        <div id="fab-print" class="fab-print hidden" onclick="openPrintLabel()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
        <div id="fab-edit" class="fab-edit-lg hidden" onclick="openBoxEditor()"><i class="fas fa-edit"></i> ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
      </div>

      <!-- TAB SEARCH -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <div class="d-flex align-items-center mb-3 flex-wrap gap-2">
             <h5 class="fw-bold text-primary m-0 me-auto">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤</h5>
             <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="doFullSearch('SHOW_ALL')">‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≤‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß</button>
             <button class="btn btn-sm btn-outline-danger rounded-pill fw-bold" onclick="showExpiredDrugs()">
                 <i class="fas fa-calendar-times"></i> ‡∏î‡∏π‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
             </button>
         </div>
         <div class="position-relative mb-3 d-flex gap-2">
             <div class="flex-grow-1 position-relative">
                 <div class="input-group shadow-sm rounded-pill">
                    <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                    <input id="kw-realtime" class="form-control border-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." autocomplete="off">
                 </div>
                 <div id="search-suggestions" class="list-group-suggestion hidden"></div>
             </div>
             <button class="btn btn-primary rounded-pill px-3" onclick="doFullSearch(document.getElementById('kw-realtime').value)">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
         </div>

         <div class="d-flex justify-content-between align-items-center mb-2">
             <div id="search-count" class="small text-muted fw-bold"></div>
         </div>

         <div id="search-spinner" class="text-center my-3 hidden"><div class="spinner-border text-primary"></div></div>
         
         <div id="realtime-detail" class="mt-2"></div>
         <div class="d-flex justify-content-center mt-3 gap-2 hidden" id="pagination-controls">
            <button class="btn btn-sm btn-light border" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
            <span id="page-display" class="small pt-1"></span>
            <button class="btn btn-sm btn-light border" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
         </div>

         <div class="fab-edit-lg" onclick="openMasterEdit({isNew:true})"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
      </div>

      <!-- TAB HIST -->
      <div id="tab-hist" class="page-sec hidden container pt-2">
         <div id="box-scroller-hist" class="box-scroller mb-2"></div>

         <ul class="nav nav-tabs nav-fill mb-3">
            <li class="nav-item"><a class="nav-link active" onclick="filterHist('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤',this)">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ <span id="bg-wait" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',this)">‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à <span id="bg-done" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß',this)">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß <span id="bg-recv" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('STATS',this)">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</a></li>
         </ul>
         
         <div id="stats-filter" class="card p-3 mb-3 border-0 bg-light hidden">
             <div class="d-flex gap-2 align-items-center mb-2">
                 <input type="date" id="stat-start" class="form-control">
                 <span>‡∏ñ‡∏∂‡∏á</span>
                 <input type="date" id="stat-end" class="form-control">
             </div>
             <button class="btn btn-primary w-100 rounded-pill" onclick="loadStats()">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
         </div>

         <div id="hist-msg" class="alert alert-info text-center small py-2 mb-2"></div>
         <div id="hist-loader" class="text-center my-4 hidden"><div class="spinner-border text-primary"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
    <div class="nav-item" style="position:relative" onclick="nav('tab-hist', this)">
        <i class="fas fa-history"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å
        <div id="nav-badge-hist" class="nav-badge-large hidden"></div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000">
    <div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body d-flex flex-column p-0 bg-light">
        <div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div>
        <div class="p-3 bg-white shadow-lg mt-auto">
            <div class="d-flex justify-content-between fw-bold mb-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-primary" id="cart-sum">0.00</span></div>
            <div class="border rounded p-2 mb-1 bg-white">
                <small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</small>
                
                <div class="d-flex align-items-center gap-2 mt-1 mb-2">
                    <input id="hosxp-user" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ HosXP Username" onkeyup="checkHosUser()">
                    <div id="hos-status" class="small fw-bold text-nowrap" style="min-width:100px;text-align:right;"></div>
                </div>
                <div id="hos-add-row" class="input-group mb-2 hidden fade-in">
                   <input id="hos-new-name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á">
                   <button class="btn btn-outline-primary" onclick="registerHosUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                
                <canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas>
                <div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvs()">‡∏•‡πâ‡∏≤‡∏á</small></div>
            </div>
            
            <div class="text-center text-primary fw-bold mb-3 small" id="cart-user-name"></div>
            <button id="btn-submit-order" onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlScanRes" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white p-2"><h6 class="m-0 ms-2"><i class="fas fa-qrcode"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏Å‡∏ô</h6><button class="btn-close btn-close-white" onclick="restartScan()"></button></div>
            <div class="modal-body pt-2">
                <input type="hidden" id="qr-id">
                <div class="text-center mb-1"><img id="qr-img" src="" style="height:60px;border-radius:6px;object-fit:cover;"></div>
                <h6 id="qr-name" class="fw-bold text-center m-0 text-primary"></h6>
                <div class="small text-muted text-center mb-2"><i class="fas fa-box"></i> <span id="qr-box"></span> | <i class="fas fa-map-marker-alt"></i> <input id="qr-loc" class="d-inline border-0 text-center" style="width:60px;font-size:0.8rem" placeholder="Loc"></div>
                
                <div class="row g-2 mb-2">
                    <div class="col-4"><label class="small" style="font-size:0.7rem">Max</label><input type="number" id="qr-amt" class="form-control form-control-sm text-center"></div>
                    <div class="col-4"><label class="small" style="font-size:0.7rem">Actual</label><input type="number" id="qr-act" class="form-control form-control-sm text-center border-success bg-success-subtle fw-bold"></div>
                    <div class="col-4"><label class="small" style="font-size:0.7rem">Exp</label><input type="date" id="qr-exp" class="form-control form-control-sm p-1" style="font-size:0.7rem"></div>
                </div>
                <button class="btn btn-success w-100 btn-sm mb-2" onclick="saveQrEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <div class="d-flex align-items-center justify-content-between gap-2 border-top pt-2">
                   <span class="small fw-bold">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:</span>
                   <div class="input-group input-group-sm" style="width:100px">
                      <button class="btn btn-outline-secondary" onclick="adjQrQty(-1)">-</button>
                      <input id="qr-print-qty" class="form-control text-center" value="1" readonly>
                      <button class="btn btn-outline-secondary" onclick="adjQrQty(1)">+</button>
                   </div>
                   <button class="btn btn-warning btn-sm flex-grow-1 fw-bold" onclick="addQrToPool()"><i class="fas fa-plus"></i> ‡∏Ñ‡∏¥‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5></div>
            <div class="modal-body p-4">
                <div class="text-center mb-3"><img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)"></div>
                <form id="form-reg">
                    <input id="reg-username" class="form-control mb-2" placeholder="Username *" required>
                    <input id="reg-name" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *" required>
                    <input id="reg-email" class="form-control mb-2" placeholder="Email">
                    <label class="small text-muted mt-2">Box Group (‡∏ï‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î)</label>
                    <select id="reg-group" class="form-select mb-2" multiple></select>
                    <div class="mb-3"><label class="small fw-bold text-muted">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label><div class="p-2 border rounded bg-white" style="max-height:150px;overflow-y:auto" id="reg-substock-list">Loading...</div></div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlProfile"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div class="mb-2"><label class="small">Username</label><input id="pf-user" class="form-control"></div>
    <div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input id="pf-name" class="form-control"></div>
    <div class="mb-2"><label class="small">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Substock)</label><textarea id="pf-sub" class="form-control" rows="2"></textarea></div>
    <div class="mb-2"><label class="small">Password</label><input id="pf-pass" class="form-control"></div>
    <div class="mb-2"><label class="small">Email</label><input id="pf-email" class="form-control"></div>
    <button onclick="saveProfile()" class="btn btn-primary w-100 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div></div></div></div>

  <div class="modal fade" id="mdlBoxEdit" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-light">
                <div class="card p-3 mb-3 border-0 shadow-sm">
                    <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á</label><input id="edit-box-name" class="form-control fw-bold mb-2">
                    <label class="small text-muted">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
                    <div class="d-flex gap-2">
                        <input type="file" id="inp-box-file" class="form-control" 
                               accept="image/*" 
                               onchange="uploadBoxImg(this)">
                        <input id="edit-box-img" type="hidden">
                        <img id="preview-box-img" src="" referrerpolicy="no-referrer" style="width:40px;height:40px;border-radius:4px;object-fit:cover;border:1px solid #ddd">
                    </div>
                    <button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveBoxInfo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πà‡∏≠‡∏á</button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</h6><button class="btn btn-sm btn-success rounded-pill" onclick="mdlAddItem.show()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button></div>
                <div id="edit-box-items" class="row g-2"></div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlMasterEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h6 class="fw-bold m-0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (Master)</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="mst-isnew"><div class="mb-2"><label class="small">Item ID</label><input id="mst-id" class="form-control fw-bold"></div><div class="mb-2 text-center"><img id="mst-img-preview" src="" referrerpolicy="no-referrer" style="height:100px;border-radius:8px;background:transparent"><input type="file" class="form-control mt-2" accept="image/*" onchange="uploadMasterImg(this)"><input type="hidden" id="mst-img-path"></div><div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input id="mst-name" class="form-control"></div><div class="row g-2 mb-2"><div class="col-6"><label class="small">Unit</label><input id="mst-unit" class="form-control"></div><div class="col-6"><label class="small">Price</label><input id="mst-price" type="number" class="form-control"></div></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-ha"><label class="form-check-label text-danger fw-bold">High Alert</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-pl"><label class="form-check-label text-warning fw-bold">Protect Light</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-kc"><label class="form-check-label text-info fw-bold">Keep Cool (2-8¬∞C)</label></div><div class="d-flex gap-2 mt-3"><button class="btn btn-primary w-100" onclick="saveMasterItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button class="btn btn-outline-dark w-100" onclick="openLabelEdit()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏â‡∏•‡∏≤‡∏Å</button></div></div></div></div></div>
  <div class="modal fade" id="mdlLabelEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-info text-white"><h6 class="fw-bold m-0">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏ö‡∏ô‡∏â‡∏•‡∏≤‡∏Å)</label><input id="lbl-name" class="form-control"></div><div class="row g-2 mb-2"><div class="col-6"><label class="small">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label><input id="lbl-amt" class="form-control"></div><div class="col-6"><label class="small">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input id="lbl-unit" class="form-control"></div></div><div class="mb-2"><label class="small">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1</label><input id="lbl-l1" class="form-control"></div><div class="mb-2"><label class="small">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2</label><input id="lbl-l2" class="form-control"></div><div class="mb-2"><label class="small">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3</label><input id="lbl-l3" class="form-control"></div><div class="mb-2"><label class="small">‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ</label><input id="lbl-ind" class="form-control"></div><button class="btn btn-info w-100 mt-2 text-white" onclick="saveLabelInfo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏•‡∏≤‡∏Å</button></div></div></div></div>
  <div class="modal fade" id="mdlAddItem" style="z-index:2100"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="search-master" class="form-control mb-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." onkeyup="searchMasterDebounce()"><div id="master-res" class="list-group" style="max-height:250px;overflow-y:auto"></div></div></div></div></div>
  <div class="modal fade" id="mdlCheckOrder" style="z-index:2200"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><small class="text-muted d-block">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏¢‡∏≤ (‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£):</small><div id="check-user-name" class="fw-bold text-primary mb-2"></div><canvas id="cvs-check" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvsCheck()">‡∏•‡πâ‡∏≤‡∏á</small></div><button onclick="confirmCheckOrder()" class="btn btn-success w-100 mt-2 rounded-pill fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏±‡∏î‡∏¢‡∏≤</button></div></div></div></div>
  <div class="modal fade" id="mdlSticker"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">Sticker Pool</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-pills nav-fill mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#pool-cart">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pool-hist" onclick="loadPoolHist()">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (5 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</a></li></ul><div class="tab-content"><div id="pool-cart" class="tab-pane active"><div id="sticker-list" class="list-group mb-3"></div><button onclick="generateStickerPdf()" class="btn btn-warning w-100 text-dark fw-bold"><i class="fas fa-print"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF</button></div><div id="pool-hist" class="tab-pane"><div id="pool-list" class="list-group"></div></div></div></div></div></div></div>
  <div class="modal fade" id="mdlSignLabel" style="z-index:2200"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£:</small><canvas id="cvs-label" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-center my-2 text-primary" id="lbl-signer"></div><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvsLabel()">‡∏•‡πâ‡∏≤‡∏á</small></div><button onclick="submitLabel()" class="btn btn-success w-100 mt-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</button><button id="btn-prev-label" class="btn btn-outline-secondary w-100 mt-2" style="display:none"></button></div></div></div></div>

  <div class="modal fade" id="mdlEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 shadow"><div class="modal-body text-center p-4"><input type="hidden" id="ed-id"><input type="hidden" id="ed-itemid"><h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6><div class="row g-2 mb-3"><div class="col-6"><label class="small text-muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div><div class="col-6"><label class="small text-muted">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="date" id="ed-exp" class="form-control text-center" onchange="calcExpDays()"></div></div><div class="mt-2 text-center" id="ed-days-left"></div><div class="mt-2 small text-muted text-center">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <span id="ed-change" class="fw-bold">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="ed-time">-</span>)</div><button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><div class="border-top mt-3 pt-3"><label class="small mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</label><div class="d-flex gap-2"><div class="qty-wrap mx-auto" style="width:140px"><div class="btn-qty" onclick="adjStk(-1)">-</div><input id="stk-qty" type="number" class="inp-qty" value="1" readonly><div class="btn-qty" onclick="adjStk(1)">+</div></div><button class="btn btn-warning" onclick="addToStickerCartFromEdit()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</button></div></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- IMPORTANT: REPLACE WITH YOUR DEPLOYED WEB APP URL ---
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
  let liffId = "2008862022-cDOpEP9z";
  let currentUser = {}, items=[], cart=[], stickerCart=[], curBoxOrder='', curBoxStock='';
  let allBoxes = [], allHistory = [];
  let offC, mdlEdit, mdlReg, mdlBoxEdit, mdlAddItem, mdlMasterEdit, mdlProfile, mdlSignLabel, mdlSticker, mdlLabelEdit, mdlCheckOrder, mdlScanRes;
  let searchTimeout, hosAuthTimeout;
  let curPage = 1, totalPages = 1, totalSearchItems = 0;
  let curHistBox = 'ALL', curHistStatus = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤';
  let tempCheckOrderId = '';
  let html5QrcodeScanner;
  let editTarget = null;
  let hosAuthValid = false;
  let hosAuthName = '';

  // --- UTILS & HELPERS ---
  async function callApi(action, payload = {}) {
      try {
        const res = await fetch(GAS_URL, { method: 'POST', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, ...payload }) });
        const text = await res.text();
        try { return JSON.parse(text); } catch(e) { if(text.includes("Service is")) throw new Error("DEPLOYMENT_ERR"); throw new Error(text.substr(0,50)); }
      } catch(e) {
        if(e.message=="DEPLOYMENT_ERR") Swal.fire('Error','Deploy ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Execute as Me / Anyone','error');
        return { status: 'error', message: e.message };
      }
  }

  function lazyLoad() { 
      document.querySelectorAll('img.lazy').forEach(img => { 
          if(img.dataset.loaded) return; 
          const raw = img.dataset.raw; 
          if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; } 
          if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; } 
          callApi('resolveImage', { input: raw }).then(res => { if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; } }); 
      }); 
  }

  // Convert dd/MM/yyyy to yyyy-MM-dd
  function thDateToIso(thDate) {
      if(!thDate) return '';
      // If it's already ISO format or Date object, return formatted
      if(thDate instanceof Date) return thDate.toISOString().split('T')[0];
      if(String(thDate).match(/^\d{4}-\d{2}-\d{2}$/)) return thDate;

      const parts = String(thDate).split('/');
      if(parts.length === 3) {
          // Add padding for day/month
          const d = parts[0].padStart(2, '0');
          const m = parts[1].padStart(2, '0');
          const y = parts[2];
          return `${y}-${m}-${d}`;
      }
      return thDate;
  }

  function getDuration(t1, t2) {
      if(!t1 || !t2) return '';
      const diff = t2 - t1;
      if(diff <= 0) return '';
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      let str = ""; if(days > 0) str += `${days}‡∏ß‡∏±‡∏ô `; if(hrs > 0) str += `${hrs}‡∏ä‡∏°. `; str += `${mins}‡∏ô‡∏≤‡∏ó‡∏µ`; return str;
  }

  async function authAdmin(callback) {
      const { value: username } = await Swal.fire({
          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (HosXP)',
          input: 'text',
          inputPlaceholder: 'Username',
          showCancelButton: true
      });
      
      if (username) {
          Swal.showLoading();
          const res = await callApi('checkAdmin', { username });
          Swal.close();
          
          if(res.status) {
              callback(res.name);
          } else {
              const { value: newName } = await Swal.fire({
                  title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                  text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                  input: 'text',
                  showCancelButton: true
              });
              if(newName) {
                  await callApi('registerAdmin', { username, name: newName });
                  callback(newName);
              }
          }
      }
  }

  // --- CORE APP LOGIC ---
  async function checkUser(uid, boxParam) {
      const res = await callApi('checkUserLIFF', { userId: uid });
      if (res.status === 'NOT_FOUND') { 
          currentUser.userId = uid; 
          const opts = await callApi('getRegOptions');
          if(opts.status) {
             const list = document.getElementById('reg-substock-list');
             list.innerHTML = opts.options.map(o => `<div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="${o}"><label>${o}</label></div>`).join('');
             const grpSel = document.getElementById('reg-group');
             grpSel.innerHTML = opts.groups.map(g=>`<option value="${g}">${g}</option>`).join('');
          }
          document.getElementById('login-overlay').classList.add('hidden'); 
          document.getElementById('reg-img').src = currentUser.photo || DEFAULT_IMG; 
          mdlReg.show(); 
      }
      else if (res.status === 'FOUND') { currentUser = { ...res.userData, userId: uid }; startApp(boxParam); }
  }

  function openProfile() {
      document.getElementById('pf-user').value = currentUser.username;
      document.getElementById('pf-name').value = currentUser.name;
      document.getElementById('pf-sub').value = currentUser.substock;
      document.getElementById('pf-pass').value = currentUser.password;
      document.getElementById('pf-email').value = currentUser.email;
      mdlProfile.show();
  }
  async function saveProfile() {
      const pl = { userId: currentUser.userId, username: document.getElementById('pf-user').value, name: document.getElementById('pf-name').value, substock: document.getElementById('pf-sub').value, password: document.getElementById('pf-pass').value, email: document.getElementById('pf-email').value };
      const res = await callApi('updateUserProfile', pl);
      if(res.status) location.reload(); else Swal.fire(res.message);
  }

  async function startApp(boxParam) {
      document.getElementById('login-overlay').classList.add('hidden'); document.getElementById('app-main').classList.remove('hidden');
      document.getElementById('nav-img').src = currentUser.photo || DEFAULT_IMG; document.getElementById('nav-name').innerText = currentUser.name.split(' ')[0];
      
      const resOrder = await callApi('getBoxes', { user: currentUser, showAll: false });
      if(resOrder.status) renderBoxScroller('order', resOrder.boxes);
      const resStock = await callApi('getBoxes', { user: currentUser, showAll: true });
      if(resStock.status) { 
          allBoxes = resStock.boxes; 
          renderBoxScroller('stock', allBoxes); 
          renderStockGroups(); 
      }
      
      loadHist(true); 

      if(boxParam) {
          if(allBoxes.length) {
              const box = allBoxes.find(b=>b.id===boxParam);
              if(box) { nav('tab-stock', document.querySelectorAll('.nav-item')[1]); selBox(box.name, null, 'stock', box.imageRaw); }
          }
      }
  }

  async function renderStockGroups() {
      const resGroups = await callApi('getBoxGroups');
      if(resGroups.status) {
          const counts = {};
          allBoxes.forEach(b => {
             const g = b.group || 'Other';
             counts[g] = (counts[g] || 0) + 1;
          });

          document.getElementById('group-filter').innerHTML = 
            `<div class="badge rounded-pill bg-primary cursor-pointer d-flex align-items-center gap-2" onclick="filterStockBox('ALL',this)">
                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="badge bg-white text-dark rounded-circle">${allBoxes.length}</span>
             </div>` + 
            resGroups.groups.map(g => {
                const count = counts[g] || 0;
                return `<div class="badge rounded-pill bg-white text-dark border cursor-pointer d-flex align-items-center gap-2" onclick="filterStockBox('${g}',this)">
                          ${g} <span class="badge bg-secondary rounded-circle">${count}</span>
                        </div>`;
            }).join('');
      }
  }

  function getBoxIcon(type) {
      const t = (type || "").toLowerCase();
      if(t.includes('cart') || t.includes('‡∏£‡∏ñ')) return 'üõí';
      if(t.includes('fridge') || t.includes('‡πÄ‡∏¢‡πá‡∏ô')) return 'üßä';
      if(t.includes('carbinet') || t.includes('cabinet') || t.includes('‡∏ï‡∏π‡πâ')) return 'üóÑÔ∏è';
      return 'üì¶';
  }

  function renderBoxScroller(mode, boxes) {
      const el = document.getElementById(`box-scroller-${mode}`);
      el.innerHTML = boxes.map(b=>`
        <div class="box-btn" onclick="selBox('${b.name}', this, '${mode}', '${b.imageRaw}')">
          <span class="box-icon">${getBoxIcon(b.type)}</span>
          <span class="box-name">${b.name}</span>
          ${b.hasExpired ? '<span class="badge-exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>' : ''}
          ${mode === 'hist' ? `<span class="badge-hist-count">${b.count||0}</span>` : ''}
        </div>`).join('');
  }

  function filterStockBox(group, el) {
      const p = el.parentElement; 
      Array.from(p.children).forEach(x=> { 
          x.classList.remove('bg-primary','text-white'); 
          x.classList.add('bg-white','text-dark'); 
          const badge = x.querySelector('.badge');
          if(badge) { badge.classList.remove('bg-white', 'text-dark'); badge.classList.add('bg-secondary'); }
      });
      el.classList.remove('bg-white','text-dark'); 
      el.classList.add('bg-primary','text-white');
      const activeBadge = el.querySelector('.badge');
      if(activeBadge) { activeBadge.classList.remove('bg-secondary'); activeBadge.classList.add('bg-white', 'text-dark'); }

      const filtered = (group==='ALL') ? allBoxes : allBoxes.filter(b=>b.group===group);
      renderBoxScroller('stock', filtered);
  }

  function nav(pid, el){
      document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden')); document.getElementById(pid).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active');
      if(pid === 'tab-hist') {
          loadHist();
      }
  }

  async function selBox(name, el, mode, imgRaw) {
      document.querySelectorAll(`#box-scroller-${mode} .box-btn`).forEach(x=>x.classList.remove('active')); 
      if(el) el.classList.add('active');
      
      if(mode==='order') {
         if(cart.length && curBoxOrder!=name && !confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;
         if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
         curBoxOrder = name; loadOrderItems(name);
      } else if (mode === 'hist') {
         curHistBox = name;
         renderHist(curHistStatus); 
      } else {
         curBoxStock = name;
         document.getElementById('fab-edit').classList.remove('hidden');
         document.getElementById('fab-print').classList.remove('hidden');
         document.getElementById('edit-box-name').value = name;
         document.getElementById('edit-box-img').value = imgRaw;
         document.getElementById('preview-box-img').src = DEFAULT_IMG;
         if(imgRaw) callApi('resolveImage',{input:imgRaw}).then(r=>{if(r.status) document.getElementById('preview-box-img').src=r.src});
         
         const boxObj = allBoxes.find(b=>b.name === name);
         const prevBtn = document.getElementById('btn-prev-label');
         if(boxObj && boxObj.lastPdf) {
            prevBtn.style.display = 'block';
            prevBtn.onclick = () => window.open(boxObj.lastPdf, '_blank');
            prevBtn.innerHTML = `‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${boxObj.lastCheck || '-'})`;
         } else { prevBtn.style.display = 'none'; }

         loadStockItems(name);
      }
  }

  async function loadOrderItems(box) {
      document.getElementById('order-start-msg').classList.add('hidden');
      document.getElementById('order-grid').classList.remove('hidden');
      document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-2"></div>').join('');
      const res = await callApi('getItems', { boxName: box });
      items = res.status ? res.data.map(x=>({...x, req:1})) : [];
      renderOrder();
  }
  
  async function loadStockItems(box) {
      const el = document.getElementById('stock-content'); el.innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
      const res = await callApi('getItems', { boxName: box });
      if(!res.status) return el.innerHTML = 'Error';
      
      // FIX: Check if res.data exists before iterating
      if(!res.data || !Array.isArray(res.data)) {
          el.innerHTML = '<div class="text-center mt-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>';
          return;
      }
      
      let totalChanges = 0;
      let lastCheck = '-';
      const boxObj = allBoxes.find(b=>b.name === box);
      if(boxObj) { lastCheck = boxObj.lastCheck; }
      res.data.forEach(i => totalChanges += (i.changeCount || 0));

      let h = `<div class="h5 fw-bold text-dark mb-1 w-100 d-flex align-items-center gap-2"><i class="fas fa-box"></i> ${box} <span class="badge bg-info rounded-pill" style="font-size:0.7rem">${res.data.length} ‡∏¢‡∏≤</span></div>
               <div class="small text-muted mb-3 border-bottom pb-2 w-100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${totalChanges} | ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastCheck}</div>`;
      
      let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
      Object.keys(rows).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true})).forEach(r=>{
          h+=`<div class="shelf-row-label">‡∏ä‡∏±‡πâ‡∏ô/‡πÅ‡∏ñ‡∏ß: ${r}</div><div class="d-flex flex-wrap gap-2 mt-2 w-100">`;
          h+=rows[r].map(i=> {
           let cls = i.highAlert ? 'bg-ha' : (i.keepCool ? 'bg-cool' : '');
           let icon = i.protectLight ? '<i class="fas fa-sun icon-protect"></i>' : '';
           let expTag = '';
           let expiredClass = '';
           if(i.expire) {
              const diff = (new Date(i.expire) - new Date())/(1000*3600*24);
              if(diff < 0) { 
                  expTag = '<span class="exp-badge-stock badge-expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>';
                  expiredClass = 'border border-danger';
              }
              else if(diff < 180) {
                  expTag = `<span class="exp-badge-stock badge-near-exp">${Math.ceil(diff)} ‡∏ß‡∏±‡∏ô</span>`;
              }
           }
           let haBadge = i.highAlert ? '<div class="badge-ha">HAD</div>' : '';
           
           return `<div id="stk-${i.invId}" class="shelf-item ${cls} ${expiredClass}" style="width:31%;max-width:130px;" onclick="editStk('${i.invId}','${i.name}','${i.itemId}',${i.amount},'${i.expire}',${i.changeCount},'${i.lastChange}')">${haBadge}${expTag}<img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer"><div class="small text-truncate fw-bold" style="font-size:0.75rem">${i.name}</div><div class="d-flex justify-content-between align-items-center mt-1"><span class="badge bg-secondary qty-val">${i.amount}</span><span class="text-muted exp-val" style="font-size:9px">${i.expire || '-'} ${icon}</span></div></div>`
          }).join('');
          h+='</div>';
      });
      el.innerHTML = h || '<div class="text-center mt-5 text-muted">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>';
      
      const editHtml = res.data.map(i=>`<div class="col-12 d-flex align-items-center bg-white border p-2 rounded mb-1"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer" style="width:40px;height:40px;object-fit:cover;border-radius:4px;background:transparent"><div class="flex-grow-1 ms-2 small"><div class="fw-bold text-truncate">${i.name}</div><div class="d-flex gap-2 align-items-center mt-1"><input class="form-control form-control-sm" style="width:70px" type="number" value="${i.amount}" onchange="updateInv('${i.invId}', 'amount', this.value)" placeholder="Qty"><input class="form-control form-control-sm" style="width:120px" value="${i.location}" onchange="updateInv('${i.invId}', 'location', this.value)" placeholder="Loc"></div></div><button class="btn btn-sm btn-outline-danger ms-2" onclick="removeBoxItem('${i.invId}')"><i class="fas fa-trash"></i></button></div>`).join('');
      document.getElementById('edit-box-items').innerHTML = editHtml;
      lazyLoad();
  }

  async function updateInv(id, field, val) { let pl = {invId:id}; pl[field]=val; await callApi('updateInventoryDetail', pl); }

  function renderOrder() {
      const grid = document.getElementById('order-grid');
      grid.innerHTML = '';
      const kw = document.getElementById('order-search').value.toLowerCase();
      const filtered = items.filter(i=>i.name.toLowerCase().includes(kw));
      
      if(filtered.length === 0) {
          grid.innerHTML = '<div class="text-center mt-5 text-muted w-100">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤</div>';
          return;
      }

      let idx = 0;
      const chunk = 20;
      function nextChunk() {
          const slice = filtered.slice(idx, idx + chunk);
          if (slice.length === 0) return;
          
          const html = slice.map(i=>`
            <div class="drug-card">
                <div class="drug-img-wrap">
                    <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy" referrerpolicy="no-referrer">
                </div>
                <div class="drug-info">
                    <div class="drug-name">${i.name}</div>
                    <div class="d-flex justify-content-between small text-muted mb-2"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å : ${i.req}</span><span class="text-primary fw-bold">${i.price} ‡∏ö.</span></div>
                    <div class="qty-wrap"><div class="btn-qty" onclick="adj('${i.itemId}',-1)">-</div><input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly><div class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</div></div>
                    <button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                </div>
            </div>`).join('');
          
          grid.insertAdjacentHTML('beforeend', html);
          idx += chunk;
          lazyLoad();
          
          if(idx < filtered.length) {
              requestAnimationFrame(nextChunk);
          }
      }
      nextChunk();
  }

  // --- ACTIONS ---
  function openBoxEditor() { mdlBoxEdit.show(); }
  function addCart(id) { 
      let i = items.find(x=>x.itemId==id); 
      let ex = cart.find(x=>x.itemId==id); 
      if(ex) { 
          if(ex.qty+i.req > i.amount) return Swal.fire({toast:true,position:'center',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); 
          ex.qty+=i.req; 
      } else {
          cart.push({...i, qty:i.req}); 
      }
      badge(); 
      const b=document.querySelector('.fa-shopping-basket'); 
      if(b) { b.style.transform='scale(1.4)'; setTimeout(()=>b.style.transform='scale(1)',200); }
      i.req=1; 
      const inp = document.getElementById(`qty-${id}`);
      if(inp) inp.value=1; 
  }
  
  function badge() { 
      let n=cart.length; 
      const b = document.getElementById('badge');
      if(b) {
          b.innerText=n; 
          n>0 ? b.classList.remove('hidden') : b.classList.add('hidden'); 
      }
  }

  function adj(id, v, max) { 
      let i = items.find(x=>x.itemId==id); 
      if(!i) return; 
      let n = i.req + v; 
      if(n<1)n=1; 
      if(max && n>max) { n=max; Swal.fire({toast:true,position:'center',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); } 
      i.req = n; 
      const el = document.getElementById(`qty-${id}`);
      if(el) el.value = n; 
  }

  function openStickerModal() {
      const list = document.getElementById('sticker-list');
      if(stickerCart.length === 0) list.innerHTML = '<div class="text-center p-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</div>';
      else {
        list.innerHTML = stickerCart.map((s,i) => `
          <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>${s.name} <span class="badge bg-secondary">x${s.qty}</span></div>
              <i class="fas fa-trash text-danger cursor-pointer" onclick="stickerCart.splice(${i},1); updateStickerBadge(); openStickerModal()"></i>
          </div>
        `).join('');
      }
      mdlSticker.show();
  }
  
  function adjStk(n) {
      let el = document.getElementById('stk-qty');
      let v = parseInt(el.value) || 1;
      v += n;
      if(v < 1) v = 1;
      el.value = v;
  }

  function adjQrQty(n) {
      let el = document.getElementById('qr-print-qty');
      let v = parseInt(el.value) || 1;
      v += n;
      if(v < 1) v = 1;
      el.value = v;
  }

  function addToStickerCartFromEdit() {
      const id = document.getElementById('ed-itemid').value;
      const name = document.getElementById('ed-name').innerText;
      const exp = document.getElementById('ed-exp').value; 
      const qty = document.getElementById('stk-qty').value;
      if(!qty || qty <= 0) return Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
      
      stickerCart.push({ itemId: id, name: name, qty: qty, expire: exp });
      updateStickerBadge();
      Swal.fire({icon:'success', title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß', timer:1000, showConfirmButton:false});
  }

  function updateStickerBadge() {
      const b = document.getElementById('badge-sticker');
      const total = stickerCart.reduce((s,i) => s + Number(i.qty), 0);
      b.innerText = total;
      if(total > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
  }

  async function generateStickerPdf() {
      if(stickerCart.length === 0) return;
      Swal.fire({title:'Generating PDF...', didOpen:()=>Swal.showLoading()});
      let expandList = [];
      stickerCart.forEach(s => {
          for(let i=0; i<s.qty; i++) expandList.push({ itemId: s.itemId, name: s.name, expire: s.expire });
      });
      
      const res = await callApi('generateLabelPdf', { items: expandList, user: currentUser.name });
      if(res.status) {
          stickerCart = []; updateStickerBadge(); mdlSticker.hide();
          Swal.fire({ icon:'success', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary w-100">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏â‡∏•‡∏≤‡∏Å</a>` });
      } else Swal.fire('Error', res.message, 'error');
  }

  function loadHist(init = false) { 
      if(!init) document.getElementById('hist-loader').classList.remove('hidden');
      
      callApi('getHistory', {user:currentUser.name, substock:currentUser.substock}).then(res=>{ 
          document.getElementById('hist-loader').classList.add('hidden');
          // FIX: Check if res.data exists before assigning
          if(res.status && Array.isArray(res.data)) { 
              allHistory = res.data;
          } else {
              allHistory = []; // Fallback to empty array if data is null/undefined
          }
          
          if(allHistory.length > 0) {
              const boxCounts = allHistory.reduce((acc, r) => { 
                  if(r.box) acc[r.box] = (acc[r.box] || 0) + 1; 
                  return acc; 
              }, {});
              
              const histBoxes = [...new Set(allHistory.map(r => r.box))].sort();
              const scroller = document.getElementById('box-scroller-hist');
              
              const histScrollerHtml = `<div class="box-btn ${curHistBox === 'ALL' ? 'active' : ''}" onclick="selBox('ALL', this, 'hist', '')"><span class="box-icon">üìã</span><span style="font-size:0.7rem;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span class="badge-hist-count">${allHistory.length}</span></div>` + 
                histBoxes.map(bName => {
                    const count = boxCounts[bName] || 0;
                    return `<div class="box-btn ${curHistBox === bName ? 'active' : ''}" onclick="selBox('${bName}', this, 'hist', '')"><span class="box-icon">üì¶</span><span class="box-name">${bName}</span><span class="badge-hist-count">${count}</span></div>`;
                }).join('');
              scroller.innerHTML = histScrollerHtml;
          } else {
             document.getElementById('box-scroller-hist').innerHTML = '<div class="text-center w-100 py-2 small text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</div>';
          }

          if (curHistStatus === 'STATS') loadStats();
          else renderHist(curHistStatus); 
      }).catch(err => {
         console.error("Load Hist Error:", err);
         document.getElementById('hist-loader').classList.add('hidden');
         document.getElementById('hist-res').innerHTML = `<div class="alert alert-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</div>`;
      }); 
  }

  function filterHist(status, el) {
      curHistStatus = status;
      document.querySelectorAll('.nav-tabs .nav-link').forEach(x=>x.classList.remove('active')); el.classList.add('active');
      const scroller = document.getElementById('box-scroller-hist');
      const statsFilter = document.getElementById('stats-filter');
      
      if(status === 'STATS') {
          scroller.classList.add('hidden'); statsFilter.classList.remove('hidden');
          loadStats();
      } else {
          scroller.classList.remove('hidden'); statsFilter.classList.add('hidden');
          renderHist(status);
      }
  }

  function renderHist(status) {
      let filtered = allHistory;
      if(curHistBox !== 'ALL') { filtered = filtered.filter(r => r.box === curHistBox); }

      const totalWait = filtered.filter(r => r.status.includes('‡∏£‡∏≠')).length;
      const totalDone = filtered.filter(r => r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')).length;
      const totalRecv = filtered.filter(r => r.status.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö')).length;
      
      document.getElementById('bg-wait').innerText = totalWait; 
      document.getElementById('bg-done').innerText = totalDone; 
      document.getElementById('bg-recv').innerText = totalRecv;
      
      const globalDone = allHistory.filter(r => r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')).length;
      if(globalDone > 0) { 
          document.getElementById('nav-badge-hist').classList.remove('hidden'); 
          document.getElementById('nav-badge-hist').innerText = globalDone; 
      } else { 
          document.getElementById('nav-badge-hist').classList.add('hidden'); 
      }

      let msg = "";
      if(status === '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤') { filtered = filtered.filter(r => r.status.includes('‡∏£‡∏≠')); msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏£‡∏±‡∏ö order ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'"; }
      else if(status === '‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') { filtered = filtered.filter(r => r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')); msg = "‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"; }
      else if(status === '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß') { filtered = filtered.filter(r => r.status.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö')); }
      else if(status === 'STATS') return;

      document.getElementById('hist-msg').innerText = msg; document.getElementById('hist-msg').classList.toggle('hidden', msg === "");
      renderHistList(filtered, 10);
  }

  function renderHistList(data, limit) {
      const displayData = limit ? data.slice(0, limit) : data;
      const html = displayData.map(r=>{
        let action = ''; 
        if(r.status.includes('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤')) {
            action = `<button class="btn btn-warning w-100 fw-bold py-2 mt-2" style="font-size:1.1rem;color:#333" onclick="openCheckOrder('${r.id}')"><i class="fas fa-clipboard-check"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏±‡∏î‡∏¢‡∏≤</button>`;
        } else if(r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')) {
            action = `<button class="btn btn-success w-100 fw-bold py-2 mt-2" style="font-size:1.2rem;" onclick="receiveOrder('${r.id}')">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>`;
        }
        
        let pdfBtn = '';
        if(!r.status.includes('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤')) {
            pdfBtn = `<a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill"><i class="fas fa-file-pdf"></i> PDF</a>`;
        }

        let itemList = r.items.map(i=> `<li>${i.name} (${i.qty}) - ${i.price}</li>`).join('').slice(0, 200) + (r.items.length > 5 ? '...' : '');
        let cardClass = r.status.includes('‡∏£‡∏≠') ? 'card-wait' : (r.status.includes('‡∏£‡∏±‡∏ö') ? 'card-recv' : 'card-done');
        
        const diff1 = getDuration(r.rawOrderTime, r.rawCheckTime);
        const diff2 = getDuration(r.rawCheckTime, r.rawAcceptTime);
        
        let timelineHtml = '';
        if(r.status.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö')) {
            timelineHtml = `
              <div class="timeline px-2 py-2">
                 <div class="timeline-line"></div>
                 <div class="tl-step step-order active"><div class="tl-icon"><i class="fas fa-file-alt"></i></div><div class="tl-time">‡πÄ‡∏ö‡∏¥‡∏Å<br>${r.time.split(' ')[1]||''}</div></div>
                 <div class="tl-step step-check active"><div class="tl-duration">${diff1}</div><div class="tl-icon"><i class="fas fa-check"></i></div><div class="tl-time">‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à<br>${r.checkedTime||'-'}</div></div>
                 <div class="tl-step step-recv active"><div class="tl-duration">${diff2}</div><div class="tl-icon"><i class="fas fa-hand-holding"></i></div><div class="tl-time">‡∏£‡∏±‡∏ö‡∏¢‡∏≤<br>${r.acceptedTime||'-'}</div></div>
              </div>`;
        }
        
        return `<div class="card mb-2 p-2 shadow-sm ${cardClass}">
                  <div class="d-flex justify-content-between align-items-center"><strong class="text-primary small text-truncate w-75">${r.id}</strong><small class="text-muted" style="font-size:10px">${r.time}</small></div>
                  <div class="small text-muted my-1"><i class="fas fa-box"></i> ${r.box}</div>
                  ${timelineHtml}
                  <ul class="small text-muted ps-3 mb-1" style="max-height:100px;overflow-y:auto">${itemList}</ul>
                  <div class="d-flex flex-column align-items-stretch">
                     <div class="d-flex justify-content-between align-items-center"><small class="badge bg-light text-dark border">${r.status}</small>${pdfBtn}</div>
                     ${action}
                  </div>
                </div>`;
      }).join('');

      let moreBtn = '';
      if(limit && data.length > limit) {
          moreBtn = `<button class="btn btn-outline-secondary w-100 mt-2" onclick='renderHistList(${JSON.stringify(data).replace(/'/g, "&apos;")}, null)'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${data.length})</button>`;
      }
      document.getElementById('hist-res').innerHTML = html + moreBtn || '<div class="text-center text-muted mt-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
  }

  async function loadStats() {
      const start = document.getElementById('stat-start').value;
      const end = document.getElementById('stat-end').value;
      document.getElementById('hist-res').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</div></div>';
      document.getElementById('hist-msg').classList.add('hidden');
      const res = await callApi('getStatData', { user: currentUser.name, substock: currentUser.substock, start: start, end: end });
      if(res.status) { renderStats(res.data); } else { document.getElementById('hist-res').innerHTML = '<div class="alert alert-danger">Error loading stats</div>'; }
  }

  function renderStats(data) {
      if(!data || data.length === 0) { document.getElementById('hist-res').innerHTML = '<div class="text-center text-muted mt-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>'; return; }
      const html = data.map((item, idx) => `
        <div class="d-flex align-items-center bg-white p-2 mb-2 rounded shadow-sm border">
            <div class="me-3 fw-bold text-muted" style="width:20px">${idx+1}</div>
            <div class="flex-grow-1"><div class="fw-bold text-primary">${item.name}</div><div class="small text-secondary"><i class="fas fa-box"></i> ${item.box}</div><div class="small text-muted">‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ ${item.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div></div>
            <div class="text-end"><div class="fw-bold fs-5">${item.qty}</div><div class="small text-muted">${item.price.toFixed(0)} ‡∏ö.</div></div>
        </div>`).join('');
      document.getElementById('hist-res').innerHTML = html;
  }

  function openCheckOrder(oid) {
      tempCheckOrderId = oid;
      document.getElementById('check-user-name').innerText = currentUser.name;
      mdlCheckOrder.show(); setTimeout(fixCvsCheck, 500);
  }
  
  async function confirmCheckOrder() {
      if(isCanvasBlank(cvsCheck)) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏¢‡∏≤');
      mdlCheckOrder.hide();
      
      authAdmin(async (adminName) => {
          const sign = cvsCheck.toDataURL();
          const res = await callApi('confirmOrderCheck', { orderId: tempCheckOrderId, user: adminName, signature: sign });
          clrCvsCheck();
          if(res.status && res.pdf) window.open(res.pdf, '_blank');
          loadHist();
          Swal.fire({toast:true, icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'});
      });
  }

  async function receiveOrder(oid) {
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô?')) return;
      authAdmin(async (adminName) => {
          const res = await callApi('updateOrderStatus', { orderId: oid, user: adminName });
          if(res.status) { Swal.fire('Success'); loadHist(); }
      });
  }

  function openPrintLabel() { 
      document.getElementById('lbl-signer').innerText = currentUser.name;
      mdlSignLabel.show(); setTimeout(fixCvsLabel, 500); 
  }
  async function submitLabel() {
      if(isCanvasBlank(cvsLabel)) return Swal.fire('‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
      mdlSignLabel.hide(); 
      
      authAdmin(async (adminName) => {
          Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', didOpen:()=>Swal.showLoading()});
          const sign = cvsLabel.toDataURL();
          const res = await callApi('generateBoxLabel', { boxName: curBoxStock, signBase64: sign, user: adminName });
          if(res.status) {
            clrCvsLabel();
            Swal.fire({ icon:'success', title:'‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary">‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</a>` });
          } else Swal.fire('Error', res.message, 'error');
      });
  }

  async function showExpiredDrugs() {
      Swal.fire({title:'Loading...', didOpen:()=>Swal.showLoading()});
      try {
          const res = await callApi('getExpiredInventory');
          Swal.close();
          const div = document.getElementById('realtime-detail');
          
          if(!res.data || res.data.length === 0) {
              div.innerHTML = '<div class="alert alert-success text-center">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>';
          } else {
              div.innerHTML = `<h6 class="text-danger fw-bold"><i class="fas fa-exclamation-circle"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (${res.data.length})</h6>` + 
              res.data.map(d => `
                 <div class="border-bottom py-2">
                    <div class="fw-bold text-dark">${d.name}</div>
                    <div class="d-flex justify-content-between small text-muted"><span><i class="fas fa-box"></i> ${d.box}</span><span class="text-danger fw-bold">${d.expire}</span></div>
                 </div>`).join('');
          }
          document.getElementById('pagination-controls').classList.add('hidden');
      } catch(e) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); }
  }

  async function showSuggestions(kw) {
      if(!kw || kw.length < 2) {
          document.getElementById('search-suggestions').innerHTML = '';
          document.getElementById('search-suggestions').classList.add('hidden');
          return;
      }
      const res = await callApi('searchMasterItems', { kw });
      if(res.data && res.data.length > 0) {
          const html = res.data.map(i => 
              `<div class="p-2 border-bottom cursor-pointer hover-bg-light" onclick="doFullSearch('${i.name}'); document.getElementById('kw-realtime').value='${i.name}';">
                 <i class="fas fa-search text-muted me-2"></i> ${i.name}
              </div>`
          ).join('');
          document.getElementById('search-suggestions').innerHTML = html;
          document.getElementById('search-suggestions').classList.remove('hidden');
      } else {
          document.getElementById('search-suggestions').classList.add('hidden');
      }
  }

  async function doFullSearch(kw, page=1) {
      document.getElementById('search-suggestions').classList.add('hidden');
      if(!kw) return;
      curPage = page;
      document.getElementById('search-spinner').classList.remove('hidden');
      document.getElementById('realtime-detail').innerHTML = '';
      
      const res = await callApi('searchDrugDetails', { kw: kw, page: page });
      document.getElementById('search-spinner').classList.add('hidden');

      if(res.status) {
         totalPages = res.data.totalPages;
         totalSearchItems = res.data.totalItems;
         document.getElementById('search-count').innerText = `‡∏û‡∏ö ${totalSearchItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
         
         if(totalSearchItems === 0) {
             document.getElementById('realtime-detail').innerHTML = '<div class="alert alert-warning text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>';
             document.getElementById('pagination-controls').classList.add('hidden');
             return;
         }

         if(kw === 'SHOW_ALL') {
            document.getElementById('pagination-controls').classList.remove('hidden');
            document.getElementById('page-display').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${curPage} / ${totalPages}`;
         } else {
            document.getElementById('pagination-controls').classList.add('hidden');
         }

         document.getElementById('realtime-detail').innerHTML = res.data.results.map(d => {
           let rows = d.locations.map(l => {
               let cls = ''; let badge = '';
               if(l.isExpired) { cls = 'row-expired'; badge = '<span class="badge-expired ms-1">‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>'; }
               else if(l.isNearExp) { badge = `<span class="badge-near-exp ms-1">${l.daysLeft} ‡∏ß‡∏±‡∏ô</span>`; }
               return `<tr class="${cls}"><td>${l.box}</td><td>${l.amount}</td><td>${l.expire}${badge}</td></tr>`;
            }).join('');
           
            return `<div class="mb-3 border rounded shadow-sm p-3 bg-white fade-in">
                      <div class="d-flex gap-2">
                        <div class="drug-img-wrap" style="width:80px;height:80px;flex-shrink:0;">
                            <img src="${DEFAULT_IMG}" data-raw="${d.imageRaw}" class="drug-img lazy" referrerpolicy="no-referrer">
                        </div>
                        <div class="flex-grow-1">
                           <div class="fw-bold text-primary">${d.name} <span class="badge bg-info text-dark">‡∏£‡∏ß‡∏° ${d.totalQty}</span></div>
                           <div class="small text-muted mb-1">ID: ${d.itemId}</div>
                           <table class="table table-sm table-custom mb-0"><thead><tr><th>‡∏Å‡∏•‡πà‡∏≠‡∏á</th><th>‡∏à‡∏ô.</th><th>Exp</th></tr></thead><tbody>${rows}</tbody></table>
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-2 justify-content-end">
                        <button class="btn btn-sm btn-outline-secondary" onclick='openMasterEdit(${JSON.stringify(d).replace(/'/g, "&apos;")})'><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button class="btn btn-sm btn-outline-info" onclick="openLabelEdit('${d.itemId}')"><i class="fas fa-tag"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏â‡∏•‡∏≤‡∏Å</button>
                      </div>
                    </div>`;
         }).join('');
         lazyLoad();
      }
  }
  
  function nextPage() { if(curPage < totalPages) doFullSearch('SHOW_ALL', curPage+1); }
  function prevPage() { if(curPage > 1) doFullSearch('SHOW_ALL', curPage-1); }

  function openMasterEdit(item) {
      document.getElementById('mst-isnew').value = item.isNew ? 'true' : 'false';
      document.getElementById('mst-id').value = item.itemId || ''; document.getElementById('mst-id').disabled = !item.isNew;
      document.getElementById('mst-name').value = item.name || ''; document.getElementById('mst-img-path').value = item.imageRaw || ''; document.getElementById('mst-unit').value = item.unit || ''; document.getElementById('mst-price').value = item.price || '';
      document.getElementById('mst-ha').checked = item.highAlert; document.getElementById('mst-pl').checked = item.protectLight; document.getElementById('mst-kc').checked = item.keepCool;
      const imgEl = document.getElementById('mst-img-preview'); imgEl.src = DEFAULT_IMG;
      if(item.imageRaw) callApi('resolveImage',{input:item.imageRaw}).then(r=>{if(r.status) imgEl.src=r.src});
      mdlMasterEdit.show();
  }

  // --- LABEL EDIT ---
  async function openLabelEdit(itemId) {
      const res = await callApi('getLabelInfo', { itemId });
      let data = { itemId };
      if(res.status && res.data) data = res.data;
      document.getElementById('lbl-name').value = data.name || '';
      document.getElementById('lbl-amt').value = data.amount || '';
      document.getElementById('lbl-unit').value = data.unit || '';
      document.getElementById('lbl-l1').value = data.l1 || '';
      document.getElementById('lbl-l2').value = data.l2 || '';
      document.getElementById('lbl-l3').value = data.l3 || '';
      document.getElementById('lbl-ind').value = data.ind || '';
      window.currentLabelItemId = itemId;
      mdlLabelEdit.show();
  }
  
  async function saveLabelInfo() {
      const payload = {
          itemId: window.currentLabelItemId,
          name: document.getElementById('lbl-name').value,
          amount: document.getElementById('lbl-amt').value,
          unit: document.getElementById('lbl-unit').value,
          l1: document.getElementById('lbl-l1').value,
          l2: document.getElementById('lbl-l2').value,
          l3: document.getElementById('lbl-l3').value,
          ind: document.getElementById('lbl-ind').value
      };
      const res = await callApi('updateLabelInfo', payload);
      if(res.status) { Swal.fire('Saved'); mdlLabelEdit.hide(); }
  }

  async function uploadMasterImg(input) {
      const file = input.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        document.getElementById('mst-img-preview').src = e.target.result;
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'DRUG', name: file.name });
        if(res.status) { document.getElementById('mst-img-path').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
      }; reader.readAsDataURL(file);
  }

  async function saveMasterItem() {
      const payload = { isNew: document.getElementById('mst-isnew').value==='true', itemId: document.getElementById('mst-id').value, name: document.getElementById('mst-name').value, image: document.getElementById('mst-img-path').value, unit: document.getElementById('mst-unit').value, price: document.getElementById('mst-price').value, highAlert: document.getElementById('mst-ha').checked, protectLight: document.getElementById('mst-pl').checked, keepCool: document.getElementById('mst-kc').checked };
      const res = await callApi('updateMasterItem', payload); if(res.status) { Swal.fire('Saved'); mdlMasterEdit.hide(); }
  }

  async function uploadBoxImg(input) {
      const file = input.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        document.getElementById('preview-box-img').src = e.target.result;
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'BOX', name: file.name });
        if(res.status) { document.getElementById('edit-box-img').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
      }; reader.readAsDataURL(file);
  }
  
  async function saveBoxInfo() {
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?')) return;
      const newN = document.getElementById('edit-box-name').value; const newI = document.getElementById('edit-box-img').value;
      const res = await callApi('updateBoxInfo', { oldName: curBoxStock, newName: newN, newImage: newI });
      if(res.status) { Swal.fire('Saved'); curBoxStock=newN; location.reload(); }
  }
  
  async function searchMasterDebounce() { clearTimeout(searchTimeout); searchTimeout = setTimeout(searchMaster, 500); }
  async function searchMaster() {
      const k = document.getElementById('search-master').value; 
      const res = await callApi('searchMasterItems', { kw: k || "" });
      if(res.data) {
        document.getElementById('master-res').innerHTML = res.data.map(i=>`<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="addItemToBox('${i.id}')"><div class="d-flex align-items-center gap-2"><img src="${DEFAULT_IMG}" data-raw="${i.image}" class="lazy" referrerpolicy="no-referrer" style="width:30px;height:30px;border-radius:4px;object-fit:cover;background:#bebdbe"><span class="small">${i.name}</span></div><i class="fas fa-plus-circle text-success"></i></button>`).join('');
        lazyLoad();
      }
  }
  async function addItemToBox(itemId) { 
      const amt = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', '1'); 
      if(!amt) return; 
      const res = await callApi('addBoxItem', { boxName: curBoxStock, itemId, amount: amt }); 
      if(res.status) { loadStockItems(curBoxStock); mdlAddItem.hide(); } 
  }
  async function removeBoxItem(invId) { if(!confirm('‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏µ‡πâ?')) return; const res = await callApi('removeBoxItem', { invId }); if(res.status) loadStockItems(curBoxStock); }
  
  function startScan() {
      document.getElementById('qr-overlay').style.display = 'flex';
      html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
  }
  function stopScan() {
      if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          document.getElementById('qr-overlay').style.display = 'none';
      });
  }
  function restartScan() {
      mdlScanRes.hide();
      startScan();
  }
  async function onScanSuccess(decodedText) {
      stopScan();
      Swal.fire({title:'Searching...', didOpen:()=>Swal.showLoading()});
      const res = await callApi('getInventoryByQr', { qrCode: decodedText.trim() });
      Swal.close();
      if(res.status) {
          const d = res.data;
          document.getElementById('qr-id').value = d.invId;
          document.getElementById('qr-name').innerText = d.name;
          document.getElementById('qr-box').innerText = d.box;
          document.getElementById('qr-loc').value = d.location;
          document.getElementById('qr-amt').value = d.amount;
          document.getElementById('qr-act').value = d.actual;
          document.getElementById('qr-exp').value = thDateToIso(d.expire); 
          document.getElementById('qr-img').src = DEFAULT_IMG; 
          if(d.imageRaw) callApi('resolveImage',{input:d.imageRaw}).then(r=>{if(r.status) document.getElementById('qr-img').src=r.src});
          document.getElementById('qr-print-qty').value = 1;
          mdlScanRes.show();
      } else { Swal.fire('Not Found', 'QR Code not mapped', 'error').then(startScan); }
  }
  async function saveQrEdit() {
      const pl = { invId: document.getElementById('qr-id').value, amount: document.getElementById('qr-amt').value, actual: document.getElementById('qr-act').value, location: document.getElementById('qr-loc').value, expire: document.getElementById('qr-exp').value };
      await callApi('updateInventoryFromQr', pl);
      Swal.fire({toast:true, icon:'success', title:'Saved', position:'center', timer:1000});
      mdlScanRes.hide();
      startScan();
  }
  
  let canvas, ctx, isDraw=false;
  let cvsLabel, ctxLabel, isDrawLabel=false;
  let cvsCheck, ctxCheck, isDrawCheck=false;
  
  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
  function initCvsLabel(){ cvsLabel=document.getElementById('cvs-label'); ctxLabel=cvsLabel.getContext('2d'); ['mousedown','touchstart'].forEach(e=>cvsLabel.addEventListener(e,sL,{passive:false})); ['mousemove','touchmove'].forEach(e=>cvsLabel.addEventListener(e,dL,{passive:false})); ['mouseup','touchend'].forEach(e=>cvsLabel.addEventListener(e,()=>isDrawLabel=false)); }
  function initCvsCheck(){ cvsCheck=document.getElementById('cvs-check'); ctxCheck=cvsCheck.getContext('2d'); ['mousedown','touchstart'].forEach(e=>cvsCheck.addEventListener(e,sC,{passive:false})); ['mousemove','touchmove'].forEach(e=>cvsCheck.addEventListener(e,dC,{passive:false})); ['mouseup','touchend'].forEach(e=>cvsCheck.addEventListener(e,()=>isDrawCheck=false)); }
  
  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
  function fixCvsLabel(){ cvsLabel.width=cvsLabel.offsetWidth; cvsLabel.height=100; ctxLabel.lineWidth=2; ctxLabel.lineCap='round'; ctxLabel.strokeStyle='#000'; }
  function fixCvsCheck(){ cvsCheck.width=cvsCheck.offsetWidth; cvsCheck.height=100; ctxCheck.lineWidth=2; ctxCheck.lineCap='round'; ctxCheck.strokeStyle='#000'; }
  
  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
  function sL(e){ e.preventDefault(); isDrawLabel=true; let r=cvsLabel.getBoundingClientRect(); ctxLabel.beginPath(); ctxLabel.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function dL(e){ if(!isDrawLabel)return; e.preventDefault(); let r=cvsLabel.getBoundingClientRect(); ctxLabel.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctxLabel.stroke(); }
  function sC(e){ e.preventDefault(); isDrawCheck=true; let r=cvsCheck.getBoundingClientRect(); ctxCheck.beginPath(); ctxCheck.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function dC(e){ if(!isDrawCheck)return; e.preventDefault(); let r=cvsCheck.getBoundingClientRect(); ctxCheck.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctxCheck.stroke(); }
  
  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function clrCvsLabel(){ ctxLabel.clearRect(0,0,cvsLabel.width,cvsLabel.height); }
  function clrCvsCheck(){ ctxCheck.clearRect(0,0,cvsCheck.width,cvsCheck.height); }
  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>