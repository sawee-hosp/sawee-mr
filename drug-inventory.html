<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Hospital Pharmacy System</title>
  <link rel="icon" href="data:,">
  
  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      --primary: #008163; /* Medical Green */
      --secondary: #e0f2f1;
      --bg: #f8f9fa;
      --text: #2c3e50;
    }
    
    body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); padding-bottom: 80px; user-select: none; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Loading / Login Overlay */
    #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .loader-box { text-align: center; }

    /* Registration Modal Custom */
    .reg-check-group { text-align: left; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; }

    /* Navbar & Profile */
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: white; z-index: 1000; box-shadow: 0 1px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
    .nav-brand { font-weight: 600; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: var(--secondary); padding: 4px 10px; border-radius: 20px; }
    .profile-mini img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    .cart-wrap { position: relative; padding: 5px; cursor: pointer; transition: 0.2s; }
    .cart-badge { position: absolute; top: -2px; right: -2px; background: #d32f2f; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; border: 2px solid white; }

    /* UI Components (Reused) */
    .box-scroller { display: flex; overflow-x: auto; padding: 15px; gap: 12px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .box-scroller::-webkit-scrollbar { display: none; }
    .box-btn { min-width: 90px; padding: 10px; background: white; border: 1px solid #eee; border-radius: 16px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
    .box-btn img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-bottom: 6px; background: #f5f5f5; }
    .box-btn.active { border-color: var(--primary); background: var(--secondary); color: var(--primary); box-shadow: 0 4px 8px rgba(0,129,99,0.15); }

    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; padding: 15px; }
    .drug-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #f0f0f0; display: flex; flex-direction: column; position: relative; }
    .drug-img-wrap { height: 120px; background: #fff; display: flex; align-items: center; justify-content: center; padding: 10px; }
    .drug-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .drug-img.loading { opacity: 0.5; filter: blur(2px); }
    .drug-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; background: white; }
    .drug-name { font-size: 0.9rem; font-weight: 600; line-height: 1.3; height: 38px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; }

    /* Bottom Nav */
    .btm-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
    .nav-item { text-align: center; color: #9aa0a6; font-size: 0.7rem; width: 25%; cursor: pointer; }
    .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary); font-weight: 600; }

    /* Shelf View */
    .shelf-row-label { font-weight: bold; margin: 15px; padding-left: 10px; border-left: 4px solid var(--primary); color: #555; }
    .shelf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; padding: 0 15px; }
    .shelf-item { background: white; border: 1px solid #eee; border-radius: 8px; padding: 8px; text-align: center; position: relative; }
    .shelf-item img { width: 50px; height: 50px; object-fit: contain; }
    
    /* Helpers */
    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 30px; height: 30px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; }
    .inp-qty { width: 35px; border: none; background: transparent; text-align: center; font-weight: bold; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; height: 200px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>

  <!-- 1. LOADING & LOGIN SCREEN -->
  <div id="login-overlay">
    <div class="loader-box fade-in">
      <div style="font-size:3.5rem;color:var(--primary);margin-bottom:15px"><i class="fa-solid fa-staff-snake fa-beat"></i></div>
      <h4 class="fw-bold mb-1" style="color:#333">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</h4>
      <p class="text-muted small">Hospital Pharmacy System</p>
      <div id="status-text" class="text-primary small mt-3 fw-bold">Connecting to LIFF...</div>
    </div>
  </div>

  <!-- 2. REGISTRATION MODAL (Bootstrap Modal) -->
  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
       <div class="modal-content border-0 shadow-lg rounded-4">
          <div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary"><i class="fas fa-user-plus me-2"></i>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5></div>
          <div class="modal-body p-4">
             <div class="text-center mb-3">
                <img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)">
             </div>
             <form id="form-reg">
                <div class="mb-3"><input id="reg-username" class="form-control rounded-pill" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username) *" required></div>
                <div class="mb-3"><input id="reg-name" class="form-control rounded-pill" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏à‡∏£‡∏¥‡∏á *" required></div>
                <div class="mb-3"><input id="reg-email" type="email" class="form-control rounded-pill" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•"></div>
                
                <div class="mb-3">
                   <label class="form-label small fw-bold text-muted ms-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</label>
                   <div class="reg-check-group">
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏ô</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ANC"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ANC</label></div>
                      <div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ä‡∏Ø"> <label class="form-check-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ä‡∏Ø</label></div>
                   </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
             </form>
          </div>
       </div>
    </div>
  </div>

  <!-- 3. MAIN APP -->
  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacy</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini">
            <img id="nav-img" src="">
            <span id="nav-name" style="font-size:0.8rem;font-weight:600;max-width:80px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">User</span>
         </div>
         <div class="cart-wrap" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.4rem;color:#555"></i>
            <div id="badge" class="cart-badge hidden">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:70px">
      <!-- Order Tab -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:65px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤..." onkeyup="filterOrder()">
        </div>
        <div id="order-grid" class="drug-grid">
           <div class="text-center w-100 mt-5 text-muted"><i class="fas fa-box-open fa-3x mb-3 text-light"></i><br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
        </div>
      </div>

      <!-- Stock Tab -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5"><div class="text-center mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div>
      </div>

      <!-- Search Tab -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-primary mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡∏ó‡∏±‡πà‡∏ß ‡∏£‡∏û.</h5>
         <div class="input-group mb-3 shadow-sm rounded-pill overflow-hidden">
            <input id="kw-global" class="form-control border-0 ps-4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤...">
            <button onclick="doGlobal()" class="btn btn-primary px-4"><i class="fas fa-search"></i></button>
         </div>
         <div id="search-res" class="list-group list-group-flush rounded-3"></div>
      </div>

      <!-- History Tab -->
      <div id="tab-hist" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-secondary mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-hist', this); loadHist()"><i class="fas fa-clipboard-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
  </div>

  <!-- Cart Drawer -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000">
    <div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body d-flex flex-column p-0 bg-light">
       <div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div>
       <div class="p-3 bg-white shadow-lg mt-auto">
          <div class="d-flex justify-content-between fw-bold mb-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-primary" id="cart-sum">0.00</span></div>
          <div class="border rounded p-2 mb-3 bg-white">
             <small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô: <span class="text-danger cursor-pointer float-end" onclick="clrCvs()">‡∏•‡πâ‡∏≤‡∏á</span></small>
             <canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas>
          </div>
          <button onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
       </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="mdlEdit">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
           <div class="modal-header border-0 pb-0"><h5 class="fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
           <div class="modal-body text-center pt-2">
              <input type="hidden" id="ed-id">
              <h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6>
              <div class="row g-2">
                 <div class="col-6"><label class="small text-muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div>
                 <div class="col-6"><label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="date" id="ed-exp" class="form-control text-center"></div>
              </div>
              <button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
           </div>
        </div>
     </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- CONFIG ---
  // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAb1BMVEUAAAD///+srKzFxcWZmZnc3Nza2trR0dHnYzr///8/Pz9ycnKwZzKtra1ERETGxsbMzMy3t7fAwMDq6uqgoKCkpKRubm5KSkpYWFji4uJHR0dgYGBubm5mZmZwcHBqampycnJOTk5UVFR8fHxISEh929s2AAAAInRSTlMA+/zb2v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+2tra2t7XhY8AAAN1SURBVGje7ZqJjqMwDEXlMnOYzUx3//+3F5QiazmC0Onw3rSpU0eFkPCRjO0407/1dZ+y701/c72u852t+2u972z93+t15+t/r9d90D8s7oP+YXEfdIjFfdAhFvdB+1g8Bn3F4jHoKxaPQV+xeAz6isVj0FcsHoO+YvEY9BWLx6CvWDwGfcXiMeirj8S6z/oR6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7D+B/0Fq7h+W3gqAAAAAElFTkSuQmCC";

  let liffId = "2008862022-cDOpEP9z"; 
  
  let userProfile = {};
  let currentUser = {}; 
  let items=[], cart=[], curBoxOrder='', curBoxStock='';
  let offC, mdlEdit, mdlReg;

  // --- API HELPER (CORS WORKAROUND) ---
  async function callApi(action, payload = {}) {
     const body = JSON.stringify({ action, ...payload });
     try {
       const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: body
       });
       
       if (!res.ok) {
         throw new Error(`HTTP error! status: ${res.status}`);
       }
       
       const text = await res.text();
       try {
           return JSON.parse(text);
       } catch (e) {
           // ‡∏à‡∏±‡∏ö Error "Service is..." ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
           if (text.includes("Service is")) {
               throw new Error("DEPLOYMENT ERROR: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GAS Deployment ‡πÄ‡∏õ‡πá‡∏ô 'Execute as: Me' ‡πÅ‡∏•‡∏∞ 'Who has access: Anyone'");
           }
           throw new Error("Invalid JSON: " + text.substring(0, 50));
       }
     } catch(e) {
       console.error("API Error", e);
       if(e.message.includes("DEPLOYMENT ERROR")) {
           Swal.fire({
               icon: 'error',
               title: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
               html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Apps Script <br>‡∏Å‡∏î Deploy > New Deployment <br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>Execute as: Me</b> <br>‡πÅ‡∏•‡∏∞ <b>Who has access: Anyone</b>',
               footer: '‡∏°‡∏¥‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
           });
       }
       return { status: 'error', message: e.message };
     }
  }

  // --- INITIALIZATION ---
  window.onload = async () => {
     offC = new bootstrap.Offcanvas('#cartSheet');
     mdlEdit = new bootstrap.Modal('#mdlEdit');
     mdlReg = new bootstrap.Modal('#mdlRegister');
     initCvs();

     try {
        await liff.init({ liffId: liffId }); 
        if (!liff.isLoggedIn()) {
           liff.login();
        } else {
           const profile = await liff.getProfile();
           userProfile = profile;
           checkUser(profile.userId);
        }
     } catch (err) {
        console.warn('LIFF Init failed', err);
        document.getElementById('status-text').innerHTML = `<span class="text-danger">LIFF Error: ${err.message}</span>`;
     }
  };

  async function checkUser(uid) {
     document.getElementById('status-text').innerText = 'Checking User Database...';
     const res = await callApi('checkUserLIFF', { userId: uid });
     
     if (res.status === 'NOT_FOUND') {
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('reg-img').src = userProfile.pictureUrl || DEFAULT_IMG;
        mdlReg.show();
     } else if (res.status === 'FOUND') {
        currentUser = res.userData;
        currentUser.userId = uid; 
        startApp();
     } else {
        document.getElementById('status-text').innerText = 'Connection Failed.';
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Error ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Deployment ‡∏Å‡πá‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
        if(!res.message.includes("DEPLOYMENT")) {
            Swal.fire('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + res.message, 'error');
        }
     }
  }

  // --- REGISTRATION ---
  document.getElementById('form-reg').onsubmit = async (e) => {
     e.preventDefault();
     const subs = Array.from(document.querySelectorAll('.chk-sub:checked')).map(c=>c.value);
     if(subs.length === 0) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

     const payload = {
        username: document.getElementById('reg-username').value,
        name: document.getElementById('reg-name').value,
        email: document.getElementById('reg-email').value,
        substock: subs,
        userId: userProfile.userId,
        photo: userProfile.pictureUrl || ''
     };

     Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});
     const res = await callApi('registerUser', payload);
     
     if(res.status) {
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        mdlReg.hide();
        currentUser = payload; 
        startApp();
     } else {
        Swal.fire('Error', res.message, 'error');
     }
  };

  // --- APP START ---
  async function startApp() {
     document.getElementById('login-overlay').classList.add('hidden');
     document.getElementById('app-main').classList.remove('hidden');
     
     // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ undefined src
     const photo = currentUser.photo;
     document.getElementById('nav-img').src = (photo && photo !== 'undefined' && photo !== '') ? photo : DEFAULT_IMG;
     document.getElementById('nav-name').innerText = currentUser.name;

     const res = await callApi('getBoxes', { substock: currentUser.substock });
     if(res.status) renderBoxScrollers(res.boxes);
  }

  // --- UI LOGIC ---
  function nav(pid, el){
     document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden'));
     document.getElementById(pid).classList.remove('hidden');
     document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
     el.classList.add('active');
  }

  function renderBoxScrollers(bs){
     const mk = (m) => bs.map(b=>`
       <div class="box-btn" onclick="selBox('${b.name}', this, '${m}')">
          <img src="${DEFAULT_IMG}" class="lazy" data-raw="${b.imageRaw}">
          <span style="font-size:0.75rem;line-height:1.1;font-weight:600">${b.name}</span>
       </div>`).join('');
     document.getElementById('box-scroller-order').innerHTML = mk('order');
     document.getElementById('box-scroller-stock').innerHTML = mk('stock');
     lazyLoad();
  }

  async function selBox(name, el, mode) {
     if(mode==='order') {
        if(cart.length && curBoxOrder!=name && !confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;
        if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
        curBoxOrder = name;
        document.querySelectorAll('#box-scroller-order .box-btn').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        loadOrderItems(name);
     } else {
        curBoxStock = name;
        document.querySelectorAll('#box-scroller-stock .box-btn').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        loadStockItems(name);
     }
  }

  async function loadOrderItems(box) {
     document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-3"></div>').join('');
     const res = await callApi('getItems', { boxName: box });
     if(res.status) {
       items = res.data.map(x=>({...x, req:1}));
       renderOrder();
       lazyLoad();
     } else {
       document.getElementById('order-grid').innerHTML = '<div class="text-center mt-5 text-danger">Error Loading Items</div>';
     }
  }

  function renderOrder() {
     const kw = document.getElementById('order-search').value.toLowerCase();
     const html = items.filter(i=>i.name.toLowerCase().includes(kw)).map(i=>`
        <div class="drug-card">
           <div class="drug-img-wrap"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy loading"></div>
           <div class="drug-info">
              <div class="drug-name">${i.name}</div>
              <div class="d-flex justify-content-between small text-muted mb-2"><span>‡∏°‡∏µ: ${i.amount}</span><span class="text-primary fw-bold">${i.price} ‡∏ö.</span></div>
              <div class="qty-wrap">
                 <button class="btn-qty" onclick="adj('${i.itemId}',-1)">-</button>
                 <input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly>
                 <button class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</button>
              </div>
              <button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
           </div>
        </div>`).join('');
     document.getElementById('order-grid').innerHTML = html || '<div class="text-center mt-5 w-100 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤</div>';
  }

  // --- LAZY LOADING ---
  function lazyLoad() {
     const imgs = document.querySelectorAll('img.lazy');
     imgs.forEach(img => {
        if(img.dataset.loaded) return;
        const raw = img.dataset.raw;
        if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; }
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Link ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢ (‡πÅ‡∏•‡∏∞ Cache ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ link ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
        if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; }
        
        callApi('resolveImage', { input: raw }).then(res => {
           if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; }
        });
     });
  }

  // --- CART, SUBMIT, STOCK, SEARCH (No Changes needed, kept short) ---
  function adj(id, v, max) {
     let i = items.find(x=>x.itemId==id); if(!i) return;
     let n = i.req + v; if(n<1)n=1; if(max && n>max) { n=max; Swal.fire({toast:true,position:'top',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å',timer:1000,showConfirmButton:false}); }
     i.req = n; document.getElementById(`qty-${id}`).value = n;
  }
  function addCart(id) {
     let i = items.find(x=>x.itemId==id); let ex = cart.find(x=>x.itemId==id);
     if(ex) { if(ex.qty+i.req > i.amount) return Swal.fire('‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'); ex.qty+=i.req; } else cart.push({...i, qty:i.req});
     badge(); document.querySelector('.cart-wrap').style.transform='scale(1.2)'; setTimeout(()=>document.querySelector('.cart-wrap').style.transform='scale(1)',200);
     i.req=1; document.getElementById(`qty-${id}`).value=1;
  }
  function badge() { let n=cart.length; document.getElementById('badge').innerText=n; n>0?document.getElementById('badge').classList.remove('hidden'):document.getElementById('badge').classList.add('hidden'); }
  function openCart(){ if(!cart.length) return Swal.fire('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); renderCart(); offC.show(); setTimeout(fixCvs,500); }
  function renderCart(){
     let sum=0;
     document.getElementById('cart-list').innerHTML=cart.map((c,i)=>{ sum+=c.price*c.qty; return `<div class="bg-white p-3 mb-2 rounded border position-relative"><div class="fw-bold pe-4">${c.name}</div><div class="d-flex justify-content-between mt-2 small text-muted"><span>${c.price} x ${c.qty}</span> <span class="text-primary fw-bold">${(c.price*c.qty).toFixed(2)} ‡∏ö.</span></div><i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3 cursor-pointer" onclick="cart.splice(${i},1);renderCart();badge();if(!cart.length)offC.hide()"></i></div>`; }).join('');
     document.getElementById('cart-sum').innerText = sum.toFixed(2);
  }
  async function submitOrder() {
     if(isCanvasBlank(canvas)) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠');
     Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen:()=>Swal.showLoading()});
     const sign = canvas.toDataURL();
     const res = await callApi('submitOrder', { orderData: { user: currentUser.name, box: curBoxOrder, items: cart, signature: sign } });
     if(res.status) { cart=[]; badge(); offC.hide(); clrCvs(); Swal.fire({icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', html:`<a href="${res.pdfUrl}" target="_blank" class="btn btn-primary w-100">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å (PDF)</a>`}); } else Swal.fire('Error', res.message, 'error');
  }
  async function loadStockItems(box) {
      document.getElementById('stock-content').innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
      const res = await callApi('getItems', { boxName: box });
      if(!res.status) { document.getElementById('stock-content').innerHTML = '<div class="text-center mt-5 text-danger">Error Loading Stock</div>'; return; }
      let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
      let h=''; Object.keys(rows).sort().forEach(r=>{ h+=`<div class="shelf-row-label">‡∏ä‡∏±‡πâ‡∏ô/‡πÅ‡∏ñ‡∏ß: ${r}</div><div class="shelf-grid">`; h+=rows[r].map(i=>`<div class="shelf-item" onclick="editStk('${i.invId}','${i.name}',${i.amount},'${i.expire}')"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy"><div class="small text-truncate">${i.name}</div><div class="badge bg-secondary">${i.amount}</div></div>`).join(''); h+='</div>'; });
      document.getElementById('stock-content').innerHTML = h; lazyLoad();
  }
  function editStk(id,n,a,e) { document.getElementById('ed-id').value=id; document.getElementById('ed-name').innerText=n; document.getElementById('ed-amt').value=a; document.getElementById('ed-exp').value=e; mdlEdit.show(); }
  async function saveEdit() { const pl = { invId:document.getElementById('ed-id').value, amount:document.getElementById('ed-amt').value, expire:document.getElementById('ed-exp').value }; const res = await callApi('saveEditItem', pl); if(res.status) { Swal.fire('Saved','','success'); mdlEdit.hide(); loadStockItems(curBoxStock); } }
  function doGlobal() { const k=document.getElementById('kw-global').value; if(!k)return; document.getElementById('search-res').innerHTML='Searching...'; callApi('searchGlobal', {kw:k}).then(res=>{ if(res.status) { document.getElementById('search-res').innerHTML = res.data.map(r=>`<div class="list-group-item"><strong>${r.name}</strong><br><small>${r.box} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${r.amount}</small></div>`).join('') || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; } }); }
  function loadHist() { document.getElementById('hist-res').innerHTML='Loading...'; callApi('getHistory', {user:currentUser.name}).then(res=>{ if(res.status) { document.getElementById('hist-res').innerHTML = res.data.map(r=>`<div class="card mb-2 p-2 shadow-sm"><div class="d-flex justify-content-between"><strong>${r.box}</strong><small>${r.time}</small></div><div class="text-end"><a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill">PDF</a></div></div>`).join(''); } }); }
  function filterOrder(){ renderOrder(); }
  let canvas, ctx, isDraw=false;
  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>