<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Hospital Pharmacy System</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
      --primary: #0d6efd; 
      --primary-dark: #0a58ca;
      --secondary: #e7f1ff;
      --bg: #f8f9fa;
      --text: #2c3e50;
    }
    
    body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); padding-bottom: 80px; user-select: none; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Loading Overlay */
    #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; }

    /* Navbar */
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: white; z-index: 1000; box-shadow: 0 1px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
    .nav-brand { font-weight: 600; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: var(--secondary); padding: 4px 10px; border-radius: 20px; color: var(--primary-dark); }
    .profile-mini img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    
    /* Box Scroller (Carousel) - Blue Theme */
    .box-scroller { display: flex; overflow-x: auto; padding: 15px; gap: 12px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .box-scroller::-webkit-scrollbar { display: none; }
    .box-btn { 
      min-width: 90px; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 16px; 
      text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; 
      color: #555;
    }
    /* Square Image Fit */
    .box-btn img { 
      width: 50px; height: 50px; border-radius: 8px; /* Square with slight radius */
      object-fit: cover; margin-bottom: 6px; background: #f5f5f5; border: 1px solid #eee;
    }
    .box-btn.active { 
      border: 2px solid var(--primary-dark); background: var(--secondary); color: var(--primary-dark); 
      transform: translateY(-2px); box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2); 
    }

    /* Grid & Cards */
    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; padding: 15px; }
    .drug-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #f0f0f0; display: flex; flex-direction: column; position: relative; }
    .drug-img-wrap { 
      width: 100%; aspect-ratio: 1/1; /* Force Square */
      background: #fff; display: flex; align-items: center; justify-content: center; padding: 10px; border-bottom: 1px solid #f8f8f8;
    }
    .drug-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; } /* Crop Fit */
    .drug-img.loading { opacity: 0.5; filter: blur(2px); }
    
    .drug-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; background: white; }
    .drug-name { font-size: 0.9rem; font-weight: 600; line-height: 1.3; height: 38px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; }

    /* Bottom Nav */
    .btm-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
    .nav-item { text-align: center; color: #9aa0a6; font-size: 0.7rem; width: 25%; cursor: pointer; }
    .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 4px; }
    .nav-item.active { color: var(--primary); font-weight: 600; }

    /* Stock UI Extras */
    .filter-bar { display: flex; gap: 8px; padding: 0 15px 10px 15px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
    .filter-pill { 
      padding: 5px 12px; border-radius: 20px; background: white; border: 1px solid #ddd; font-size: 0.8rem; color: #666; cursor: pointer; 
    }
    .filter-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .fab-edit {
      position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px;
      background: var(--primary); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 1.5rem; z-index: 900;
      transition: transform 0.2s;
    }
    .fab-edit:active { transform: scale(0.9); }

    /* Shelf View */
    .shelf-item { position: relative; border:1px solid #eee; border-radius:8px; padding:5px; text-align:center; }
    .shelf-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    .btn-del-item { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; display: none; }
    .shelf-item.editing .btn-del-item { display: flex; }

    /* Helpers */
    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 30px; height: 30px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; }
    .inp-qty { width: 35px; border: none; background: transparent; text-align: center; font-weight: bold; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; height: 200px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>

  <!-- LOADING & LOGIN -->
  <div id="login-overlay">
    <div class="text-center fade-in">
      <div style="font-size:3.5rem;color:var(--primary);margin-bottom:15px"><i class="fa-solid fa-hospital-user fa-beat"></i></div>
      <h4 class="fw-bold mb-1" style="color:#333">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</h4>
      <div id="status-text" class="text-primary small mt-3 fw-bold">Connecting...</div>
    </div>
  </div>

  <!-- REGISTRATION MODAL -->
  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5></div><div class="modal-body p-4"><div class="text-center mb-3"><img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)"></div><form id="form-reg"><input id="reg-username" class="form-control mb-3" placeholder="Username *" required><input id="reg-name" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *" required><input id="reg-email" class="form-control mb-3" placeholder="Email"><div class="mb-3"><label class="small fw-bold text-muted">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label><div class="p-2 border rounded bg-white" style="max-height:150px;overflow-y:auto"><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á</label></div></div></div><button type="submit" class="btn btn-primary w-100 rounded-pill">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button></form></div></div></div></div>

  <!-- APP MAIN -->
  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacy</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini"><img id="nav-img" src=""><span id="nav-name" style="font-size:0.8rem;font-weight:600;">User</span></div>
         <div style="position:relative;padding:5px;" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.4rem;color:#555"></i>
            <div id="badge" class="badge bg-danger rounded-circle position-absolute top-0 end-0 hidden" style="font-size:10px">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:70px">
      <!-- 1. ORDER -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:65px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤..." onkeyup="filterOrder()">
        </div>
        <div id="order-grid" class="drug-grid"><div class="text-center w-100 mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div></div>
      </div>

      <!-- 2. STOCK -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="group-filter" class="filter-bar"></div>
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5 px-3">
           <div class="text-center mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
        </div>
        <!-- Edit FAB -->
        <div id="fab-edit" class="fab-edit hidden" onclick="openBoxEditor()"><i class="fas fa-edit"></i></div>
      </div>

      <!-- 3. SEARCH -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-primary mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡∏ó‡∏±‡πà‡∏ß ‡∏£‡∏û.</h5>
         <div class="input-group mb-3 shadow-sm rounded-pill"><input id="kw-global" class="form-control border-0 ps-4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..."><button onclick="doGlobal()" class="btn btn-primary px-4"><i class="fas fa-search"></i></button></div>
         <div id="search-res" class="list-group list-group-flush rounded-3"></div>
      </div>

      <!-- 4. HISTORY -->
      <div id="tab-hist" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-secondary mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-hist', this); loadHist()"><i class="fas fa-history"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
  </div>

  <!-- CART DRAWER -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000">
    <div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body d-flex flex-column p-0 bg-light">
       <div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div>
       <div class="p-3 bg-white shadow-lg mt-auto">
          <div class="d-flex justify-content-between fw-bold mb-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-primary" id="cart-sum">0.00</span></div>
          <div class="border rounded p-2 mb-3 bg-white">
             <small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:</small>
             <canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas>
             <div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvs()">‡∏•‡πâ‡∏≤‡∏á</small></div>
          </div>
          <button onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
       </div>
    </div>
  </div>

  <!-- BOX EDITOR MODAL -->
  <div class="modal fade" id="mdlBoxEdit" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡πà‡∏≠‡∏á</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
           <div class="card p-3 mb-3 border-0 shadow-sm">
              <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
              <input id="edit-box-name" class="form-control fw-bold mb-2">
              <label class="small text-muted">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Drive path/link)</label>
              <input id="edit-box-img" class="form-control text-muted" style="font-size:0.8rem">
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="saveBoxInfo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏π‡∏õ</button>
           </div>
           
           <h6 class="fw-bold mt-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</h6>
           <button class="btn btn-sm btn-success mb-2" onclick="mdlAddItem.show()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á</button>
           <div id="edit-box-items" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD ITEM MODAL -->
  <div class="modal fade" id="mdlAddItem" style="z-index:2100">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
           <div class="modal-header"><h6 class="fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Master Items</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
           <div class="modal-body">
              <div class="input-group mb-2"><input id="search-master" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..."><button class="btn btn-primary" onclick="searchMaster()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button></div>
              <div id="master-res" class="list-group" style="max-height:200px;overflow-y:auto"></div>
           </div>
        </div>
     </div>
  </div>

  <!-- EDIT STOCK ITEM MODAL -->
  <div class="modal fade" id="mdlEdit">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
           <div class="modal-body text-center p-4">
              <input type="hidden" id="ed-id">
              <h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6>
              <div class="row g-2">
                 <div class="col-6"><label class="small text-muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div>
                 <div class="col-6"><label class="small text-muted">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="date" id="ed-exp" class="form-control text-center"></div>
              </div>
              <button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
           </div>
        </div>
     </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- CONFIG ---
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAb1BMVEUAAAD///+srKzFxcWZmZnc3Nza2trR0dHnYzr///8/Pz9ycnKwZzKtra1ERETGxsbMzMy3t7fAwMDq6uqgoKCkpKRubm5KSkpYWFji4uJHR0dgYGBubm5mZmZwcHBqampycnJOTk5UVFR8fHxISEh929s2AAAAInRSTlMA+/zb2v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+2tra2t7XhY8AAAN1SURBVGje7ZqJjqMwDEXlMnOYzUx3//+3F5QiazmC0Onw3rSpU0eFkPCRjO0407/1dZ+y701/c72u852t+2u972z93+t15+t/r9d90D8s7oP+YXEfdIjFfdAhFvdB+1g8Bn3F4jHoKxaPQV+xeAz6isVj0FcsHoO+YvEY9BWLx6CvWDwGfcXiMeirj8S6z/oR6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7D+B/0Fq7h+W3gqAAAAAElFTkSuQmCC";

  let liffId = "2008862022-cDOpEP9z";
  
  let currentUser = {}, items=[], cart=[], curBoxOrder='', curBoxStock='';
  let allBoxes = []; // Store for filtering
  let offC, mdlEdit, mdlReg, mdlBoxEdit, mdlAddItem;

  // --- API ---
  async function callApi(action, payload = {}) {
     try {
       const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: {'Content-Type': 'text/plain;charset=utf-8'},
          body: JSON.stringify({ action, ...payload })
       });
       const text = await res.text();
       try { return JSON.parse(text); } 
       catch(e) { 
           if(text.includes("Service is")) throw new Error("DEPLOYMENT_ERR");
           throw new Error(text.substr(0,50)); 
       }
     } catch(e) {
       console.error(e);
       if(e.message=="DEPLOYMENT_ERR") Swal.fire('Error','Deploy ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Execute as Me / Anyone','error');
       return { status: 'error', message: e.message };
     }
  }

  // --- INIT ---
  window.onload = async () => {
     offC = new bootstrap.Offcanvas('#cartSheet');
     mdlEdit = new bootstrap.Modal('#mdlEdit');
     mdlReg = new bootstrap.Modal('#mdlRegister');
     mdlBoxEdit = new bootstrap.Modal('#mdlBoxEdit');
     mdlAddItem = new bootstrap.Modal('#mdlAddItem');
     initCvs();

     try {
        await liff.init({ liffId }); 
        if(!liff.isLoggedIn()) liff.login();
        else {
           const profile = await liff.getProfile();
           currentUser.photo = profile.pictureUrl;
           checkUser(profile.userId);
        }
     } catch(e) {
        document.getElementById('status-text').innerHTML = `<span class="text-danger">${e.message}</span>`;
     }
  };

  async function checkUser(uid) {
     const res = await callApi('checkUserLIFF', { userId: uid });
     if (res.status === 'NOT_FOUND') {
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('reg-img').src = currentUser.photo || DEFAULT_IMG;
        mdlReg.show();
     } else if (res.status === 'FOUND') {
        currentUser = { ...res.userData, userId: uid };
        startApp();
     }
  }

  document.getElementById('form-reg').onsubmit = async (e) => {
     e.preventDefault();
     const subs = Array.from(document.querySelectorAll('.chk-sub:checked')).map(c=>c.value);
     if(!subs.length) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å');
     Swal.showLoading();
     const res = await callApi('registerUser', {
        username: document.getElementById('reg-username').value,
        name: document.getElementById('reg-name').value,
        email: document.getElementById('reg-email').value,
        substock: subs, userId: currentUser.userId, photo: currentUser.photo
     });
     if(res.status) location.reload(); else Swal.fire(res.message);
  };

  async function startApp() {
     document.getElementById('login-overlay').classList.add('hidden');
     document.getElementById('app-main').classList.remove('hidden');
     document.getElementById('nav-img').src = currentUser.photo || DEFAULT_IMG;
     document.getElementById('nav-name').innerText = currentUser.name;

     // Load Boxes for Order (Filtered)
     const resOrder = await callApi('getBoxes', { substock: currentUser.substock, showAll: false });
     if(resOrder.status) renderBoxScroller('order', resOrder.boxes);

     // Load All Boxes for Stock (Unfiltered) & Groups
     const resStock = await callApi('getBoxes', { showAll: true });
     if(resStock.status) {
         allBoxes = resStock.boxes;
         renderBoxScroller('stock', allBoxes);
     }
     
     const resGroups = await callApi('getBoxGroups');
     if(resGroups.status) {
         document.getElementById('group-filter').innerHTML = 
            `<div class="filter-pill active" onclick="filterStockBox('ALL',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>` + 
            resGroups.groups.map(g=>`<div class="filter-pill" onclick="filterStockBox('${g}',this)">${g}</div>`).join('');
     }
  }

  // --- UI RENDER ---
  function renderBoxScroller(mode, boxes) {
     const el = document.getElementById(`box-scroller-${mode}`);
     el.innerHTML = boxes.map(b=>`
       <div class="box-btn" onclick="selBox('${b.name}', this, '${mode}', '${b.imageRaw}')">
          <img src="${DEFAULT_IMG}" class="lazy" data-raw="${b.imageRaw}">
          <span style="font-size:0.75rem;line-height:1.1;font-weight:600">${b.name}</span>
       </div>`).join('');
     lazyLoad();
  }

  function filterStockBox(group, el) {
      document.querySelectorAll('.filter-pill').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      const filtered = (group==='ALL') ? allBoxes : allBoxes.filter(b=>b.group===group);
      renderBoxScroller('stock', filtered);
  }

  function nav(pid, el){
     document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden'));
     document.getElementById(pid).classList.remove('hidden');
     document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
     el.classList.add('active');
  }

  async function selBox(name, el, mode, imgRaw) {
     document.querySelectorAll(`#box-scroller-${mode} .box-btn`).forEach(x=>x.classList.remove('active'));
     el.classList.add('active');
     
     if(mode==='order') {
        if(cart.length && curBoxOrder!=name && !confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;
        if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
        curBoxOrder = name;
        loadOrderItems(name);
     } else {
        curBoxStock = name;
        document.getElementById('fab-edit').classList.remove('hidden');
        // Pre-fill edit modal
        document.getElementById('edit-box-name').value = name;
        document.getElementById('edit-box-img').value = imgRaw;
        loadStockItems(name);
     }
  }

  // --- INVENTORY ---
  async function loadOrderItems(box) {
     document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-2"></div>').join('');
     const res = await callApi('getItems', { boxName: box });
     items = res.status ? res.data.map(x=>({...x, req:1})) : [];
     renderOrder();
     lazyLoad();
  }
  
  function renderOrder() {
     const kw = document.getElementById('order-search').value.toLowerCase();
     const html = items.filter(i=>i.name.toLowerCase().includes(kw)).map(i=>`
        <div class="drug-card">
           <div class="drug-img-wrap"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy loading"></div>
           <div class="drug-info">
              <div class="drug-name">${i.name}</div>
              <div class="d-flex justify-content-between small text-muted mb-2"><span>‡∏°‡∏µ: ${i.amount}</span><span class="text-primary fw-bold">${i.price} ‡∏ö.</span></div>
              <div class="qty-wrap">
                 <button class="btn-qty" onclick="adj('${i.itemId}',-1)">-</button>
                 <input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly>
                 <button class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</button>
              </div>
              <button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
           </div>
        </div>`).join('');
     document.getElementById('order-grid').innerHTML = html || '<div class="text-center mt-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤</div>';
  }

  // --- STOCK & EDIT BOX ---
  async function loadStockItems(box) {
      const el = document.getElementById('stock-content');
      el.innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
      const res = await callApi('getItems', { boxName: box });
      if(!res.status) return el.innerHTML = 'Error';
      
      let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
      let h=''; 
      // Stock View
      Object.keys(rows).sort().forEach(r=>{
         h+=`<div class="fw-bold mt-3 border-start border-4 border-primary ps-2 text-muted">‡∏ä‡∏±‡πâ‡∏ô/‡πÅ‡∏ñ‡∏ß: ${r}</div><div class="d-flex flex-wrap gap-2 mt-2">`;
         h+=rows[r].map(i=>`
           <div class="shelf-item" style="width:100px" onclick="editStk('${i.invId}','${i.name}',${i.amount},'${i.expire}')">
             <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy">
             <div class="small text-truncate mt-1">${i.name}</div>
             <span class="badge bg-secondary">${i.amount}</span>
           </div>`).join('');
         h+='</div>';
      });
      el.innerHTML = h;

      // Render Edit Box Items List
      const editHtml = res.data.map(i=>`
         <div class="col-12 d-flex align-items-center bg-white border p-2 rounded">
             <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" style="width:40px;height:40px;object-fit:cover;border-radius:4px">
             <div class="flex-grow-1 ms-2 small text-truncate">${i.name}</div>
             <button class="btn btn-sm btn-outline-danger" onclick="removeBoxItem('${i.invId}')"><i class="fas fa-trash"></i></button>
         </div>`).join('');
      document.getElementById('edit-box-items').innerHTML = editHtml;
      
      lazyLoad();
  }

  function openBoxEditor() { mdlBoxEdit.show(); }
  
  async function saveBoxInfo() {
     if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏π‡∏õ‡∏Å‡∏•‡πà‡∏≠‡∏á?')) return;
     const newN = document.getElementById('edit-box-name').value;
     const newI = document.getElementById('edit-box-img').value;
     const res = await callApi('updateBoxInfo', { oldName: curBoxStock, newName: newN, newImage: newI });
     if(res.status) { Swal.fire('Saved'); curBoxStock=newN; location.reload(); }
  }

  async function searchMaster() {
     const k = document.getElementById('search-master').value;
     const res = await callApi('searchMasterItems', { kw: k });
     document.getElementById('master-res').innerHTML = res.data.map(i=>`
        <button class="list-group-item list-group-item-action d-flex justify-content-between" onclick="addItemToBox('${i.id}')">
           <span>${i.name}</span> <i class="fas fa-plus-circle text-success"></i>
        </button>`).join('');
  }

  async function addItemToBox(itemId) {
     const amt = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', '1');
     if(!amt) return;
     const res = await callApi('addBoxItem', { boxName: curBoxStock, itemId, amount: amt });
     if(res.status) { loadStockItems(curBoxStock); mdlAddItem.hide(); }
  }

  async function removeBoxItem(invId) {
     if(!confirm('‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á?')) return;
     const res = await callApi('removeBoxItem', { invId });
     if(res.status) loadStockItems(curBoxStock);
  }

  // --- CART, SUBMIT ---
  function adj(id, v, max) {
     let i = items.find(x=>x.itemId==id); if(!i) return;
     let n = i.req + v; if(n<1)n=1; if(max && n>max) { n=max; Swal.fire({toast:true,position:'top',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); }
     i.req = n; document.getElementById(`qty-${id}`).value = n;
  }
  function addCart(id) {
     let i = items.find(x=>x.itemId==id); let ex = cart.find(x=>x.itemId==id);
     if(ex) { if(ex.qty+i.req > i.amount) return Swal.fire('‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'); ex.qty+=i.req; } else cart.push({...i, qty:i.req});
     badge(); 
     const b=document.querySelector('.fa-shopping-basket'); b.style.transform='scale(1.4)'; setTimeout(()=>b.style.transform='scale(1)',200);
     i.req=1; document.getElementById(`qty-${id}`).value=1;
  }
  function badge() { let n=cart.length; document.getElementById('badge').innerText=n; n>0?document.getElementById('badge').classList.remove('hidden'):document.getElementById('badge').classList.add('hidden'); }
  function openCart(){ if(!cart.length) return Swal.fire('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); renderCart(); offC.show(); setTimeout(fixCvs,500); }
  function renderCart(){
     let sum=0;
     document.getElementById('cart-list').innerHTML=cart.map((c,i)=>{ sum+=c.price*c.qty; return `<div class="bg-white p-3 mb-2 rounded border position-relative"><div class="fw-bold pe-4">${c.name}</div><div class="d-flex justify-content-between mt-2 small text-muted"><span>${c.price} x ${c.qty}</span> <span class="text-primary fw-bold">${(c.price*c.qty).toFixed(2)} ‡∏ö.</span></div><i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3 cursor-pointer" onclick="cart.splice(${i},1);renderCart();badge();if(!cart.length)offC.hide()"></i></div>`; }).join('');
     document.getElementById('cart-sum').innerText = sum.toFixed(2);
  }
  
  async function submitOrder() {
     if(isCanvasBlank(canvas)) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠');
     Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen:()=>Swal.showLoading()});
     const sign = canvas.toDataURL();
     const res = await callApi('submitOrder', { orderData: { user: currentUser.name, box: curBoxOrder, items: cart, signature: sign } });
     if(res.status) { cart=[]; badge(); offC.hide(); clrCvs(); Swal.fire({icon:'success', html:`<a href="${res.pdfUrl}" target="_blank" class="btn btn-primary w-100">‡∏î‡∏π‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (PDF)</a>`}); } else Swal.fire('Error', res.message, 'error');
  }

  // --- HELPERS ---
  function editStk(id,n,a,e) { document.getElementById('ed-id').value=id; document.getElementById('ed-name').innerText=n; document.getElementById('ed-amt').value=a; document.getElementById('ed-exp').value=e; mdlEdit.show(); }
  async function saveEdit() { const pl = { invId:document.getElementById('ed-id').value, amount:document.getElementById('ed-amt').value, expire:document.getElementById('ed-exp').value }; const res = await callApi('saveEditItem', pl); if(res.status) { mdlEdit.hide(); loadStockItems(curBoxStock); } }
  function doGlobal() { const k=document.getElementById('kw-global').value; if(!k)return; document.getElementById('search-res').innerHTML='Searching...'; callApi('searchGlobal', {kw:k}).then(res=>{ if(res.status) { document.getElementById('search-res').innerHTML = res.data.map(r=>`<div class="list-group-item"><strong>${r.name}</strong><br><small>${r.box} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${r.amount}</small></div>`).join('') || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; } }); }
  function loadHist() { document.getElementById('hist-res').innerHTML='Loading...'; callApi('getHistory', {user:currentUser.name}).then(res=>{ if(res.status) { document.getElementById('hist-res').innerHTML = res.data.map(r=>`<div class="card mb-2 p-2 shadow-sm"><div class="d-flex justify-content-between"><strong>${r.box}</strong><small>${r.time}</small></div><div class="text-end"><a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill">PDF</a></div></div>`).join(''); } }); }
  function filterOrder(){ renderOrder(); }
  
  function lazyLoad() {
     document.querySelectorAll('img.lazy').forEach(img => {
        if(img.dataset.loaded) return;
        const raw = img.dataset.raw;
        if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; }
        if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; }
        callApi('resolveImage', { input: raw }).then(res => { if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; } });
     });
  }

  let canvas, ctx, isDraw=false;
  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>