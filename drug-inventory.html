<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sawee Rxfill 2.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’Š</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      --primary: #003d82;
      --bg: #f4f6f9;
      --text: #2c3e50;
      --ha-color: #ffebee;
      --cool-color: #e3f2fd;
    }
    body { background-color: var(--bg); color: var(--text); font-family: var(--font-main) !important; padding-bottom: 60px; user-select: none; }
    .hidden { display: none !important; }
    
    /* --- Original CSS Restored --- */
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--primary); color: white; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .nav-brand { font-weight: 600; font-size: 1.1rem; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
    .profile-mini img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid white; }

    .box-scroller { display: flex; overflow-x: auto; padding: 10px; gap: 8px; scrollbar-width: none; }
    .box-btn { 
      min-width: 85px; padding: 8px; background: var(--primary); color: white; 
      border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; text-align: center; cursor: pointer; 
      display: flex; flex-direction: column; align-items: center; transition: 0.2s; position: relative; 
    }
    .box-btn.active { background: white; color: var(--primary); border: 2px solid var(--primary); transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .box-icon { font-size: 2.2rem; margin-bottom: 0px; display: block; line-height: 1; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }
    .box-btn .badge-exp { position: absolute; top: -5px; right: -5px; font-size: 9px; padding: 2px 4px; border-radius: 4px; background: red; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; animation: blink 1s linear infinite; }
    .box-btn .badge-hist-count { position: absolute; top: -5px; right: -5px; font-size: 10px; padding: 2px 5px; border-radius: 10px; background: red; color: white; border:1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 10; font-weight:bold; }

    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
    .drug-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; display: flex; flex-direction: column; position: relative; }
    .drug-img-wrap { width: 100%; aspect-ratio: 1/1; background: #e0e0e0; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #f8f8f8; padding: 5px; }
    .drug-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .drug-info { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; background: white; }

    .shelf-row-label { font-weight: bold; margin: 10px 0; padding-left: 10px; border-left: 4px solid var(--primary); color: #333; width: 100%; border-bottom: 2px solid #555; padding-bottom: 5px; }
    .shelf-item { position: relative; border:1px solid #eee; border-radius:8px; padding:5px; text-align:center; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.08); width: 31%; max-width: 130px; margin-bottom: 5px; }
    .shelf-item img { width: 90px; height: 90px; object-fit: cover; border-radius: 6px; margin-bottom: 5px; background: #e0e0e0; }
    .bg-ha { background-color: var(--ha-color); border: 1px solid red; }
    .bg-cool { background-color: var(--cool-color); border: 1px solid #2196f3; }
    .exp-badge-stock { position: absolute; top: 0; right: 0; font-size: 10px; padding: 2px 4px; border-radius: 0 8px 0 4px; color: white; font-weight: bold; z-index: 5; }
    .badge-ha { position: absolute; top: 0; left: 0; background: red; color: white; font-size: 10px; padding: 2px 4px; border-bottom-right-radius: 8px; font-weight: bold; z-index: 5; }

    .btm-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 55px; background: var(--primary); display: flex; justify-content: space-around; align-items: flex-end; z-index: 1000; padding-bottom: 2px; }
    .nav-item { text-align: center; color: rgba(255,255,255,0.6); font-size: 0.7rem; width: 25%; cursor: pointer; transition: 0.2s; padding-bottom: 4px; }
    .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 0; }
    .nav-item.active { color: white; font-weight: 600; }
    .nav-badge { position: absolute; top: 5px; right: 20px; background: red; color: white; border-radius: 50%; width: 10px; height: 10px; }
    
    .fab-print { position: fixed; bottom: 70px; left: 15px; background: #333; color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    .fab-edit-lg { position: fixed; bottom: 70px; right: 15px; background: var(--primary); color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    
    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 32px; height: 32px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; user-select: none; }
    .btn-qty:active { background: #eee; }
    .inp-qty { width: 40px; border: none; background: transparent; text-align: center; font-weight: bold; font-size: 1.1rem; }

    /* New Features CSS */
    .timeline { display: flex; justify-content: space-between; position: relative; margin: 15px 0; }
    .timeline::before { content: ''; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: #ddd; z-index: 0; }
    .tl-step { position: relative; z-index: 1; text-align: center; background: white; padding: 0 5px; }
    .tl-icon { width: 30px; height: 30px; border-radius: 50%; background: #eee; color: #aaa; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-size: 0.8rem; border: 2px solid #ddd; }
    .tl-step.active .tl-icon { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
    .tl-time { font-size: 0.7rem; color: #666; margin-top: 2px; }

    .fab-qr { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: #333; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; font-size: 1.8rem; cursor: pointer; border: 3px solid white; }
    #qr-overlay { position: fixed; inset: 0; background: black; z-index: 3000; display: none; flex-direction: column; }
    #reader { width: 100%; flex-grow: 1; background: black; }
    .scan-ctrl { padding: 20px; background: rgba(0,0,0,0.8); text-align: center; }
    
    .nav-tabs .nav-link { color: #666; font-size: 0.9rem; }
    .nav-tabs .nav-link.active { color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }
    .tab-badge { background: #eee; color: #333; border-radius: 10px; padding: 2px 6px; font-size: 10px; margin-left: 5px; }
    .nav-link.active .tab-badge { background: var(--primary); color: white; }
    
    .card-wait { background-color: #fffde7; border-left: 4px solid #fbc02d; }
    .card-done { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
    .card-recv { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
    
    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; }
    .badge-expired { background: red; color: white; border-radius: 4px; padding: 2px 4px; font-weight: bold; animation: blink 1s linear infinite; }
    .badge-near-exp { background: #ffc107; color: black; border-radius: 4px; padding: 2px 4px; font-weight: bold; }
  </style>
</head>
<body>

  <div id="login-overlay" style="position:fixed;inset:0;background:#f4f6f9;z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column;">
     <div style="font-size:3rem;color:var(--primary);margin-bottom:10px">ğŸ’Š</div>
     <h4 class="fw-bold">Sawee Rxfill 2.0</h4>
     <div class="spinner-border text-primary mt-3"></div>
  </div>

  <div id="qr-overlay">
     <div class="d-flex justify-content-between p-3 text-white align-items-center">
        <h5 class="m-0"><i class="fas fa-qrcode"></i> Scan Drug</h5>
        <button class="btn btn-sm btn-outline-light rounded-circle" onclick="stopScan()"><i class="fas fa-times"></i></button>
     </div>
     <div id="reader"></div>
     <div class="scan-ctrl">
        <div class="text-white small mb-2">à¸ªà¹ˆà¸­à¸‡ QR Code à¸—à¸µà¹ˆà¸à¸¥à¹ˆà¸­à¸‡à¸¢à¸²</div>
     </div>
  </div>

  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand">Sawee Rxfill 2.0</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini" onclick="openProfile()"><img id="nav-img" src="" referrerpolicy="no-referrer"><span id="nav-name">User</span></div>
         <div style="position:relative;padding:5px;" onclick="openStickerModal()">
            <i class="fas fa-print" style="font-size:1.3rem;"></i>
            <div id="badge-sticker" class="badge bg-warning text-dark rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
         <div style="position:relative;padding:5px;" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.3rem;"></i>
            <div id="badge" class="badge bg-danger rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:60px">
      <!-- TAB ORDER -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:50px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸²à¸¢à¸²à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡à¸™à¸µà¹‰..." onkeyup="filterOrder()">
        </div>
        <div style="position:relative;min-height:50vh">
            <div id="order-start-msg" class="text-message-start">à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¹ˆà¸­à¸‡à¸¢à¸²à¸”à¹‰à¸²à¸™à¸šà¸™à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸šà¸´à¸à¸¢à¸²</div>
            <div id="order-grid" class="drug-grid hidden"></div>
        </div>
      </div>

      <!-- TAB STOCK -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="group-filter" class="d-flex gap-2 px-3 pb-2 overflow-auto" style="white-space:nowrap"></div>
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5 px-3 d-flex flex-wrap gap-2 justify-content-start">
           <div class="text-message-large">à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¹ˆà¸­à¸‡à¸”à¹‰à¸²à¸™à¸šà¸™<br>à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸”à¸¹à¸ªà¸•à¹‡à¸­à¸à¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚</div>
        </div>
        <div class="fab-qr" onclick="startScan()"><i class="fas fa-qrcode"></i></div>
        <div id="fab-print" class="fab-print hidden" onclick="openPrintLabel()">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œà¹ƒà¸šà¹à¸›à¸°à¸à¸¥à¹ˆà¸­à¸‡</div>
        <div id="fab-edit" class="fab-edit-lg hidden" onclick="openBoxEditor()"><i class="fas fa-edit"></i> à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸¥à¹ˆà¸­à¸‡</div>
      </div>

      <!-- TAB SEARCH -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-primary mb-3">à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¢à¸²</h5>
         <div class="d-flex gap-2 mb-3 position-relative">
             <div class="input-group shadow-sm rounded-pill flex-grow-1">
                <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                <input id="kw-realtime" class="form-control border-0" placeholder="à¸à¸´à¸¡à¸à¹Œà¸Šà¸·à¹ˆà¸­à¸¢à¸²..." autocomplete="off">
             </div>
             <button class="btn btn-primary rounded-pill px-3" onclick="doFullSearch(document.getElementById('kw-realtime').value)">à¸„à¹‰à¸™à¸«à¸²</button>
             <div id="search-suggestions" class="hidden"></div>
         </div>
         
         <div class="d-flex gap-2 mb-3">
             <button class="btn btn-sm btn-outline-danger w-100 rounded-pill fw-bold" onclick="showExpiredDrugs()"><i class="fas fa-calendar-times"></i> à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</button>
         </div>

         <div class="d-flex justify-content-between align-items-center mb-2">
             <div id="search-count" class="small text-muted fw-bold"></div>
             <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="doFullSearch('SHOW_ALL')">à¹à¸ªà¸”à¸‡à¸¢à¸²à¸—à¸¸à¸à¸•à¸±à¸§</button>
         </div>

         <div id="search-spinner" class="text-center my-3 hidden"><div class="spinner-border text-primary"></div></div>
         
         <div id="realtime-detail" class="mt-2"></div>
         <div class="d-flex justify-content-center mt-3 gap-2 hidden" id="pagination-controls">
            <button class="btn btn-sm btn-light border" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
            <span id="page-display" class="small pt-1"></span>
            <button class="btn btn-sm btn-light border" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
         </div>

         <div class="fab-edit-lg" onclick="openMasterEdit({isNew:true})"><i class="fas fa-plus"></i> à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²à¹ƒà¸«à¸¡à¹ˆ</div>
      </div>

      <!-- TAB HIST -->
      <div id="tab-hist" class="page-sec hidden container pt-2">
         <div id="box-scroller-hist" class="box-scroller mb-2"></div>

         <ul class="nav nav-tabs nav-fill mb-3">
            <li class="nav-item"><a class="nav-link active" onclick="filterHist('à¸£à¸­à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²',this)">à¸£à¸­à¸ˆà¸±à¸”à¸¢à¸² <span id="bg-wait" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§',this)">à¸ˆà¸±à¸”à¹€à¸ªà¸£à¹‡à¸ˆ <span id="bg-done" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('à¹„à¸”à¹‰à¸£à¸±à¸šà¸¢à¸²à¹à¸¥à¹‰à¸§',this)">à¸£à¸±à¸šà¹à¸¥à¹‰à¸§ <span id="bg-recv" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('STATS',this)">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸šà¸´à¸</a></li>
         </ul>
         
         <div id="stats-filter" class="card p-3 mb-3 border-0 bg-light hidden">
             <div class="d-flex gap-2 align-items-center mb-2">
                 <input type="date" id="stat-start" class="form-control">
                 <span>à¸–à¸¶à¸‡</span>
                 <input type="date" id="stat-end" class="form-control">
             </div>
             <button class="btn btn-primary w-100 rounded-pill" onclick="loadStats()">à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
         </div>

         <div id="hist-msg" class="alert alert-info text-center small py-2 mb-2"></div>
         <div id="hist-loader" class="text-center my-4 hidden"><div class="spinner-border text-primary"></div> à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>à¹€à¸šà¸´à¸à¸¢à¸²</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>à¸ªà¸•à¹‡à¸­à¸</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>à¸„à¹‰à¸™à¸«à¸²</div>
    <div class="nav-item" style="position:relative" onclick="nav('tab-hist', this)">
        <i class="fas fa-history"></i>à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸šà¸´à¸
        <div id="nav-badge-hist" class="nav-badge-large hidden"></div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000">
    <div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸šà¸´à¸</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body d-flex flex-column p-0 bg-light">
        <div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div>
        <div class="p-3 bg-white shadow-lg mt-auto">
            <div class="d-flex justify-content-between fw-bold mb-2"><span>à¸£à¸§à¸¡à¸ªà¸¸à¸—à¸˜à¸´</span><span class="text-primary" id="cart-sum">0.00</span></div>
            <div class="border rounded p-2 mb-1 bg-white">
                <small class="text-muted d-block">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸šà¸´à¸:</small>
                <canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas>
                <div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvs()">à¸¥à¹‰à¸²à¸‡</small></div>
            </div>
            <div class="text-center text-primary fw-bold mb-3 small" id="cart-user-name"></div>
            <button id="btn-submit-order" onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¹€à¸šà¸´à¸</button>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlScanRes" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h6 class="m-0"><i class="fas fa-qrcode"></i> Scan Result</h6><button class="btn-close btn-close-white" onclick="restartScan()"></button></div>
            <div class="modal-body">
                <input type="hidden" id="qr-id">
                <div class="text-center mb-2"><img id="qr-img" src="" style="height:80px;border-radius:8px"></div>
                <h5 id="qr-name" class="fw-bold text-center"></h5>
                <div class="small text-muted text-center mb-3"><i class="fas fa-box"></i> <span id="qr-box"></span> | <i class="fas fa-map-marker-alt"></i> <input id="qr-loc" class="d-inline border-0 text-center" style="width:80px" placeholder="Loc"></div>
                <div class="row g-2 mb-3">
                    <div class="col-4"><label class="small">Max</label><input type="number" id="qr-amt" class="form-control form-control-sm text-center"></div>
                    <div class="col-4"><label class="small">Actual</label><input type="number" id="qr-act" class="form-control form-control-sm text-center border-success bg-success-subtle fw-bold"></div>
                    <div class="col-4"><label class="small">Exp</label><input type="date" id="qr-exp" class="form-control form-control-sm p-1"></div>
                </div>
                <button class="btn btn-success w-100 mb-2" onclick="saveQrEdit()">à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
                <div class="d-flex gap-2">
                    <input type="number" id="qr-print-qty" class="form-control text-center" value="1" style="width:70px">
                    <button class="btn btn-outline-secondary flex-grow-1" onclick="addQrToPool()">à¹€à¸à¸´à¹ˆà¸¡à¹€à¸‚à¹‰à¸²à¸„à¸´à¸§à¸à¸´à¸¡à¸à¹Œ</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary">à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</h5></div>
            <div class="modal-body p-4">
                <div class="text-center mb-3"><img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)"></div>
                <form id="form-reg">
                    <input id="reg-username" class="form-control mb-2" placeholder="Username *" required>
                    <input id="reg-name" class="form-control mb-2" placeholder="à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥ *" required>
                    <input id="reg-email" class="form-control mb-2" placeholder="Email">
                    <label class="small text-muted mt-2">Box Group (à¸•à¸¶à¸à¸—à¸µà¹ˆà¸ªà¸±à¸‡à¸à¸±à¸”)</label>
                    <select id="reg-group" class="form-select mb-2" multiple></select>
                    <div class="mb-3"><label class="small fw-bold text-muted">à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸šà¸´à¸</label><div class="p-2 border rounded bg-white" style="max-height:150px;overflow-y:auto" id="reg-substock-list">Loading...</div></div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</button>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlProfile"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div class="mb-2"><label class="small">Username</label><input id="pf-user" class="form-control"></div>
    <div class="mb-2"><label class="small">à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥</label><input id="pf-name" class="form-control"></div>
    <div class="mb-2"><label class="small">à¸ªà¸´à¸—à¸˜à¸´à¹Œ (Substock)</label><textarea id="pf-sub" class="form-control" rows="2"></textarea></div>
    <div class="mb-2"><label class="small">Password</label><input id="pf-pass" class="form-control"></div>
    <div class="mb-2"><label class="small">Email</label><input id="pf-email" class="form-control"></div>
    <button onclick="saveProfile()" class="btn btn-primary w-100 mt-2">à¸šà¸±à¸™à¸—à¸¶à¸</button>
  </div></div></div></div>

  <div class="modal fade" id="mdlBoxEdit" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸¥à¹ˆà¸­à¸‡à¸¢à¸²</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-light">
                <div class="card p-3 mb-3 border-0 shadow-sm">
                    <label class="small text-muted">à¸Šà¸·à¹ˆà¸­à¸à¸¥à¹ˆà¸­à¸‡</label><input id="edit-box-name" class="form-control fw-bold mb-2">
                    <label class="small text-muted">à¸£à¸¹à¸›à¸ à¸²à¸à¸à¸¥à¹ˆà¸­à¸‡</label>
                    <div class="d-flex gap-2">
                        <input type="file" id="inp-box-file" class="form-control" 
                               accept="image/*" 
                               onchange="uploadBoxImg(this)">
                        <input id="edit-box-img" type="hidden">
                        <img id="preview-box-img" src="" referrerpolicy="no-referrer" style="width:40px;height:40px;border-radius:4px;object-fit:cover;border:1px solid #ddd">
                    </div>
                    <button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveBoxInfo()">à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸¥à¹ˆà¸­à¸‡</button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold m-0">à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡</h6><button class="btn btn-sm btn-success rounded-pill" onclick="mdlAddItem.show()"><i class="fas fa-plus"></i> à¹€à¸à¸´à¹ˆà¸¡à¸¢à¸²</button></div>
                <div id="edit-box-items" class="row g-2"></div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="mdlMasterEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h6 class="fw-bold m-0">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¢à¸² (Master)</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="mst-isnew"><div class="mb-2"><label class="small">Item ID</label><input id="mst-id" class="form-control fw-bold"></div><div class="mb-2 text-center"><img id="mst-img-preview" src="" referrerpolicy="no-referrer" style="height:100px;border-radius:8px;background:transparent"><input type="file" class="form-control mt-2" accept="image/*" onchange="uploadMasterImg(this)"><input type="hidden" id="mst-img-path"></div><div class="mb-2"><label class="small">à¸Šà¸·à¹ˆà¸­à¸¢à¸²</label><input id="mst-name" class="form-control"></div><div class="row g-2 mb-2"><div class="col-6"><label class="small">Unit</label><input id="mst-unit" class="form-control"></div><div class="col-6"><label class="small">Price</label><input id="mst-price" type="number" class="form-control"></div></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-ha"><label class="form-check-label text-danger fw-bold">High Alert</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-pl"><label class="form-check-label text-warning fw-bold">Protect Light</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-kc"><label class="form-check-label text-info fw-bold">Keep Cool (2-8Â°C)</label></div><div class="d-flex gap-2 mt-3"><button class="btn btn-primary w-100" onclick="saveMasterItem()">à¸šà¸±à¸™à¸—à¸¶à¸</button><button class="btn btn-outline-dark w-100" onclick="openLabelEdit()">à¹à¸à¹‰à¹„à¸‚à¸‰à¸¥à¸²à¸</button></div></div></div></div></div>
  <div class="modal fade" id="mdlLabelEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-info text-white"><h6 class="fw-bold m-0">à¹à¸à¹‰à¹„à¸‚à¸‰à¸¥à¸²à¸à¸¢à¸²</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-2"><label class="small">à¸Šà¸·à¹ˆà¸­à¸¢à¸² (à¸šà¸™à¸‰à¸¥à¸²à¸)</label><input id="lbl-name" class="form-control"></div><div class="row g-2 mb-2"><div class="col-6"><label class="small">à¸›à¸£à¸´à¸¡à¸²à¸“</label><input id="lbl-amt" class="form-control"></div><div class="col-6"><label class="small">à¸«à¸™à¹ˆà¸§à¸¢</label><input id="lbl-unit" class="form-control"></div></div><div class="mb-2"><label class="small">à¸šà¸£à¸£à¸—à¸±à¸” 1</label><input id="lbl-l1" class="form-control"></div><div class="mb-2"><label class="small">à¸šà¸£à¸£à¸—à¸±à¸” 2</label><input id="lbl-l2" class="form-control"></div><div class="mb-2"><label class="small">à¸šà¸£à¸£à¸—à¸±à¸” 3</label><input id="lbl-l3" class="form-control"></div><div class="mb-2"><label class="small">à¸‚à¹‰à¸­à¸šà¹ˆà¸‡à¹ƒà¸Šà¹‰</label><input id="lbl-ind" class="form-control"></div><button class="btn btn-info w-100 mt-2 text-white" onclick="saveLabelInfo()">à¸šà¸±à¸™à¸—à¸¶à¸à¸‰à¸¥à¸²à¸</button></div></div></div></div>
  <div class="modal fade" id="mdlAddItem" style="z-index:2100"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">à¸„à¹‰à¸™à¸«à¸²à¸¢à¸²à¹€à¸à¸·à¹ˆà¸­à¹€à¸à¸´à¹ˆà¸¡à¹€à¸‚à¹‰à¸²à¸à¸¥à¹ˆà¸­à¸‡</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="search-master" class="form-control mb-2" placeholder="à¸à¸´à¸¡à¸à¹Œà¸Šà¸·à¹ˆà¸­à¸¢à¸²..." onkeyup="searchMasterDebounce()"><div id="master-res" class="list-group" style="max-height:250px;overflow-y:auto"></div></div></div></div></div>
  <div class="modal fade" id="mdlCheckOrder" style="z-index:2200"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><small class="text-muted d-block">à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸¢à¸² (à¹€à¸ à¸ªà¸±à¸Šà¸à¸£):</small><div id="check-user-name" class="fw-bold text-primary mb-2"></div><canvas id="cvs-check" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvsCheck()">à¸¥à¹‰à¸²à¸‡</small></div><button onclick="confirmCheckOrder()" class="btn btn-success w-100 mt-2 rounded-pill fw-bold">à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¸°à¸à¸´à¸¡à¸à¹Œà¹ƒà¸šà¸ˆà¸±à¸”à¸¢à¸²</button></div></div></div></div>
  <div class="modal fade" id="mdlSticker"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">Sticker Pool</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-pills nav-fill mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#pool-cart">à¸£à¸²à¸¢à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œ</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#pool-hist" onclick="loadPoolHist()">à¸›à¸£à¸°à¸§à¸±à¸•à¸´ (5 à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)</a></li></ul><div class="tab-content"><div id="pool-cart" class="tab-pane active"><div id="sticker-list" class="list-group mb-3"></div><button onclick="generateStickerPdf()" class="btn btn-warning w-100 text-dark fw-bold"><i class="fas fa-print"></i> à¸ªà¸£à¹‰à¸²à¸‡ PDF</button></div><div id="pool-hist" class="tab-pane"><div id="pool-list" class="list-group"></div></div></div></div></div></div></div>
  <div class="modal fade" id="mdlSignLabel" style="z-index:2200"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><small class="text-muted d-block">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¹€à¸ à¸ªà¸±à¸Šà¸à¸£:</small><canvas id="cvs-label" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-center my-2 text-primary" id="lbl-signer"></div><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvsLabel()">à¸¥à¹‰à¸²à¸‡</small></div><button onclick="submitLabel()" class="btn btn-success w-100 mt-2">à¸¢à¸·à¸™à¸¢à¸±à¸™ & à¸à¸´à¸¡à¸à¹Œà¹ƒà¸šà¹à¸›à¸°à¸à¸¥à¹ˆà¸­à¸‡</button><button id="btn-prev-label" class="btn btn-outline-secondary w-100 mt-2" style="display:none"></button></div></div></div></div>

  <div class="modal fade" id="mdlEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 shadow"><div class="modal-body text-center p-4"><input type="hidden" id="ed-id"><input type="hidden" id="ed-itemid"><h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6><div class="row g-2 mb-3"><div class="col-6"><label class="small text-muted">à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div><div class="col-6"><label class="small text-muted">à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</label><input type="date" id="ed-exp" class="form-control text-center" onchange="calcExpDays()"></div></div><div class="mt-2 text-center" id="ed-days-left"></div><div class="mt-2 small text-muted text-center">à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ <span id="ed-change" class="fw-bold">0</span> à¸„à¸£à¸±à¹‰à¸‡ (à¸¥à¹ˆà¸²à¸ªà¸¸à¸”: <span id="ed-time">-</span>)</div><button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-3">à¸šà¸±à¸™à¸—à¸¶à¸ (No Refresh)</button><div class="border-top mt-3 pt-3"><label class="small mb-1">à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œ</label><div class="d-flex gap-2"><div class="qty-wrap mx-auto" style="width:140px"><div class="btn-qty" onclick="adjStk(-1)">-</div><input id="stk-qty" type="number" class="inp-qty" value="1" readonly><div class="btn-qty" onclick="adjStk(1)">+</div></div><button class="btn btn-warning" onclick="addToStickerCartFromEdit()"><i class="fas fa-print"></i> à¸à¸´à¸¡à¸à¹Œà¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œ</button></div></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
Â  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
Â  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";Â 
Â  let liffId = "2008862022-cDOpEP9z";
Â  let currentUser = {}, items=[], cart=[], stickerCart=[], curBoxOrder='', curBoxStock='';
Â  let allBoxes = [], allHistory = [];
Â  let offC, mdlEdit, mdlReg, mdlBoxEdit, mdlAddItem, mdlMasterEdit, mdlProfile, mdlSignLabel, mdlSticker, mdlLabelEdit, mdlCheckOrder, mdlScanRes;
Â  let searchTimeout;
Â  let curPage = 1, totalPages = 1, totalSearchItems = 0;
Â  let curHistBox = 'ALL', curHistStatus = 'à¸£à¸­à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²';
Â  let tempCheckOrderId = '';
  let html5QrcodeScanner;
  let editTarget = null;

Â  async function callApi(action, payload = {}) {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(GAS_URL, { method: 'POST', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, ...payload }) });
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  try { return JSON.parse(text); } catch(e) { if(text.includes("Service is")) throw new Error("DEPLOYMENT_ERR"); throw new Error(text.substr(0,50)); }
Â  Â  Â  } catch(e) {
Â  Â  Â  Â  if(e.message=="DEPLOYMENT_ERR") Swal.fire('Error','Deploy à¸œà¸´à¸”à¸§à¸´à¸˜à¸µ! à¸•à¹‰à¸­à¸‡à¹€à¸¥à¸·à¸­à¸ Execute as Me / Anyone','error');
Â  Â  Â  Â  return { status: 'error', message: e.message };
Â  Â  Â  }
Â  }

Â  window.onload = async () => {
Â  Â  Â  offC = new bootstrap.Offcanvas('#cartSheet'); mdlEdit = new bootstrap.Modal('#mdlEdit'); mdlReg = new bootstrap.Modal('#mdlRegister');Â 
Â  Â  Â  mdlBoxEdit = new bootstrap.Modal('#mdlBoxEdit'); mdlAddItem = new bootstrap.Modal('#mdlAddItem'); mdlMasterEdit = new bootstrap.Modal('#mdlMasterEdit');Â 
Â  Â  Â  mdlProfile = new bootstrap.Modal('#mdlProfile'); mdlSignLabel = new bootstrap.Modal('#mdlSignLabel'); mdlSticker = new bootstrap.Modal('#mdlSticker');
Â  Â  Â  mdlLabelEdit = new bootstrap.Modal('#mdlLabelEdit'); mdlCheckOrder = new bootstrap.Modal('#mdlCheckOrder');
      mdlScanRes = new bootstrap.Modal('#mdlScanRes');

Â  Â  Â  const d = new Date();
Â  Â  Â  document.getElementById('stat-end').valueAsDate = d;
Â  Â  Â  d.setMonth(d.getMonth() - 1);
Â  Â  Â  document.getElementById('stat-start').valueAsDate = d;

Â  Â  Â  if(document.getElementById('form-reg')) document.getElementById('form-reg').onsubmit = async (e) => {Â 
Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  const subs = Array.from(document.querySelectorAll('.chk-sub:checked')).map(c=>c.value);Â 
          const grp = Array.from(document.getElementById('reg-group').selectedOptions).map(o=>o.value);
Â  Â  Â  Â  Â  if(!subs.length) return Swal.fire('à¹€à¸¥à¸·à¸­à¸à¸ªà¸´à¸—à¸˜à¸´à¹Œ');Â 
Â  Â  Â  Â  Â  Swal.showLoading();Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const res = await callApi('registerUser', {Â 
Â  Â  Â  Â  Â  Â  Â  username: document.getElementById('reg-username').value,Â 
Â  Â  Â  Â  Â  Â  Â  name: document.getElementById('reg-name').value,Â 
Â  Â  Â  Â  Â  Â  Â  email: document.getElementById('reg-email').value,Â 
Â  Â  Â  Â  Â  Â  Â  substock: subs,Â 
              boxGroup: grp,
Â  Â  Â  Â  Â  Â  Â  userId: currentUser.userId,Â 
Â  Â  Â  Â  Â  Â  Â  photo: currentUser.photoÂ 
Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if(res.status) {
Â  Â  Â  Â  Â  Â  Â  currentUser.username = document.getElementById('reg-username').value;
Â  Â  Â  Â  Â  Â  Â  currentUser.name = document.getElementById('reg-name').value;
Â  Â  Â  Â  Â  Â  Â  currentUser.email = document.getElementById('reg-email').value;
Â  Â  Â  Â  Â  Â  Â  currentUser.substock = subs;Â 
Â  Â  Â  Â  Â  Â  Â  mdlReg.hide();
Â  Â  Â  Â  Â  Â  Â  Swal.fire({icon:'success', title:'à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', timer:1500, showConfirmButton:false});
Â  Â  Â  Â  Â  Â  Â  startApp();Â 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Swal.fire('Error', res.message, 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  document.getElementById('kw-realtime').addEventListener('keyup', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => showSuggestions(e.target.value), 300); });
Â  Â  Â  initCvs(); initCvsLabel(); initCvsCheck();
Â  Â  Â Â 
Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  const boxIdParam = params.get('boxId');

Â  Â  Â  try { await liff.init({ liffId }); if(!liff.isLoggedIn()) liff.login(); else { const profile = await liff.getProfile(); currentUser.photo = profile.pictureUrl; checkUser(profile.userId, boxIdParam); } } catch(e) { document.getElementById('status-text').innerHTML = `<span class="text-danger">${e.message}</span>`; }
Â  };

Â  async function checkUser(uid, boxParam) {
Â  Â  Â  const res = await callApi('checkUserLIFF', { userId: uid });
Â  Â  Â  if (res.status === 'NOT_FOUND') {Â 
Â  Â  Â  Â  Â  currentUser.userId = uid;Â 
Â  Â  Â  Â  Â  const opts = await callApi('getRegOptions');
Â  Â  Â  Â  Â  if(opts.status) {
Â  Â  Â  Â  Â  Â  Â const list = document.getElementById('reg-substock-list');
Â  Â  Â  Â  Â  Â  Â list.innerHTML = opts.options.map(o => `<div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="${o}"><label>${o}</label></div>`).join('');
             const grpSel = document.getElementById('reg-group');
             grpSel.innerHTML = opts.groups.map(g=>`<option value="${g}">${g}</option>`).join('');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  document.getElementById('login-overlay').classList.add('hidden');Â 
Â  Â  Â  Â  Â  document.getElementById('reg-img').src = currentUser.photo || DEFAULT_IMG;Â 
Â  Â  Â  Â  Â  mdlReg.show();Â 
Â  Â  Â  }
Â  Â  Â  else if (res.status === 'FOUND') { currentUser = { ...res.userData, userId: uid }; startApp(boxParam); }
Â  }

Â  function openProfile() {
Â  Â  Â  document.getElementById('pf-user').value = currentUser.username;
Â  Â  Â  document.getElementById('pf-name').value = currentUser.name;
Â  Â  Â  document.getElementById('pf-sub').value = currentUser.substock;
Â  Â  Â  document.getElementById('pf-pass').value = currentUser.password;
Â  Â  Â  document.getElementById('pf-email').value = currentUser.email;
Â  Â  Â  mdlProfile.show();
Â  }
Â  async function saveProfile() {
Â  Â  Â  const pl = { userId: currentUser.userId, username: document.getElementById('pf-user').value, name: document.getElementById('pf-name').value, substock: document.getElementById('pf-sub').value, password: document.getElementById('pf-pass').value, email: document.getElementById('pf-email').value };
Â  Â  Â  const res = await callApi('updateUserProfile', pl);
Â  Â  Â  if(res.status) location.reload(); else Swal.fire(res.message);
Â  }

Â  async function startApp(boxParam) {
Â  Â  Â  document.getElementById('login-overlay').classList.add('hidden'); document.getElementById('app-main').classList.remove('hidden');
Â  Â  Â  document.getElementById('nav-img').src = currentUser.photo || DEFAULT_IMG; document.getElementById('nav-name').innerText = currentUser.name.split(' ')[0];
Â  Â  Â Â 
Â  Â  Â  const resOrder = await callApi('getBoxes', { user: currentUser, showAll: false });
Â  Â  Â  if(resOrder.status) renderBoxScroller('order', resOrder.boxes);
Â  Â  Â  const resStock = await callApi('getBoxes', { user: currentUser, showAll: true });
Â  Â  Â  if(resStock.status) {Â 
Â  Â  Â  Â  Â  allBoxes = resStock.boxes;Â 
Â  Â  Â  Â  Â  renderBoxScroller('stock', allBoxes);Â 
Â  Â  Â  Â  Â  renderStockGroups(); // New function for badge counts
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  loadHist(true);Â 

Â  Â  Â  if(boxParam) {
Â  Â  Â  Â  Â  if(allBoxes.length) {
Â  Â  Â  Â  Â  Â  Â  const box = allBoxes.find(b=>b.id===boxParam);
Â  Â  Â  Â  Â  Â  Â  if(box) { nav('tab-stock', document.querySelectorAll('.nav-item')[1]); selBox(box.name, null, 'stock', box.imageRaw); }
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  }

Â  // --- NEW: Render Group Filters with Box Counts ---
Â  async function renderStockGroups() {
Â  Â  Â  const resGroups = await callApi('getBoxGroups');
Â  Â  Â  if(resGroups.status) {
Â  Â  Â  Â  Â  // Count boxes per group
Â  Â  Â  Â  Â  const counts = {};
Â  Â  Â  Â  Â  allBoxes.forEach(b => {
Â  Â  Â  Â  Â  Â  Â const g = b.group || 'Other';
Â  Â  Â  Â  Â  Â  Â counts[g] = (counts[g] || 0) + 1;
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  document.getElementById('group-filter').innerHTML =Â 
Â  Â  Â  Â  Â  Â  `<div class="badge rounded-pill bg-primary cursor-pointer p-2 d-flex align-items-center gap-2" onclick="filterStockBox('ALL',this)">
Â  Â  Â  Â  Â  Â  Â  Â  à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” <span class="badge bg-white text-dark rounded-circle">${allBoxes.length}</span>
Â  Â  Â  Â  Â  Â  Â </div>` +Â 
Â  Â  Â  Â  Â  Â  resGroups.groups.map(g => {
Â  Â  Â  Â  Â  Â  Â  Â  const count = counts[g] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="badge rounded-pill bg-white text-dark border cursor-pointer p-2 d-flex align-items-center gap-2" onclick="filterStockBox('${g}',this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${g} <span class="badge bg-secondary rounded-circle">${count}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  }
Â  }

Â  function getBoxIcon(type) {
Â  Â  Â  const t = (type || "").toLowerCase();
Â  Â  Â  if(t.includes('cart') || t.includes('à¸£à¸–')) return 'ğŸ›’';
Â  Â  Â  if(t.includes('fridge') || t.includes('à¹€à¸¢à¹‡à¸™')) return 'ğŸ§Š';
Â  Â  Â  if(t.includes('carbinet') || t.includes('cabinet') || t.includes('à¸•à¸¹à¹‰')) return 'ğŸ—„ï¸';
Â  Â  Â  return 'ğŸ“¦';
Â  }

Â  function renderBoxScroller(mode, boxes) {
Â  Â  Â  const el = document.getElementById(`box-scroller-${mode}`);
Â  Â  Â  el.innerHTML = boxes.map(b=>`
Â  Â  Â  Â  <div class="box-btn" onclick="selBox('${b.name}', this, '${mode}', '${b.imageRaw}')">
Â  Â  Â  Â  Â  <span class="box-icon">${getBoxIcon(b.type)}</span>
Â  Â  Â  Â  Â  <span style="font-size:0.75rem;line-height:1.1;font-weight:600">${b.name}</span>
Â  Â  Â  Â  Â  ${b.hasExpired ? '<span class="badge-exp">à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</span>' : ''}
Â  Â  Â  Â  Â  ${mode === 'hist' ? `<span class="badge-hist-count">${b.count||0}</span>` : ''}
Â  Â  Â  Â  </div>`).join('');
Â  }

Â  function filterStockBox(group, el) {
Â  Â  Â  const p = el.parentElement;Â 
Â  Â  Â  // Reset all buttons style
Â  Â  Â  Array.from(p.children).forEach(x=> {Â 
Â  Â  Â  Â  Â  x.classList.remove('bg-primary','text-white');Â 
Â  Â  Â  Â  Â  x.classList.add('bg-white','text-dark');Â 
Â  Â  Â  Â  Â  // Reset badge inside
Â  Â  Â  Â  Â  const badge = x.querySelector('.badge');
Â  Â  Â  Â  Â  if(badge) { badge.classList.remove('bg-white', 'text-dark'); badge.classList.add('bg-secondary'); }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Active button style
Â  Â  Â  el.classList.remove('bg-white','text-dark');Â 
Â  Â  Â  el.classList.add('bg-primary','text-white');
Â  Â  Â  const activeBadge = el.querySelector('.badge');
Â  Â  Â  if(activeBadge) { activeBadge.classList.remove('bg-secondary'); activeBadge.classList.add('bg-white', 'text-dark'); }

Â  Â  Â  const filtered = (group==='ALL') ? allBoxes : allBoxes.filter(b=>b.group===group);
Â  Â  Â  renderBoxScroller('stock', filtered);
Â  }

Â  function nav(pid, el){
Â  Â  Â  document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden')); document.getElementById(pid).classList.remove('hidden');
Â  Â  Â  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active');
Â  Â  Â  if(pid === 'tab-hist') {
Â  Â  Â  Â  Â  loadHist();
Â  Â  Â  }
Â  }

Â  async function selBox(name, el, mode, imgRaw) {
Â  Â  Â  document.querySelectorAll(`#box-scroller-${mode} .box-btn`).forEach(x=>x.classList.remove('active'));Â 
Â  Â  Â  if(el) el.classList.add('active');
Â  Â  Â Â 
Â  Â  Â  if(mode==='order') {
Â  Â  Â  Â  Â if(cart.length && curBoxOrder!=name && !confirm('à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸à¸¥à¹ˆà¸­à¸‡ à¸•à¸°à¸à¸£à¹‰à¸²à¸ˆà¸°à¸–à¸¹à¸à¸¥à¹‰à¸²à¸‡?')) return;
Â  Â  Â  Â  Â if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
Â  Â  Â  Â  Â curBoxOrder = name; loadOrderItems(name);
Â  Â  Â  } else if (mode === 'hist') {
Â  Â  Â  Â  Â curHistBox = name;
Â  Â  Â  Â  Â renderHist(curHistStatus); // Refresh logic to update counts
Â  Â  Â  } else {
Â  Â  Â  Â  Â curBoxStock = name;
Â  Â  Â  Â  Â document.getElementById('fab-edit').classList.remove('hidden');
Â  Â  Â  Â  Â document.getElementById('fab-print').classList.remove('hidden');
Â  Â  Â  Â  Â document.getElementById('edit-box-name').value = name;
Â  Â  Â  Â  Â document.getElementById('edit-box-img').value = imgRaw;
Â  Â  Â  Â  Â document.getElementById('preview-box-img').src = DEFAULT_IMG;
Â  Â  Â  Â  Â if(imgRaw) callApi('resolveImage',{input:imgRaw}).then(r=>{if(r.status) document.getElementById('preview-box-img').src=r.src});
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â const boxObj = allBoxes.find(b=>b.name === name);
Â  Â  Â  Â  Â const prevBtn = document.getElementById('btn-prev-label');
Â  Â  Â  Â  Â if(boxObj && boxObj.lastPdf) {
Â  Â  Â  Â  Â  Â  prevBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  prevBtn.onclick = () => window.open(boxObj.lastPdf, '_blank');
Â  Â  Â  Â  Â  Â  prevBtn.innerHTML = `à¹ƒà¸šà¹à¸›à¸°à¸à¸¥à¹ˆà¸­à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸² (à¸¥à¹ˆà¸²à¸ªà¸¸à¸” ${boxObj.lastCheck || '-'})`;
Â  Â  Â  Â  Â } else { prevBtn.style.display = 'none'; }

Â  Â  Â  Â  Â loadStockItems(name);
Â  Â  Â  }
Â  }

Â  async function loadOrderItems(box) {
Â  Â  Â  document.getElementById('order-start-msg').classList.add('hidden');
Â  Â  Â  document.getElementById('order-grid').classList.remove('hidden');
Â  Â  Â  document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-2"></div>').join('');
Â  Â  Â  const res = await callApi('getItems', { boxName: box });
Â  Â  Â  items = res.status ? res.data.map(x=>({...x, req:1})) : [];
Â  Â  Â  renderOrder();
Â  }
Â Â 
Â  async function loadStockItems(box) {
Â  Â  Â  const el = document.getElementById('stock-content'); el.innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
Â  Â  Â  const res = await callApi('getItems', { boxName: box });
Â  Â  Â  if(!res.status) return el.innerHTML = 'Error';
Â  Â  Â Â 
Â  Â  Â  let totalChanges = 0;
Â  Â  Â  let lastCheck = '-';
Â  Â  Â  const boxObj = allBoxes.find(b=>b.name === box);
Â  Â  Â  if(boxObj) { lastCheck = boxObj.lastCheck; }
Â  Â  Â  res.data.forEach(i => totalChanges += (i.changeCount || 0));

Â  Â  Â  let h = `<div class="h5 fw-bold text-dark mb-1 w-100 d-flex align-items-center gap-2"><i class="fas fa-box"></i> ${box} <span class="badge bg-info rounded-pill" style="font-size:0.7rem">${res.data.length} à¸¢à¸²</span></div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="small text-muted mb-3 border-bottom pb-2 w-100">à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡: ${totalChanges} | à¸•à¸£à¸§à¸ˆà¸¥à¹ˆà¸²à¸ªà¸¸à¸”: ${lastCheck}</div>`;
Â  Â  Â Â 
Â  Â  Â  let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
Â  Â  Â  Object.keys(rows).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true})).forEach(r=>{
Â  Â  Â  Â  Â  h+=`<div class="shelf-row-label">à¸Šà¸±à¹‰à¸™/à¹à¸–à¸§: ${r}</div><div class="d-flex flex-wrap gap-2 mt-2 w-100">`;
Â  Â  Â  Â  Â  h+=rows[r].map(i=> {
Â  Â  Â  Â  Â  Â let cls = i.highAlert ? 'bg-ha' : (i.keepCool ? 'bg-cool' : '');
Â  Â  Â  Â  Â  Â let icon = i.protectLight ? '<i class="fas fa-sun icon-protect"></i>' : '';
Â  Â  Â  Â  Â  Â let expTag = '';
Â  Â  Â  Â  Â  Â let expiredClass = '';
Â  Â  Â  Â  Â  Â if(i.expire) {
Â  Â  Â  Â  Â  Â  Â  const diff = (new Date(i.expire) - new Date())/(1000*3600*24);
Â  Â  Â  Â  Â  Â  Â  if(diff < 0) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  expTag = '<span class="exp-badge-stock badge-expired">à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</span>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  expiredClass = 'border border-danger';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  else if(diff < 180) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  expTag = `<span class="exp-badge-stock badge-near-exp">${Math.ceil(diff)} à¸§à¸±à¸™</span>`;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â let haBadge = i.highAlert ? '<div class="badge-ha">HAD</div>' : '';
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â return `<div id="stk-${i.invId}" class="shelf-item ${cls} ${expiredClass}" style="width:31%;max-width:130px;" onclick="editStk('${i.invId}','${i.name}','${i.itemId}',${i.amount},'${i.expire}',${i.changeCount},'${i.lastChange}')">${haBadge}${expTag}<img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer"><div class="small text-truncate fw-bold" style="font-size:0.75rem">${i.name}</div><div class="d-flex justify-content-between align-items-center mt-1"><span class="badge bg-secondary qty-val">${i.amount}</span><span class="text-muted exp-val" style="font-size:9px">${i.expire || '-'} ${icon}</span></div></div>`
Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  h+='</div>';
Â  Â  Â  });
Â  Â  Â  el.innerHTML = h || '<div class="text-center mt-5 text-muted">à¸à¸¥à¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡</div>';
Â  Â  Â Â 
Â  Â  Â  const editHtml = res.data.map(i=>`<div class="col-12 d-flex align-items-center bg-white border p-2 rounded mb-1"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer" style="width:40px;height:40px;object-fit:cover;border-radius:4px;background:transparent"><div class="flex-grow-1 ms-2 small"><div class="fw-bold text-truncate">${i.name}</div><div class="d-flex gap-2 align-items-center mt-1"><input class="form-control form-control-sm" style="width:70px" type="number" value="${i.amount}" onchange="updateInv('${i.invId}', 'amount', this.value)" placeholder="Qty"><input class="form-control form-control-sm" style="width:120px" value="${i.location}" onchange="updateInv('${i.invId}', 'location', this.value)" placeholder="Loc"></div></div><button class="btn btn-sm btn-outline-danger ms-2" onclick="removeBoxItem('${i.invId}')"><i class="fas fa-trash"></i></button></div>`).join('');
Â  Â  Â  document.getElementById('edit-box-items').innerHTML = editHtml;
Â  Â  Â  lazyLoad();
Â  }

Â  async function updateInv(id, field, val) { let pl = {invId:id}; pl[field]=val; await callApi('updateInventoryDetail', pl); }

Â  function renderOrder() {
Â  Â  Â  const grid = document.getElementById('order-grid');
Â  Â  Â  grid.innerHTML = '';
Â  Â  Â  const kw = document.getElementById('order-search').value.toLowerCase();
Â  Â  Â  const filtered = items.filter(i=>i.name.toLowerCase().includes(kw));
Â  Â  Â Â 
Â  Â  Â  if(filtered.length === 0) {
Â  Â  Â  Â  Â  grid.innerHTML = '<div class="text-center mt-5 text-muted w-100">à¹„à¸¡à¹ˆà¸à¸šà¸¢à¸²</div>';
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let idx = 0;
Â  Â  Â  const chunk = 20;
Â  Â  Â  function nextChunk() {
Â  Â  Â  Â  Â  const slice = filtered.slice(idx, idx + chunk);
Â  Â  Â  Â  Â  if (slice.length === 0) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const html = slice.map(i=>`
Â  Â  Â  Â  Â  Â  <div class="drug-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="drug-img-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy" referrerpolicy="no-referrer">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="drug-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="drug-name">${i.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex justify-content-between small text-muted mb-2">
                        <span>${i.amount} x ${i.masterUnit}</span>
                        <span class="text-primary fw-bold">${i.price} à¸š.</span>
                    </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="qty-wrap"><div class="btn-qty" onclick="adj('${i.itemId}',-1)">-</div><input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly><div class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">à¹ƒà¸ªà¹ˆà¸•à¸°à¸à¸£à¹‰à¸²</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>`).join('');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  grid.insertAdjacentHTML('beforeend', html);
Â  Â  Â  Â  Â  idx += chunk;
Â  Â  Â  Â  Â  lazyLoad();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if(idx < filtered.length) {
Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(nextChunk);
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  nextChunk();
Â  }

Â  // --- Sticker Pool Logic ---
Â  function openStickerModal() {
Â  Â  Â  const list = document.getElementById('sticker-list');
Â  Â  Â  if(stickerCart.length === 0) list.innerHTML = '<div class="text-center p-3 text-muted">à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œ</div>';
Â  Â  Â  else {
Â  Â  Â  Â  list.innerHTML = stickerCart.map((s,i) => `
Â  Â  Â  Â  Â  <div class="list-group-item d-flex justify-content-between align-items-center">
Â  Â  Â  Â  Â  Â  Â  <div>${s.name} <span class="badge bg-secondary">x${s.qty}</span></div>
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash text-danger cursor-pointer" onclick="stickerCart.splice(${i},1); updateStickerBadge(); openStickerModal()"></i>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `).join('');
Â  Â  Â  }
Â  Â  Â  mdlSticker.show();
Â  }
Â Â 
Â  function adjStk(n) {
Â  Â  Â  let el = document.getElementById('stk-qty');
Â  Â  Â  let v = parseInt(el.value) || 1;
Â  Â  Â  v += n;
Â  Â  Â  if(v < 1) v = 1;
Â  Â  Â  el.value = v;
Â  }

Â  function addToStickerCartFromEdit() {
Â  Â  Â  const id = document.getElementById('ed-itemid').value;
Â  Â  Â  const name = document.getElementById('ed-name').innerText;
Â  Â  Â  const exp = document.getElementById('ed-exp').value;Â 
Â  Â  Â  const qty = document.getElementById('stk-qty').value;
Â  Â  Â  if(!qty || qty <= 0) return Swal.fire('à¸£à¸°à¸šà¸¸à¸ˆà¸³à¸™à¸§à¸™');
Â  Â  Â Â 
Â  Â  Â  stickerCart.push({ itemId: id, name: name, qty: qty, expire: exp });
Â  Â  Â  updateStickerBadge();
Â  Â  Â  Swal.fire({icon:'success', title:'à¹€à¸à¸´à¹ˆà¸¡à¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œà¹à¸¥à¹‰à¸§', timer:1000, showConfirmButton:false});
Â  }

Â  function updateStickerBadge() {
Â  Â  Â  const b = document.getElementById('badge-sticker');
Â  Â  Â  const total = stickerCart.reduce((s,i) => s + Number(i.qty), 0);
Â  Â  Â  b.innerText = total;
Â  Â  Â  if(total > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
Â  }

Â  async function generateStickerPdf() {
Â  Â  Â  if(stickerCart.length === 0) return;
Â  Â  Â  Swal.fire({title:'Generating PDF...', didOpen:()=>Swal.showLoading()});
Â  Â  Â  let expandList = [];
Â  Â  Â  stickerCart.forEach(s => {
Â  Â  Â  Â  Â  for(let i=0; i<s.qty; i++) expandList.push({ itemId: s.itemId, name: s.name, expire: s.expire });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  const res = await callApi('generateLabelPdf', { items: expandList, user: currentUser.name });
Â  Â  Â  if(res.status) {
Â  Â  Â  Â  Â  stickerCart = []; updateStickerBadge(); mdlSticker.hide();
Â  Â  Â  Â  Â  Swal.fire({ icon:'success', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary w-100">à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸‰à¸¥à¸²à¸</a>` });
Â  Â  Â  } else Swal.fire('Error', res.message, 'error');
Â  }

Â  // --- Sticker Pool History (Updated Logic) ---
Â  async function loadPoolHist() {
Â  Â  Â  document.getElementById('pool-list').innerHTML = 'Loading...';
Â  Â  Â  const res = await callApi('getStickerPools');
Â  Â  Â  if(res.status && res.data) {
Â  Â  Â  Â  Â  document.getElementById('pool-list').innerHTML = res.data.map((s) => {
Â  Â  Â  Â  Â  Â  Â // Only show 'Printed' if status is Printed, else show Blank/Pending
Â  Â  Â  Â  Â  Â  Â const statusBadge = s.status === 'Printed' ? '<span class="badge bg-success">Printed</span>' : '<span class="badge bg-secondary">Pending</span>';
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â return `<div class="list-group-item"><div class="d-flex justify-content-between align-items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <div><div class="fw-bold small text-truncate" style="max-width:150px">${s.id}</div><div class="small text-muted">${s.time} by ${s.admin}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex gap-2 align-items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusBadge}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-outline-dark" onclick="printPoolPdf(${s.row}, '${s.pdf}')"><i class="fas fa-print"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â </div></div>`;
Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  }
Â  }

Â  async function printPoolPdf(row, pdfUrl) {
Â  Â  Â  window.open(pdfUrl, '_blank');
Â  Â  Â  // Update status to Printed in background
Â  Â  Â  await callApi('updateStickerPoolStatus', { row, adminName: currentUser.name });
Â  Â  Â  loadPoolHist(); // Refresh list
Â  }

Â  async function showSuggestions(kw) {
Â  Â  Â  if(!kw || kw.length < 2) {
Â  Â  Â  Â  Â  document.getElementById('search-suggestions').innerHTML = '';
Â  Â  Â  Â  Â  document.getElementById('search-suggestions').classList.add('hidden');
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const res = await callApi('searchMasterItems', { kw });
Â  Â  Â  if(res.data && res.data.length > 0) {
Â  Â  Â  Â  Â  const html = res.data.map(i =>Â 
Â  Â  Â  Â  Â  Â  Â  `<div class="p-2 border-bottom cursor-pointer hover-bg-light" onclick="doFullSearch('${i.name}'); document.getElementById('kw-realtime').value='${i.name}';">
Â  Â  Â  Â  Â  Â  Â  Â  Â <i class="fas fa-search text-muted me-2"></i> ${i.name}
Â  Â  Â  Â  Â  Â  Â  </div>`
Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  document.getElementById('search-suggestions').innerHTML = html;
Â  Â  Â  Â  Â  document.getElementById('search-suggestions').classList.remove('hidden');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  document.getElementById('search-suggestions').classList.add('hidden');
Â  Â  Â  }
Â  }

Â  async function doFullSearch(kw, page=1) {
Â  Â  Â  document.getElementById('search-suggestions').classList.add('hidden');
Â  Â  Â  if(!kw) return;
Â  Â  Â Â 
Â  Â  Â  curPage = page;
Â  Â  Â  document.getElementById('search-spinner').classList.remove('hidden');
Â  Â  Â  document.getElementById('realtime-detail').innerHTML = '';
Â  Â  Â Â 
Â  Â  Â  const res = await callApi('searchDrugDetails', { kw: kw, page: page });
Â  Â  Â  document.getElementById('search-spinner').classList.add('hidden');

Â  Â  Â  if(res.status) {
Â  Â  Â  Â  Â totalPages = res.data.totalPages;
Â  Â  Â  Â  Â totalSearchItems = res.data.totalItems;
Â  Â  Â  Â  Â document.getElementById('search-count').innerText = `à¸à¸š ${totalSearchItems} à¸£à¸²à¸¢à¸à¸²à¸£`;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â if(totalSearchItems === 0) {
Â  Â  Â  Â  Â  Â  Â document.getElementById('realtime-detail').innerHTML = '<div class="alert alert-warning text-center">à¹„à¸¡à¹ˆà¸à¸šà¸¢à¸²à¸ªà¸•à¹‡à¸­à¸</div>';
Â  Â  Â  Â  Â  Â  Â document.getElementById('pagination-controls').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â if(kw === 'SHOW_ALL') {
Â  Â  Â  Â  Â  Â  document.getElementById('pagination-controls').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('page-display').innerText = `à¸«à¸™à¹‰à¸² ${curPage} / ${totalPages}`;
Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  document.getElementById('pagination-controls').classList.add('hidden');
Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â document.getElementById('realtime-detail').innerHTML = res.data.results.map(d => {
Â  Â  Â  Â  Â  Â let rows = d.locations.map(l => {
Â  Â  Â  Â  Â  Â  Â  Â let cls = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â let badge = '';
Â  Â  Â  Â  Â  Â  Â  Â if(l.isExpired) { cls = 'row-expired'; badge = '<span class="badge-expired ms-1">à¸¢à¸²à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</span>'; }
Â  Â  Â  Â  Â  Â  Â  Â else if(l.isNearExp) { badge = `<span class="badge-near-exp ms-1">${l.daysLeft} à¸§à¸±à¸™</span>`; }
Â  Â  Â  Â  Â  Â  Â  Â return `<tr class="${cls}"><td>${l.box}</td><td>${l.amount}</td><td>${l.expire}${badge}</td></tr>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  return `<div class="mb-3 border rounded shadow-sm p-3 bg-white fade-in">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="drug-img-wrap" style="width:80px;height:80px;flex-shrink:0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${DEFAULT_IMG}" data-raw="${d.imageRaw}" class="drug-img lazy" referrerpolicy="no-referrer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="fw-bold text-primary">${d.name} <span class="badge bg-info text-dark">à¸£à¸§à¸¡ ${d.totalQty}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="small text-muted mb-1">ID: ${d.itemId}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <table class="table table-sm table-custom mb-0"><thead><tr><th>à¸à¸¥à¹ˆà¸­à¸‡</th><th>à¸ˆà¸™.</th><th>Exp</th></tr></thead><tbody>${rows}</tbody></table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex gap-2 mt-2 justify-content-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-outline-secondary" onclick='openMasterEdit(${JSON.stringify(d).replace(/'/g, "&apos;")})'><i class="fas fa-edit"></i> à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-outline-info" onclick="openLabelEdit('${d.itemId}')"><i class="fas fa-tag"></i> à¹à¸à¹‰à¹„à¸‚à¸‰à¸¥à¸²à¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â }).join('');
Â  Â  Â  Â  Â lazyLoad();
Â  Â  Â  }
Â  }
Â Â 
Â  function nextPage() { if(curPage < totalPages) doFullSearch('SHOW_ALL', curPage+1); }
Â  function prevPage() { if(curPage > 1) doFullSearch('SHOW_ALL', curPage-1); }

Â  function openMasterEdit(item) {
Â  Â  Â  document.getElementById('mst-isnew').value = item.isNew ? 'true' : 'false';
Â  Â  Â  document.getElementById('mst-id').value = item.itemId || ''; document.getElementById('mst-id').disabled = !item.isNew;
Â  Â  Â  document.getElementById('mst-name').value = item.name || ''; document.getElementById('mst-img-path').value = item.imageRaw || ''; document.getElementById('mst-unit').value = item.unit || ''; document.getElementById('mst-price').value = item.price || '';
Â  Â  Â  document.getElementById('mst-ha').checked = item.highAlert; document.getElementById('mst-pl').checked = item.protectLight; document.getElementById('mst-kc').checked = item.keepCool;
Â  Â  Â  const imgEl = document.getElementById('mst-img-preview'); imgEl.src = DEFAULT_IMG;
Â  Â  Â  if(item.imageRaw) callApi('resolveImage',{input:item.imageRaw}).then(r=>{if(r.status) imgEl.src=r.src});
Â  Â  Â  mdlMasterEdit.show();
Â  }

Â  // --- LABEL EDIT ---
Â  async function openLabelEdit(itemId) {
Â  Â  Â  const res = await callApi('getLabelInfo', { itemId });
Â  Â  Â  let data = { itemId };
Â  Â  Â  if(res.status && res.data) data = res.data;
Â  Â  Â  document.getElementById('lbl-name').value = data.name || '';
Â  Â  Â  document.getElementById('lbl-amt').value = data.amount || '';
Â  Â  Â  document.getElementById('lbl-unit').value = data.unit || '';
Â  Â  Â  document.getElementById('lbl-l1').value = data.l1 || '';
Â  Â  Â  document.getElementById('lbl-l2').value = data.l2 || '';
Â  Â  Â  document.getElementById('lbl-l3').value = data.l3 || '';
Â  Â  Â  document.getElementById('lbl-ind').value = data.ind || '';
Â  Â  Â  window.currentLabelItemId = itemId;
Â  Â  Â  mdlLabelEdit.show();
Â  }
Â Â 
Â  async function saveLabelInfo() {
Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  itemId: window.currentLabelItemId,
Â  Â  Â  Â  Â  name: document.getElementById('lbl-name').value,
Â  Â  Â  Â  Â  amount: document.getElementById('lbl-amt').value,
Â  Â  Â  Â  Â  unit: document.getElementById('lbl-unit').value,
Â  Â  Â  Â  Â  l1: document.getElementById('lbl-l1').value,
Â  Â  Â  Â  Â  l2: document.getElementById('lbl-l2').value,
Â  Â  Â  Â  Â  l3: document.getElementById('lbl-l3').value,
Â  Â  Â  Â  Â  ind: document.getElementById('lbl-ind').value
Â  Â  Â  };
Â  Â  Â  const res = await callApi('updateLabelInfo', payload);
Â  Â  Â  if(res.status) { Swal.fire('Saved'); mdlLabelEdit.hide(); }
Â  }

Â  async function uploadMasterImg(input) {
Â  Â  Â  const file = input.files[0]; if(!file) return;
Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onload = async (e) => {
Â  Â  Â  Â  document.getElementById('mst-img-preview').src = e.target.result;
Â  Â  Â  Â  Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
Â  Â  Â  Â  const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'DRUG', name: file.name });
Â  Â  Â  Â  if(res.status) { document.getElementById('mst-img-path').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
Â  Â  Â  }; reader.readAsDataURL(file);
Â  }

Â  async function saveMasterItem() {
Â  Â  Â  const payload = { isNew: document.getElementById('mst-isnew').value==='true', itemId: document.getElementById('mst-id').value, name: document.getElementById('mst-name').value, image: document.getElementById('mst-img-path').value, unit: document.getElementById('mst-unit').value, price: document.getElementById('mst-price').value, highAlert: document.getElementById('mst-ha').checked, protectLight: document.getElementById('mst-pl').checked, keepCool: document.getElementById('mst-kc').checked };
Â  Â  Â  const res = await callApi('updateMasterItem', payload); if(res.status) { Swal.fire('Saved'); mdlMasterEdit.hide(); }
Â  }

Â  function openBoxEditor() { mdlBoxEdit.show(); }
Â  async function uploadBoxImg(input) {
Â  Â  Â  const file = input.files[0]; if(!file) return;
Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onload = async (e) => {
Â  Â  Â  Â  document.getElementById('preview-box-img').src = e.target.result;
Â  Â  Â  Â  Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
Â  Â  Â  Â  const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'BOX', name: file.name });
Â  Â  Â  Â  if(res.status) { document.getElementById('edit-box-img').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
Â  Â  Â  }; reader.readAsDataURL(file);
Â  }
Â  async function saveBoxInfo() {
Â  Â  Â  if(!confirm('à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸à¹‰à¹„à¸‚?')) return;
Â  Â  Â  const newN = document.getElementById('edit-box-name').value; const newI = document.getElementById('edit-box-img').value;
Â  Â  Â  const res = await callApi('updateBoxInfo', { oldName: curBoxStock, newName: newN, newImage: newI });
Â  Â  Â  if(res.status) { Swal.fire('Saved'); curBoxStock=newN; location.reload(); }
Â  }
Â  async function searchMasterDebounce() { clearTimeout(searchTimeout); searchTimeout = setTimeout(searchMaster, 500); }
Â  async function searchMaster() {
Â  Â  Â  const k = document.getElementById('search-master').value;Â 
Â  Â  Â  const res = await callApi('searchMasterItems', { kw: k || "" });
Â  Â  Â  if(res.data) {
Â  Â  Â  Â  document.getElementById('master-res').innerHTML = res.data.map(i=>`<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="addItemToBox('${i.id}')"><div class="d-flex align-items-center gap-2"><img src="${DEFAULT_IMG}" data-raw="${i.image}" class="lazy" referrerpolicy="no-referrer" style="width:30px;height:30px;border-radius:4px;object-fit:cover;background:#bebdbe"><span class="small">${i.name}</span></div><i class="fas fa-plus-circle text-success"></i></button>`).join('');
Â  Â  Â  Â  lazyLoad();
Â  Â  Â  }
Â  }
Â  async function addItemToBox(itemId) {Â 
Â  Â  Â  const amt = prompt('à¸£à¸°à¸šà¸¸à¸ˆà¸³à¸™à¸§à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™:', '1');Â 
Â  Â  Â  if(!amt) return;Â 
Â  Â  Â  const res = await callApi('addBoxItem', { boxName: curBoxStock, itemId, amount: amt });Â 
Â  Â  Â  if(res.status) { loadStockItems(curBoxStock); mdlAddItem.hide(); }Â 
Â  }
Â  async function removeBoxItem(invId) { if(!confirm('à¸¥à¸šà¸¢à¸²à¸™à¸µà¹‰?')) return; const res = await callApi('removeBoxItem', { invId }); if(res.status) loadStockItems(curBoxStock); }
Â  function adj(id, v, max) { let i = items.find(x=>x.itemId==id); if(!i) return; let n = i.req + v; if(n<1)n=1; if(max && n>max) { n=max; Swal.fire({toast:true,position:'center',icon:'warning',title:'à¹€à¸à¸´à¸™à¸ªà¸•à¹‡à¸­à¸'}); } i.req = n; document.getElementById(`qty-${id}`).value = n; }
Â  function addCart(id) { let i = items.find(x=>x.itemId==id); let ex = cart.find(x=>x.itemId==id); if(ex) { if(ex.qty+i.req > i.amount) return Swal.fire({toast:true,position:'center',icon:'warning',title:'à¹€à¸à¸´à¸™à¸ªà¸•à¹‡à¸­à¸'}); ex.qty+=i.req; } else cart.push({...i, qty:i.req}); badge(); const b=document.querySelector('.fa-shopping-basket'); b.style.transform='scale(1.4)'; setTimeout(()=>b.style.transform='scale(1)',200); i.req=1; document.getElementById(`qty-${id}`).value=1; }
Â  function badge() { let n=cart.length; document.getElementById('badge').innerText=n; n>0?document.getElementById('badge').classList.remove('hidden'):document.getElementById('badge').classList.add('hidden'); }
Â  function openCart(){ if(!cart.length) return Swal.fire('à¸•à¸°à¸à¸£à¹‰à¸²à¸§à¹ˆà¸²à¸‡'); renderCart(); offC.show(); setTimeout(fixCvs,500); }
Â  function renderCart(){Â 
Â  Â  Â  let sum=0; document.getElementById('cart-list').innerHTML=cart.map((c,i)=>{ sum+=c.price*c.qty; return `<div class="bg-white p-3 mb-2 rounded border position-relative"><div class="fw-bold pe-4">${c.name}</div><div class="d-flex justify-content-between mt-2 small text-muted"><span>${c.price} x ${c.qty}</span> <span class="text-primary fw-bold">${(c.price*c.qty).toFixed(2)} à¸š.</span></div><i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3 cursor-pointer" onclick="cart.splice(${i},1);renderCart();badge();if(!cart.length)offC.hide()"></i></div>`; }).join('');Â 
Â  Â  Â  document.getElementById('cart-sum').innerText = sum.toFixed(2);Â 
Â  Â  Â  document.getElementById('cart-user-name').innerText = currentUser.name || '';
Â  }
Â Â 
Â  async function submitOrder() {Â 
Â  Â  Â  if(isCanvasBlank(canvas)) return Swal.fire('à¸à¸£à¸¸à¸“à¸²à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­');Â 
Â  Â  Â  const btn = document.getElementById('btn-submit-order'); 
      btn.disabled=true;
Â  Â  Â Â 
      // Admin Auth for Order
      authAdmin(async (adminName) => {
          await callApi('submitOrder', { orderData: { user: currentUser.name, box: curBoxOrder, items: cart, signature: canvas.toDataURL() } });
          cart=[]; badge(); offC.hide(); clrCvs(); btn.disabled=false;
          loadHist();
          Swal.fire({
              icon:'success',
              title: 'à¸ªà¹ˆà¸‡à¹ƒà¸šà¹€à¸šà¸´à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢',
              text: 'à¹‚à¸›à¸£à¸”à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¹€à¸›à¸´à¸”à¸¢à¸²à¹„à¸”à¹‰à¸—à¸µà¹ˆ "à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸šà¸´à¸"',
              showConfirmButton: true
          });
      });
Â  }
Â Â 
Â  function editStk(id,n,itm,a,e,cnt,time) {Â 
      editTarget = document.getElementById(`stk-${id}`); // Save for no-refresh update
Â  Â  Â  document.getElementById('ed-id').value=id;Â 
Â  Â  Â  document.getElementById('ed-itemid').value=itm;Â 
Â  Â  Â  document.getElementById('ed-name').innerText=n;Â 
Â  Â  Â  document.getElementById('ed-amt').value=a;Â 
Â  Â  Â  document.getElementById('ed-exp').value=e;Â 
Â  Â  Â  document.getElementById('ed-change').innerText=cnt;
Â  Â  Â  document.getElementById('ed-time').innerText=time;Â 
Â  Â  Â  document.getElementById('stk-qty').value = 1; // Reset sticker qty
Â  Â  Â  calcExpDays();
Â  Â  Â  mdlEdit.show();Â 
Â  }
Â  function calcExpDays() {
Â  Â  Â  const exp = document.getElementById('ed-exp').value;
Â  Â  Â  if(!exp) return document.getElementById('ed-days-left').innerText = "";
Â  Â  Â  const diff = Math.ceil((new Date(exp) - new Date()) / (1000 * 60 * 60 * 24));
Â  Â  Â Â 
Â  Â  Â  let badge = '';
Â  Â  Â  if(diff < 0) badge = '<div class="badge-expired w-100 text-center mt-2">à¸¢à¸²à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸à¹à¸¥à¹‰à¸§</div>';
Â  Â  Â  else if(diff < 180) {
Â  Â  Â  Â  Â  // Updated: Show days remaining in modal
Â  Â  Â  Â  Â  badge = `<div class="badge-near-exp w-100 text-center mt-2">${Math.ceil(diff)} à¸§à¸±à¸™</div>`;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  document.getElementById('ed-days-left').innerHTML = `à¸­à¸µà¸ <span class="${diff<0?'text-danger fw-bold':''}">${diff}</span> à¸§à¸±à¸™à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ ${badge}`;
Â  }
  
  // Save Edit (No Refresh)
Â  async function saveEdit() { 
      const id = document.getElementById('ed-id').value;
      const amt = document.getElementById('ed-amt').value;
      const exp = document.getElementById('ed-exp').value;
      
      const pl = { invId:id, amount:amt, expire:exp }; 
      const res = await callApi('saveEditItem', pl); 
      if(res.status) { 
          mdlEdit.hide();
          // Optimistic Update
          if(editTarget) {
              editTarget.querySelector('.qty-val').innerText = amt;
              editTarget.querySelector('.exp-val').innerText = exp;
          }
          Swal.fire({toast:true, icon:'success', title:'à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§', timer:1500});
      } 
  }
Â Â 
Â  function loadHist(init = false) {Â 
Â  Â  Â  if(!init) document.getElementById('hist-loader').classList.remove('hidden');
Â  Â  Â Â 
Â  Â  Â  callApi('getHistory', {user:currentUser.name, substock:currentUser.substock}).then(res=>{Â 
Â  Â  Â  Â  Â  document.getElementById('hist-loader').classList.add('hidden');
Â  Â  Â  Â  Â  if(res.status) {Â 
Â  Â  Â  Â  Â  Â  Â  allHistory = res.data;Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // Count orders per box
Â  Â  Â  Â  Â  Â  Â  const boxCounts = allHistory.reduce((acc, r) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  acc[r.box] = (acc[r.box] || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  Â  Â  Â  }, {});

Â  Â  Â  Â  Â  Â  Â  // Get unique boxes from history for the carousel
Â  Â  Â  Â  Â  Â  Â  const histBoxes = [...new Set(allHistory.map(r => r.box))].sort();
Â  Â  Â  Â  Â  Â  Â  // Render History Box Scroller (Carousel)
Â  Â  Â  Â  Â  Â  Â  const scroller = document.getElementById('box-scroller-hist');
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const histScrollerHtml = `<div class="box-btn ${curHistBox === 'ALL' ? 'active' : ''}" onclick="selBox('ALL', this, 'hist', '')"><span class="box-icon">ğŸ“‹</span><span style="font-size:0.75rem;">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</span><span class="badge-hist-count">${allHistory.length}</span></div>` +Â 
Â  Â  Â  Â  Â  Â  Â  Â  histBoxes.map(bName => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const count = boxCounts[bName] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="box-btn ${curHistBox === bName ? 'active' : ''}" onclick="selBox('${bName}', this, 'hist', '')"><span class="box-icon">ğŸ“¦</span><span style="font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:70px">${bName}</span><span class="badge-hist-count">${count}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  scroller.innerHTML = histScrollerHtml;

Â  Â  Â  Â  Â  Â  Â  if (curHistStatus === 'STATS') loadStats();
Â  Â  Â  Â  Â  Â  Â  else renderHist(curHistStatus);Â 
Â  Â  Â  Â  Â  }Â 
Â  Â  Â  });Â 
Â  }
Â  function filterHist(status, el) {
Â  Â  Â  curHistStatus = status;
Â  Â  Â  document.querySelectorAll('.nav-tabs .nav-link').forEach(x=>x.classList.remove('active')); el.classList.add('active');
Â  Â  Â Â 
Â  Â  Â  // Hide/Show Box Scroller & Stats Filter
Â  Â  Â  const scroller = document.getElementById('box-scroller-hist');
Â  Â  Â  const statsFilter = document.getElementById('stats-filter');
Â  Â  Â Â 
Â  Â  Â  if(status === 'STATS') {
Â  Â  Â  Â  Â  scroller.classList.add('hidden'); statsFilter.classList.remove('hidden');
Â  Â  Â  Â  Â  loadStats();
Â  Â  Â  } else {
Â  Â  Â  Â  Â  scroller.classList.remove('hidden'); statsFilter.classList.add('hidden');
Â  Â  Â  Â  Â  renderHist(status);
Â  Â  Â  }
Â  }

Â  function renderHist(status) {
Â  Â  Â  // 1. Filter list by Status AND Selected Box FIRST
Â  Â  Â  let filtered = allHistory;
Â  Â  Â  if(curHistBox !== 'ALL') {
Â  Â  Â  Â  Â  filtered = filtered.filter(r => r.box === curHistBox);
Â  Â  Â  }

Â  Â  Â  // 2. Calculate Badges based on FILTERED BOX (Updated Requirement)
Â  Â  Â  const totalWait = filtered.filter(r => r.status.includes('à¸£à¸­')).length;
Â  Â  Â  const totalDone = filtered.filter(r => r.status.includes('à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆ')).length;
Â  Â  Â  const totalRecv = filtered.filter(r => r.status.includes('à¹„à¸”à¹‰à¸£à¸±à¸š')).length;
Â  Â  Â Â 
Â  Â  Â  document.getElementById('bg-wait').innerText = totalWait;Â 
Â  Â  Â  document.getElementById('bg-done').innerText = totalDone;Â 
Â  Â  Â  document.getElementById('bg-recv').innerText = totalRecv;
Â  Â  Â Â 
Â  Â  Â  // Note: Nav badge still shows total "Done" tasks (Global) or filtered? usually global for notification.
Â  Â  Â  // Keeping nav badge as global 'done' for now to alert user.
Â  Â  Â  const globalDone = allHistory.filter(r => r.status.includes('à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆ')).length;
Â  Â  Â  if(globalDone > 0) {Â 
Â  Â  Â  Â  Â  document.getElementById('nav-badge-hist').classList.remove('hidden');Â 
Â  Â  Â  Â  Â  document.getElementById('nav-badge-hist').innerText = globalDone;Â 
Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  document.getElementById('nav-badge-hist').classList.add('hidden');Â 
Â  Â  Â  }

Â  Â  Â  // 3. Apply Status Filter for List Display
Â  Â  Â  let msg = "";
Â  Â  Â  if(status === 'à¸£à¸­à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²') { filtered = filtered.filter(r => r.status.includes('à¸£à¸­')); msg = "à¹€à¸¡à¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡à¸¢à¸²à¸£à¸±à¸š order à¹à¸¥à¹‰à¸§ à¸ˆà¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°à¹€à¸›à¹‡à¸™ 'à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§'"; }
Â  Â  Â  else if(status === 'à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§') { filtered = filtered.filter(r => r.status.includes('à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆ')); msg = "à¸¡à¸²à¸£à¸±à¸šà¸¢à¸²à¸—à¸µà¹ˆà¸«à¹‰à¸­à¸‡à¸¢à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢"; }
Â  Â  Â  else { filtered = filtered.filter(r => r.status.includes('à¹„à¸”à¹‰à¸£à¸±à¸š')); }
Â  Â  Â Â 
Â  Â  Â  document.getElementById('hist-msg').innerText = msg; document.getElementById('hist-msg').classList.toggle('hidden', msg === "");
Â  Â  Â Â 
Â  Â  Â  // 4. Limit to 10 for display
Â  Â  Â  renderHistList(filtered, 10);
Â  }

Â  function renderHistList(data, limit) {
Â  Â  Â  const displayData = limit ? data.slice(0, limit) : data;
Â  Â  Â Â 
Â  Â  Â  const html = displayData.map(r=>{
Â  Â  Â  Â  let action = '';Â 
Â  Â  Â  Â  if(r.status.includes('à¸£à¸­à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²')) {
Â  Â  Â  Â  Â  Â  // New Button for Waiting Status
Â  Â  Â  Â  Â  Â  action = `<button class="btn btn-warning w-100 fw-bold py-2 mt-2" style="font-size:1.1rem;color:#333" onclick="openCheckOrder('${r.id}')"><i class="fas fa-clipboard-check"></i> à¸à¸´à¸¡à¸à¹Œà¹ƒà¸šà¸ˆà¸±à¸”à¸¢à¸²</button>`;
Â  Â  Â  Â  } else if(r.status.includes('à¸ˆà¸±à¸”à¸¢à¸²à¹€à¸ªà¸£à¹‡à¸ˆ')) {
Â  Â  Â  Â  Â  Â  action = `<button class="btn btn-success w-100 fw-bold py-2 mt-2" style="font-size:1.2rem;" onclick="receiveOrder('${r.id}')">à¸à¸”à¸£à¸±à¸šà¸¢à¸²</button>`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  let pdfBtn = '';
Â  Â  Â  Â  // Hide PDF button if Waiting, show otherwise
Â  Â  Â  Â  if(!r.status.includes('à¸£à¸­à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²')) {
Â  Â  Â  Â  Â  Â  pdfBtn = `<a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill"><i class="fas fa-file-pdf"></i> PDF</a>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  let itemList = r.items.map(i=> `<li>${i.name} (${i.qty}) - ${i.price}</li>`).join('').slice(0, 200) + (r.items.length > 5 ? '...' : '');
Â  Â  Â  Â  let cardClass = r.status.includes('à¸£à¸­') ? 'card-wait' : (r.status.includes('à¸£à¸±à¸š') ? 'card-recv' : 'card-done');
        
        // Logistics Timeline Logic
        const step1 = 'active';
        const step2 = (r.status.includes('à¸ˆà¸±à¸”') || r.status.includes('à¸£à¸±à¸š')) ? 'active' : '';
        const step3 = r.status.includes('à¸£à¸±à¸š') ? 'active' : '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  return `<div class="card mb-2 p-2 shadow-sm ${cardClass}">
                  <div class="d-flex justify-content-between align-items-center">
                     <strong class="text-primary small text-truncate w-75">${r.id}</strong>
                     <small class="text-muted" style="font-size:10px">${r.time}</small>
                  </div>
                  <div class="small text-muted my-1"><i class="fas fa-box"></i> ${r.box}</div>
                  
                  <!-- Timeline -->
                  <div class="timeline px-2">
                     <div class="tl-step ${step1}">
                        <div class="tl-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="tl-time">à¹€à¸šà¸´à¸<br>${r.time.split(' ')[1]||''}</div>
                     </div>
                     <div class="tl-step ${step2}">
                        <div class="tl-icon"><i class="fas fa-check"></i></div>
                        <div class="tl-time">à¸ˆà¸±à¸”à¹€à¸ªà¸£à¹‡à¸ˆ<br>${r.checkedTime||'-'}</div>
                     </div>
                     <div class="tl-step ${step3}">
                        <div class="tl-icon"><i class="fas fa-hand-holding"></i></div>
                        <div class="tl-time">à¸£à¸±à¸šà¸¢à¸²<br>${r.acceptedTime||'-'}</div>
                     </div>
                  </div>

                  <ul class="small text-muted ps-3 mb-1" style="max-height:100px;overflow-y:auto">${itemList}</ul>
                  <div class="d-flex flex-column align-items-stretch">
                     <div class="d-flex justify-content-between align-items-center">
                        <small class="badge bg-light text-dark border">${r.status}</small>
                        ${pdfBtn}
                     </div>
                     ${action}
                  </div>
                </div>`;
Â  Â  Â  }).join('');

Â  Â  Â  let moreBtn = '';
Â  Â  Â  if(limit && data.length > limit) {
Â  Â  Â  Â  Â  moreBtn = `<button class="btn btn-outline-secondary w-100 mt-2" onclick='renderHistList(${JSON.stringify(data).replace(/'/g, "&apos;")}, null)'>à¸”à¸¹à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (${data.length})</button>`;
Â  Â  Â  }

Â  Â  Â  document.getElementById('hist-res').innerHTML = html + moreBtn || '<div class="text-center text-muted mt-3">à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</div>';
Â  }

Â  // --- STATS LOGIC ---
Â  async function loadStats() {
Â  Â  Â  const start = document.getElementById('stat-start').value;
Â  Â  Â  const end = document.getElementById('stat-end').value;
Â  Â  Â Â 
Â  Â  Â  document.getElementById('hist-res').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2">à¸à¸³à¸¥à¸±à¸‡à¸„à¸³à¸™à¸§à¸“à¸ªà¸–à¸´à¸•à¸´...</div></div>';
Â  Â  Â  document.getElementById('hist-msg').classList.add('hidden');

Â  Â  Â  const res = await callApi('getStatData', {Â 
Â  Â  Â  Â  Â  user: currentUser.name,Â 
Â  Â  Â  Â  Â  substock: currentUser.substock,
Â  Â  Â  Â  Â  start: start,
Â  Â  Â  Â  Â  end: end
Â  Â  Â  });

Â  Â  Â  if(res.status) {
Â  Â  Â  Â  Â  renderStats(res.data);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  document.getElementById('hist-res').innerHTML = '<div class="alert alert-danger">Error loading stats</div>';
Â  Â  Â  }
Â  }

Â  function renderStats(data) {
Â  Â  Â  if(!data || data.length === 0) {
Â  Â  Â  Â  Â  document.getElementById('hist-res').innerHTML = '<div class="text-center text-muted mt-5">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸šà¸´à¸à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰</div>';
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Updated: Shows item name AND box name
Â  Â  Â  const html = data.map((item, idx) => `
Â  Â  Â  Â  <div class="d-flex align-items-center bg-white p-2 mb-2 rounded shadow-sm border">
Â  Â  Â  Â  Â  Â  <div class="me-3 fw-bold text-muted" style="width:20px">${idx+1}</div>
Â  Â  Â  Â  Â  Â  <div class="flex-grow-1">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="fw-bold text-primary">${item.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small text-secondary"><i class="fas fa-box"></i> ${item.box}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small text-muted">à¹€à¸šà¸´à¸à¹„à¸› ${item.count} à¸„à¸£à¸±à¹‰à¸‡</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="text-end">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="fw-bold fs-5">${item.qty}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="small text-muted">${item.price.toFixed(0)} à¸š.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `).join('');

Â  Â  Â  document.getElementById('hist-res').innerHTML = html;
Â  }

Â  // --- CHECK ORDER (PHARMACIST) - UPDATED: Optimistic UI ---
Â  function openCheckOrder(oid) {
Â  Â  Â  tempCheckOrderId = oid;
Â  Â  Â  document.getElementById('check-user-name').innerText = currentUser.name;
Â  Â  Â  mdlCheckOrder.show(); setTimeout(fixCvsCheck, 500);
Â  }
Â Â 
Â  async function confirmCheckOrder() {
Â  Â  Â  if(isCanvasBlank(cvsCheck)) return Swal.fire('à¸à¸£à¸¸à¸“à¸²à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸¢à¸²');
Â  Â  Â Â 
Â  Â  Â  mdlCheckOrder.hide();
      
      // Admin Auth for Pharmacist
      authAdmin(async (adminName) => {
          const sign = cvsCheck.toDataURL();
          const res = await callApi('confirmOrderCheck', { orderId: tempCheckOrderId, user: adminName, signature: sign });
          clrCvsCheck();
          if(res.status && res.pdf) window.open(res.pdf, '_blank');
          loadHist();
          Swal.fire({toast:true, icon:'success', title:'à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢'});
      });
Â  }

Â  async function receiveOrder(oid) {
Â  Â  Â  if(!confirm('à¸¢à¸·à¸™à¸¢à¸±à¸™à¹„à¸”à¹‰à¸£à¸±à¸šà¸¢à¸²à¸„à¸£à¸šà¸–à¹‰à¸§à¸™?')) return;
      // Admin Auth for Receiver
      authAdmin(async (adminName) => {
          const res = await callApi('updateOrderStatus', { orderId: oid, user: adminName });
          if(res.status) { Swal.fire('Success'); loadHist(); }
      });
Â  }

Â  // --- PRINT LABEL ---
Â  function openPrintLabel() {Â 
Â  Â  Â  document.getElementById('lbl-signer').innerText = currentUser.name;
Â  Â  Â  mdlSignLabel.show(); setTimeout(fixCvsLabel, 500);Â 
Â  }
Â  async function submitLabel() {
Â  Â  Â  if(isCanvasBlank(cvsLabel)) return Swal.fire('à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸à¹ˆà¸­à¸™');
Â  Â  Â Â 
Â  Â  Â  mdlSignLabel.hide(); // Close modal immediately
Â  Â  Â  
      authAdmin(async (adminName) => {
          Swal.fire({title:'à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡ PDF...', didOpen:()=>Swal.showLoading()});
          const sign = cvsLabel.toDataURL();
          const res = await callApi('generateBoxLabel', { boxName: curBoxStock, signBase64: sign, user: adminName });
          if(res.status) {
            clrCvsLabel();
            Swal.fire({ icon:'success', title:'à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary">à¸”à¸¹à¹ƒà¸šà¹à¸›à¸°à¸à¸¥à¹ˆà¸­à¸‡</a>` });
          } else Swal.fire('Error', res.message, 'error');
      });
Â  }

  // --- SEARCH EXPIRED ---
  async function showExpiredDrugs() {
      Swal.showLoading();
      const res = await callApi('getExpiredInventory');
      Swal.close();
      const div = document.getElementById('realtime-detail');
      
      if(res.data.length === 0) {
          div.innerHTML = '<div class="alert alert-success text-center">à¹€à¸¢à¸µà¹ˆà¸¢à¸¡! à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸²à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸</div>';
      } else {
          div.innerHTML = `<h6 class="text-danger fw-bold"><i class="fas fa-exclamation-circle"></i> à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ (${res.data.length})</h6>` + 
          res.data.map(d => `
             <div class="border-bottom py-2">
                <div class="fw-bold text-dark">${d.name}</div>
                <div class="d-flex justify-content-between small text-muted">
                    <span><i class="fas fa-box"></i> ${d.box}</span>
                    <span class="text-danger fw-bold">${d.expire}</span>
                </div>
             </div>
          `).join('');
      }
      document.getElementById('pagination-controls').classList.add('hidden');
  }

  // --- QR SCANNER ---
  function startScan() {
      document.getElementById('qr-overlay').style.display = 'flex';
      html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
  }
  function stopScan() {
      if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          document.getElementById('qr-overlay').style.display = 'none';
      });
  }
  function restartScan() {
      mdlScanRes.hide();
      startScan();
  }
  async function onScanSuccess(decodedText) {
      stopScan();
      Swal.fire({title:'Searching...', didOpen:()=>Swal.showLoading()});
      const res = await callApi('getInventoryByQr', { qrCode: decodedText });
      Swal.close();
      
      if(res.status) {
          const d = res.data;
          document.getElementById('qr-id').value = d.invId;
          document.getElementById('qr-name').innerText = d.name;
          document.getElementById('qr-box').innerText = d.box;
          document.getElementById('qr-loc').value = d.location;
          document.getElementById('qr-amt').value = d.amount;
          document.getElementById('qr-act').value = d.actual;
          document.getElementById('qr-exp').value = d.expire;
          document.getElementById('qr-img').src = DEFAULT_IMG; 
          if(d.imageRaw) callApi('resolveImage',{input:d.imageRaw}).then(r=>{if(r.status) document.getElementById('qr-img').src=r.src});
          
          mdlScanRes.show();
      } else {
          Swal.fire('Not Found', 'QR Code not mapped', 'error').then(startScan);
      }
  }
  async function saveQrEdit() {
      const pl = {
          invId: document.getElementById('qr-id').value,
          amount: document.getElementById('qr-amt').value,
          actual: document.getElementById('qr-act').value,
          location: document.getElementById('qr-loc').value,
          expire: document.getElementById('qr-exp').value
      };
      await callApi('updateInventoryFromQr', pl);
      Swal.fire({toast:true, icon:'success', title:'Saved', position:'center', timer:1000});
      mdlScanRes.hide();
      startScan(); // Loop Scan
  }
  function addQrToPool() {
      // Mock logic to add to pool
      Swal.fire('Added to Print Queue');
  }

  // --- ADMIN AUTH HELPER ---
  async function authAdmin(callback) {
      const { value: username } = await Swal.fire({
          title: 'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™ (HosXP)',
          input: 'text',
          inputPlaceholder: 'Username',
          showCancelButton: true
      });
      
      if (username) {
          Swal.showLoading();
          const res = await callApi('checkAdmin', { username });
          Swal.close();
          
          if(res.status) {
              callback(res.name);
          } else {
              // Not found, prompt to add
              const { value: newName } = await Swal.fire({
                  title: 'à¹„à¸¡à¹ˆà¸à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰',
                  text: 'à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥ à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸',
                  input: 'text',
                  showCancelButton: true
              });
              if(newName) {
                  await callApi('registerAdmin', { username, name: newName });
                  callback(newName);
              }
          }
      }
  }

Â  function filterOrder(){ renderOrder(); }
Â  function lazyLoad() { document.querySelectorAll('img.lazy').forEach(img => { if(img.dataset.loaded) return; const raw = img.dataset.raw; if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; } if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; } callApi('resolveImage', { input: raw }).then(res => { if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; } }); }); }
Â Â 
Â  let canvas, ctx, isDraw=false;
Â  let cvsLabel, ctxLabel, isDrawLabel=false;
Â  let cvsCheck, ctxCheck, isDrawCheck=false;
Â Â 
Â  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
Â  function initCvsLabel(){ cvsLabel=document.getElementById('cvs-label'); ctxLabel=cvsLabel.getContext('2d'); ['mousedown','touchstart'].forEach(e=>cvsLabel.addEventListener(e,sL,{passive:false})); ['mousemove','touchmove'].forEach(e=>cvsLabel.addEventListener(e,dL,{passive:false})); ['mouseup','touchend'].forEach(e=>cvsLabel.addEventListener(e,()=>isDrawLabel=false)); }
Â  function initCvsCheck(){ cvsCheck=document.getElementById('cvs-check'); ctxCheck=cvsCheck.getContext('2d'); ['mousedown','touchstart'].forEach(e=>cvsCheck.addEventListener(e,sC,{passive:false})); ['mousemove','touchmove'].forEach(e=>cvsCheck.addEventListener(e,dC,{passive:false})); ['mouseup','touchend'].forEach(e=>cvsCheck.addEventListener(e,()=>isDrawCheck=false)); }
Â Â 
Â  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
Â  function fixCvsLabel(){ cvsLabel.width=cvsLabel.offsetWidth; cvsLabel.height=100; ctxLabel.lineWidth=2; ctxLabel.lineCap='round'; ctxLabel.strokeStyle='#000'; }
Â  function fixCvsCheck(){ cvsCheck.width=cvsCheck.offsetWidth; cvsCheck.height=100; ctxCheck.lineWidth=2; ctxCheck.lineCap='round'; ctxCheck.strokeStyle='#000'; }
Â Â 
Â  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
Â  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
Â  function sL(e){ e.preventDefault(); isDrawLabel=true; let r=cvsLabel.getBoundingClientRect(); ctxLabel.beginPath(); ctxLabel.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
Â  function dL(e){ if(!isDrawLabel)return; e.preventDefault(); let r=cvsLabel.getBoundingClientRect(); ctxLabel.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctxLabel.stroke(); }
Â  function sC(e){ e.preventDefault(); isDrawCheck=true; let r=cvsCheck.getBoundingClientRect(); ctxCheck.beginPath(); ctxCheck.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
Â  function dC(e){ if(!isDrawCheck)return; e.preventDefault(); let r=cvsCheck.getBoundingClientRect(); ctxCheck.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctxCheck.stroke(); }
Â Â 
Â  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
Â  function clrCvsLabel(){ ctxLabel.clearRect(0,0,cvsLabel.width,cvsLabel.height); }
Â  function clrCvsCheck(){ ctxCheck.clearRect(0,0,cvsCheck.width,cvsCheck.height); }
Â  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>