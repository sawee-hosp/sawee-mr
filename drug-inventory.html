<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Hospital Pharmacy System</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      /* Theme Colors */
      --primary: #003d82; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
      --primary-light: #0d6efd; /* ‡∏ü‡πâ‡∏≤ */
      --secondary: #e7f1ff;
      --bg: #f4f6f9;
      --text: #2c3e50;
      --high-alert: #fee2e2;
      --protect-light: #fef3c7;
    }
    
    body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Loading Overlay */
    #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; }

    /* Navbar */
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: white; z-index: 1000; box-shadow: 0 1px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
    .nav-brand { font-weight: 600; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: var(--secondary); padding: 4px 10px; border-radius: 20px; color: var(--primary); }
    .profile-mini img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    
    /* Box Scroller (Carousel) - Blue BG */
    .box-scroller { display: flex; overflow-x: auto; padding: 15px; gap: 10px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .box-scroller::-webkit-scrollbar { display: none; }
    .box-btn { 
      min-width: 90px; padding: 10px; 
      background: var(--primary-light); /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
      color: white;
      border: none; border-radius: 16px; 
      text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .box-btn img { 
      width: 50px; height: 50px; border-radius: 8px; 
      object-fit: cover; margin-bottom: 6px; background: white; border: 2px solid white;
    }
    .box-btn.active { 
      background: var(--primary); /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
      transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0, 61, 130, 0.4); 
      border: 2px solid #fff;
    }

    /* Grid & Cards */
    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; padding: 15px; }
    .drug-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #f0f0f0; display: flex; flex-direction: column; position: relative; transition: 0.2s; }
    .drug-card:active { transform: scale(0.98); }
    .drug-img-wrap { 
      width: 100%; aspect-ratio: 1/1; 
      background: #fff; display: flex; align-items: center; justify-content: center; padding: 10px; border-bottom: 1px solid #f8f8f8;
    }
    .drug-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .drug-img.loading { opacity: 0.5; filter: blur(2px); }
    
    .drug-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; background: white; }
    .drug-name { font-size: 0.85rem; font-weight: 600; line-height: 1.3; height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 5px; }

    /* Bottom Nav - Dark Blue */
    .btm-nav { 
      position: fixed; bottom: 0; left: 0; right: 0; height: 75px; 
      background: var(--primary); /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
      display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 10px; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
      border-top-left-radius: 20px; border-top-right-radius: 20px;
    }
    .nav-item { text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8rem; width: 25%; cursor: pointer; transition: 0.2s; }
    .nav-item i { font-size: 1.6rem; display: block; margin-bottom: 4px; }
    .nav-item.active { color: white; font-weight: 600; transform: translateY(-5px); }

    /* Stock & Shelf View */
    .shelf-row-label { font-weight: bold; margin: 15px 0 5px 0; padding-left: 10px; border-left: 4px solid var(--primary); color: #555; }
    .shelf-item { position: relative; border:1px solid #eee; border-radius:10px; padding:5px; text-align:center; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .shelf-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-bottom: 5px; }
    
    /* Conditional Badges */
    .badge-ha { position: absolute; top: 5px; left: 5px; font-size: 10px; background: red; color: white; padding: 2px 4px; border-radius: 4px; }
    .bg-ha { background-color: var(--high-alert) !important; border: 1px solid red; }
    .icon-protect { color: #f59e0b; margin-left: 3px; }

    /* Fab Edit */
    .fab-edit-lg {
      position: fixed; bottom: 90px; right: 20px; 
      background: var(--primary); color: white; border-radius: 30px;
      padding: 10px 20px; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: bold; z-index: 900;
      cursor: pointer;
    }

    /* Search Results */
    .search-hit { cursor: pointer; transition: 0.1s; }
    .search-hit:active { background: #f0f0f0; }

    /* Helpers */
    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 28px; height: 28px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; }
    .inp-qty { width: 30px; border: none; background: transparent; text-align: center; font-weight: bold; font-size: 0.9rem; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; height: 180px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>

  <!-- LOADING -->
  <div id="login-overlay">
    <div class="text-center fade-in">
      <div style="font-size:4rem;color:var(--primary);margin-bottom:10px"><i class="fa-solid fa-hospital-user fa-beat"></i></div>
      <h4 class="fw-bold mb-1" style="color:#333">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</h4>
      <div id="status-text" class="text-primary small mt-3 fw-bold">Connecting...</div>
    </div>
  </div>

  <!-- REGISTRATION MODAL -->
  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5></div><div class="modal-body p-4"><div class="text-center mb-3"><img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)"></div><form id="form-reg"><input id="reg-username" class="form-control mb-3" placeholder="Username *" required><input id="reg-name" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *" required><input id="reg-email" class="form-control mb-3" placeholder="Email"><div class="mb-3"><label class="small fw-bold text-muted">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label><div class="p-2 border rounded bg-white" style="max-height:150px;overflow-y:auto"><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á</label></div></div></div><button type="submit" class="btn btn-primary w-100 rounded-pill">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button></form></div></div></div></div>

  <!-- APP CONTENT -->
  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacy</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini"><img id="nav-img" src=""><span id="nav-name" style="font-size:0.8rem;font-weight:600;">User</span></div>
         <div style="position:relative;padding:5px;" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.4rem;color:#555"></i>
            <div id="badge" class="badge bg-danger rounded-circle position-absolute top-0 end-0 hidden" style="font-size:10px">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:70px">
      <!-- 1. ORDER TAB -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:65px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤..." onkeyup="filterOrder()">
        </div>
        <div id="order-grid" class="drug-grid"><div class="text-center w-100 mt-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div></div>
      </div>

      <!-- 2. STOCK TAB -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="group-filter" class="d-flex gap-2 px-3 pb-2 overflow-auto" style="white-space:nowrap"></div>
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5 px-3">
           <div class="text-center mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
        </div>
        <div id="fab-edit" class="fab-edit-lg hidden" onclick="openBoxEditor()">
           <i class="fas fa-edit"></i> ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á
        </div>
      </div>

      <!-- 3. SEARCH & EDIT MASTER TAB -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-primary mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</h5>
         <div class="input-group mb-3 shadow-sm rounded-pill">
            <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
            <input id="kw-realtime" class="form-control border-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (Realtime)...">
         </div>
         <div id="realtime-res" class="list-group list-group-flush rounded-3 bg-white shadow-sm"></div>
      </div>

      <!-- 4. HISTORY TAB -->
      <div id="tab-hist" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-secondary mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)</h5>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <!-- NAVIGATION -->
  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-hist', this); loadHist()"><i class="fas fa-history"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
  </div>

  <!-- CART DRAWER -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000">
    <div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body d-flex flex-column p-0 bg-light">
       <div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div>
       <div class="p-3 bg-white shadow-lg mt-auto">
          <div class="d-flex justify-content-between fw-bold mb-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-primary" id="cart-sum">0.00</span></div>
          <div class="border rounded p-2 mb-3 bg-white">
             <small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:</small>
             <canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas>
             <div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvs()">‡∏•‡πâ‡∏≤‡∏á</small></div>
          </div>
          <button onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
       </div>
    </div>
  </div>

  <!-- BOX EDITOR MODAL -->
  <div class="modal fade" id="mdlBoxEdit" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
           <div class="card p-3 mb-3 border-0 shadow-sm">
              <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
              <input id="edit-box-name" class="form-control fw-bold mb-2">
              
              <label class="small text-muted">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
              <div class="d-flex gap-2">
                 <input type="file" id="inp-box-file" class="form-control" accept="image/*" onchange="uploadBoxImg(this)">
                 <input id="edit-box-img" type="hidden">
                 <img id="preview-box-img" src="" style="width:40px;height:40px;border-radius:4px;object-fit:cover;border:1px solid #ddd">
              </div>
              <button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveBoxInfo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πà‡∏≠‡∏á</button>
           </div>
           
           <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</h6>
              <button class="btn btn-sm btn-success rounded-pill" onclick="mdlAddItem.show()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button>
           </div>
           <div id="edit-box-items" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MASTER ITEM EDITOR MODAL -->
  <div class="modal fade" id="mdlMasterEdit">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
           <div class="modal-header bg-warning text-dark"><h6 class="fw-bold m-0">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (Master)</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
           <div class="modal-body">
              <input type="hidden" id="mst-id">
              <div class="mb-2 text-center">
                 <img id="mst-img-preview" src="" style="height:100px;border-radius:8px">
                 <input type="file" class="form-control mt-2" accept="image/*" onchange="uploadMasterImg(this)">
                 <input type="hidden" id="mst-img-path">
              </div>
              <div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input id="mst-name" class="form-control"></div>
              <div class="row g-2 mb-2">
                 <div class="col-6"><label class="small">Unit</label><input id="mst-unit" class="form-control"></div>
                 <div class="col-6"><label class="small">Price</label><input id="mst-price" type="number" class="form-control"></div>
              </div>
              <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-ha"><label class="form-check-label text-danger fw-bold">High Alert</label></div>
              <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-pl"><label class="form-check-label text-warning fw-bold">Protect Light</label></div>
              <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-kc"><label class="form-check-label text-info fw-bold">Keep Cool (2-8¬∞C)</label></div>
              <button class="btn btn-primary w-100 mt-3" onclick="saveMasterItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
           </div>
        </div>
     </div>
  </div>

  <!-- STOCK ITEM EDIT MODAL -->
  <div class="modal fade" id="mdlEdit">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
           <div class="modal-body text-center p-4">
              <input type="hidden" id="ed-id">
              <h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6>
              <div class="row g-2">
                 <div class="col-6"><label class="small text-muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div>
                 <div class="col-6"><label class="small text-muted">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="date" id="ed-exp" class="form-control text-center"></div>
              </div>
              <button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
           </div>
        </div>
     </div>
  </div>

  <!-- ADD ITEM SEARCH MODAL -->
  <div class="modal fade" id="mdlAddItem" style="z-index:2100">
     <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
           <div class="modal-header"><h6 class="fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
           <div class="modal-body">
              <input id="search-master" class="form-control mb-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." onkeyup="searchMasterDebounce()">
              <div id="master-res" class="list-group" style="max-height:250px;overflow-y:auto"></div>
           </div>
        </div>
     </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- CONFIG ---
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAb1BMVEUAAAD///+srKzFxcWZmZnc3Nza2trR0dHnYzr///8/Pz9ycnKwZzKtra1ERETGxsbMzMy3t7fAwMDq6uqgoKCkpKRubm5KSkpYWFji4uJHR0dgYGBubm5mZmZwcHBqampycnJOTk5UVFR8fHxISEh929s2AAAAInRSTlMA+/zb2v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+2tra2t7XhY8AAAN1SURBVGje7ZqJjqMwDEXlMnOYzUx3//+3F5QiazmC0Onw3rSpU0eFkPCRjO0407/1dZ+y701/c72u852t+2u972z93+t15+t/r9d90D8s7oP+YXEfdIjFfdAhFvdB+1g8Bn3F4jHoKxaPQV+xeAz6isVj0FcsHoO+YvEY9BWLx6CvWDwGfcXiMeirj8S6z/oR6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7B+wvoJ6yesn7D+B/0Fq7h+W3gqAAAAAElFTkSuQmCC";

  let liffId = "2008862022-cDOpEP9z";
  
  let currentUser = {}, items=[], cart=[], curBoxOrder='', curBoxStock='';
  let allBoxes = []; 
  let offC, mdlEdit, mdlReg, mdlBoxEdit, mdlAddItem, mdlMasterEdit;
  let searchTimeout;

  // --- API ---
  async function callApi(action, payload = {}) {
     try {
       const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: {'Content-Type': 'text/plain;charset=utf-8'},
          body: JSON.stringify({ action, ...payload })
       });
       const text = await res.text();
       try { return JSON.parse(text); } 
       catch(e) { 
           if(text.includes("Service is")) throw new Error("DEPLOYMENT_ERR");
           throw new Error(text.substr(0,50)); 
       }
     } catch(e) {
       console.error(e);
       if(e.message=="DEPLOYMENT_ERR") Swal.fire('Error','Deploy ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Execute as Me / Anyone','error');
       return { status: 'error', message: e.message };
     }
  }

  // --- INIT ---
  window.onload = async () => {
     offC = new bootstrap.Offcanvas('#cartSheet');
     mdlEdit = new bootstrap.Modal('#mdlEdit');
     mdlReg = new bootstrap.Modal('#mdlRegister');
     mdlBoxEdit = new bootstrap.Modal('#mdlBoxEdit');
     mdlAddItem = new bootstrap.Modal('#mdlAddItem');
     mdlMasterEdit = new bootstrap.Modal('#mdlMasterEdit');
     initCvs();

     try {
        await liff.init({ liffId }); 
        if(!liff.isLoggedIn()) liff.login();
        else {
           const profile = await liff.getProfile();
           currentUser.photo = profile.pictureUrl;
           checkUser(profile.userId);
        }
     } catch(e) {
        document.getElementById('status-text').innerHTML = `<span class="text-danger">${e.message}</span>`;
     }
     
     // Realtime Search Listener
     document.getElementById('kw-realtime').addEventListener('keyup', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => doRealtimeSearch(e.target.value), 500);
     });
  };

  async function checkUser(uid) {
     const res = await callApi('checkUserLIFF', { userId: uid });
     if (res.status === 'NOT_FOUND') {
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('reg-img').src = currentUser.photo || DEFAULT_IMG;
        mdlReg.show();
     } else if (res.status === 'FOUND') {
        currentUser = { ...res.userData, userId: uid };
        startApp();
     }
  }

  document.getElementById('form-reg').onsubmit = async (e) => {
     e.preventDefault();
     const subs = Array.from(document.querySelectorAll('.chk-sub:checked')).map(c=>c.value);
     if(!subs.length) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å');
     Swal.showLoading();
     const res = await callApi('registerUser', {
        username: document.getElementById('reg-username').value,
        name: document.getElementById('reg-name').value,
        email: document.getElementById('reg-email').value,
        substock: subs, userId: currentUser.userId, photo: currentUser.photo
     });
     if(res.status) location.reload(); else Swal.fire(res.message);
  };

  async function startApp() {
     document.getElementById('login-overlay').classList.add('hidden');
     document.getElementById('app-main').classList.remove('hidden');
     document.getElementById('nav-img').src = currentUser.photo || DEFAULT_IMG;
     document.getElementById('nav-name').innerText = currentUser.name;

     // Load Boxes for Order
     const resOrder = await callApi('getBoxes', { substock: currentUser.substock, showAll: false });
     if(resOrder.status) renderBoxScroller('order', resOrder.boxes);

     // Load All Boxes for Stock
     const resStock = await callApi('getBoxes', { showAll: true });
     if(resStock.status) {
         allBoxes = resStock.boxes;
         renderBoxScroller('stock', allBoxes);
     }
     
     const resGroups = await callApi('getBoxGroups');
     if(resGroups.status) {
         document.getElementById('group-filter').innerHTML = 
            `<div class="badge rounded-pill bg-primary cursor-pointer p-2" onclick="filterStockBox('ALL',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>` + 
            resGroups.groups.map(g=>`<div class="badge rounded-pill bg-white text-dark border cursor-pointer p-2" onclick="filterStockBox('${g}',this)">${g}</div>`).join('');
     }
  }

  // --- UI RENDER ---
  function renderBoxScroller(mode, boxes) {
     const el = document.getElementById(`box-scroller-${mode}`);
     el.innerHTML = boxes.map(b=>`
       <div class="box-btn" onclick="selBox('${b.name}', this, '${mode}', '${b.imageRaw}')">
          <img src="${DEFAULT_IMG}" class="lazy" data-raw="${b.imageRaw}">
          <span style="font-size:0.75rem;line-height:1.1;font-weight:600">${b.name}</span>
       </div>`).join('');
     lazyLoad();
  }

  function filterStockBox(group, el) {
      const p = el.parentElement;
      Array.from(p.children).forEach(x=> { x.classList.remove('bg-primary','text-white'); x.classList.add('bg-white','text-dark'); });
      el.classList.remove('bg-white','text-dark'); el.classList.add('bg-primary','text-white');
      
      const filtered = (group==='ALL') ? allBoxes : allBoxes.filter(b=>b.group===group);
      renderBoxScroller('stock', filtered);
  }

  function nav(pid, el){
     document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden'));
     document.getElementById(pid).classList.remove('hidden');
     document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
     el.classList.add('active');
  }

  async function selBox(name, el, mode, imgRaw) {
     document.querySelectorAll(`#box-scroller-${mode} .box-btn`).forEach(x=>x.classList.remove('active'));
     el.classList.add('active');
     
     if(mode==='order') {
        if(cart.length && curBoxOrder!=name && !confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;
        if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
        curBoxOrder = name;
        loadOrderItems(name);
     } else {
        curBoxStock = name;
        document.getElementById('fab-edit').classList.remove('hidden');
        document.getElementById('edit-box-name').value = name;
        document.getElementById('edit-box-img').value = imgRaw;
        // Preview box img
        document.getElementById('preview-box-img').src = DEFAULT_IMG;
        callApi('resolveImage',{input:imgRaw}).then(r=>{if(r.status) document.getElementById('preview-box-img').src=r.src});
        loadStockItems(name);
     }
  }

  // --- INVENTORY & STOCK ---
  async function loadOrderItems(box) {
     document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-2"></div>').join('');
     const res = await callApi('getItems', { boxName: box });
     items = res.status ? res.data.map(x=>({...x, req:1})) : [];
     renderOrder();
     lazyLoad();
  }
  
  async function loadStockItems(box) {
      const el = document.getElementById('stock-content');
      el.innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
      const res = await callApi('getItems', { boxName: box });
      if(!res.status) return el.innerHTML = 'Error';
      
      let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
      let h=''; 
      // Stock View
      Object.keys(rows).sort().forEach(r=>{
         h+=`<div class="shelf-row-label">‡∏ä‡∏±‡πâ‡∏ô/‡πÅ‡∏ñ‡∏ß: ${r}</div><div class="d-flex flex-wrap gap-2 mt-2">`;
         h+=rows[r].map(i=> {
           let cls = i.highAlert ? 'bg-ha' : '';
           let icon = i.protectLight ? '<i class="fas fa-sun icon-protect"></i>' : '';
           return `
           <div class="shelf-item ${cls}" style="width:105px" onclick="editStk('${i.invId}','${i.name}',${i.amount},'${i.expire}')">
             ${i.highAlert ? '<div class="badge-ha">HA</div>' : ''}
             <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy">
             <div class="small text-truncate fw-bold" style="font-size:0.75rem">${i.name}</div>
             <div class="d-flex justify-content-between align-items-center mt-1">
                <span class="badge bg-secondary">${i.amount}</span>
                <span class="text-muted" style="font-size:9px">${i.expire || '-'} ${icon}</span>
             </div>
           </div>`
         }).join('');
         h+='</div>';
      });
      el.innerHTML = h || '<div class="text-center mt-5 text-muted">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>';

      // Edit Box Item List
      const editHtml = res.data.map(i=>`
         <div class="col-12 d-flex align-items-center bg-white border p-2 rounded">
             <img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" style="width:40px;height:40px;object-fit:cover;border-radius:4px">
             <div class="flex-grow-1 ms-2 small">
                <div class="fw-bold text-truncate">${i.name}</div>
                <div class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${i.amount}</div>
             </div>
             <button class="btn btn-sm btn-outline-danger" onclick="removeBoxItem('${i.invId}')"><i class="fas fa-trash"></i></button>
         </div>`).join('');
      document.getElementById('edit-box-items').innerHTML = editHtml;
      
      lazyLoad();
  }

  function renderOrder() {
     const kw = document.getElementById('order-search').value.toLowerCase();
     const html = items.filter(i=>i.name.toLowerCase().includes(kw)).map(i=>`
        <div class="drug-card">
           <div class="drug-img-wrap"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy loading"></div>
           <div class="drug-info">
              <div class="drug-name">${i.name}</div>
              <div class="d-flex justify-content-between small text-muted mb-2"><span>‡∏°‡∏µ: ${i.amount}</span><span class="text-primary fw-bold">${i.price} ‡∏ö.</span></div>
              <div class="qty-wrap">
                 <button class="btn-qty" onclick="adj('${i.itemId}',-1)">-</button>
                 <input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly>
                 <button class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</button>
              </div>
              <button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
           </div>
        </div>`).join('');
     document.getElementById('order-grid').innerHTML = html || '<div class="text-center mt-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤</div>';
  }

  // --- SEARCH & REALTIME & MASTER EDIT ---
  async function doRealtimeSearch(kw) {
     if(!kw) return document.getElementById('realtime-res').innerHTML = '';
     const res = await callApi('searchDrugDetails', { kw });
     if(res.status) {
        document.getElementById('realtime-res').innerHTML = res.data.map(d => {
           let locs = d.locations.map(l => `<span class="badge bg-light text-dark border me-1">${l.box} (${l.amount}) Exp:${l.expire}</span>`).join('');
           return `
           <div class="list-group-item">
              <div class="d-flex gap-2">
                 <img src="${DEFAULT_IMG}" data-raw="${d.imageRaw}" class="lazy" style="width:50px;height:50px;border-radius:4px;object-fit:cover">
                 <div class="flex-grow-1">
                    <div class="fw-bold text-primary">${d.name}</div>
                    <div class="small text-muted mb-1">${d.itemId} | ${d.price} ‡∏ö.</div>
                    <div class="d-flex flex-wrap">${locs}</div>
                 </div>
                 <button class="btn btn-sm btn-outline-secondary align-self-start" onclick='openMasterEdit(${JSON.stringify(d).replace(/'/g, "&apos;")})'><i class="fas fa-edit"></i></button>
              </div>
           </div>`;
        }).join('');
        lazyLoad();
     }
  }

  function openMasterEdit(item) {
     document.getElementById('mst-id').value = item.itemId;
     document.getElementById('mst-name').value = item.name;
     document.getElementById('mst-img-path').value = item.imageRaw || '';
     document.getElementById('mst-unit').value = item.unit || '';
     document.getElementById('mst-price').value = item.price || '';
     document.getElementById('mst-ha').checked = item.highAlert;
     document.getElementById('mst-pl').checked = item.protectLight;
     document.getElementById('mst-kc').checked = item.keepCool;
     
     // Preview Img
     const imgEl = document.getElementById('mst-img-preview');
     imgEl.src = DEFAULT_IMG;
     if(item.imageRaw) callApi('resolveImage',{input:item.imageRaw}).then(r=>{if(r.status) imgEl.src=r.src});
     
     mdlMasterEdit.show();
  }

  async function uploadMasterImg(input) {
     const file = input.files[0];
     if(!file) return;
     const reader = new FileReader();
     reader.onload = async (e) => {
        document.getElementById('mst-img-preview').src = e.target.result; // Local preview
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'DRUG', name: file.name });
        if(res.status) {
           document.getElementById('mst-img-path').value = res.path;
           Swal.close();
        } else Swal.fire('Upload Failed');
     };
     reader.readAsDataURL(file);
  }

  async function saveMasterItem() {
     const payload = {
        itemId: document.getElementById('mst-id').value,
        name: document.getElementById('mst-name').value,
        image: document.getElementById('mst-img-path').value,
        unit: document.getElementById('mst-unit').value,
        price: document.getElementById('mst-price').value,
        highAlert: document.getElementById('mst-ha').checked,
        protectLight: document.getElementById('mst-pl').checked,
        keepCool: document.getElementById('mst-kc').checked
     };
     const res = await callApi('updateMasterItem', payload);
     if(res.status) { Swal.fire('Saved'); mdlMasterEdit.hide(); }
  }

  // --- BOX & IMAGE EDIT ---
  function openBoxEditor() { mdlBoxEdit.show(); }
  
  async function uploadBoxImg(input) {
     const file = input.files[0];
     if(!file) return;
     const reader = new FileReader();
     reader.onload = async (e) => {
        document.getElementById('preview-box-img').src = e.target.result;
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'BOX', name: file.name });
        if(res.status) {
           document.getElementById('edit-box-img').value = res.path;
           Swal.close();
        } else Swal.fire('Upload Failed');
     };
     reader.readAsDataURL(file);
  }

  async function saveBoxInfo() {
     if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?')) return;
     const newN = document.getElementById('edit-box-name').value;
     const newI = document.getElementById('edit-box-img').value;
     const res = await callApi('updateBoxInfo', { oldName: curBoxStock, newName: newN, newImage: newI });
     if(res.status) { Swal.fire('Saved'); curBoxStock=newN; location.reload(); }
  }

  async function searchMasterDebounce() {
     clearTimeout(searchTimeout);
     searchTimeout = setTimeout(searchMaster, 500);
  }
  async function searchMaster() {
     const k = document.getElementById('search-master').value;
     if(!k) return;
     const res = await callApi('searchMasterItems', { kw: k });
     document.getElementById('master-res').innerHTML = res.data.map(i=>`
        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="addItemToBox('${i.id}')">
           <div class="d-flex align-items-center gap-2">
              <img src="${DEFAULT_IMG}" data-raw="${i.image}" class="lazy" style="width:30px;height:30px;border-radius:4px;object-fit:cover">
              <span class="small">${i.name}</span>
           </div>
           <i class="fas fa-plus-circle text-success"></i>
        </button>`).join('');
     lazyLoad();
  }

  async function addItemToBox(itemId) {
     const amt = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:', '1');
     if(!amt) return;
     const res = await callApi('addBoxItem', { boxName: curBoxStock, itemId, amount: amt });
     if(res.status) { loadStockItems(curBoxStock); mdlAddItem.hide(); }
  }

  async function removeBoxItem(invId) {
     if(!confirm('‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏µ‡πâ?')) return;
     const res = await callApi('removeBoxItem', { invId });
     if(res.status) loadStockItems(curBoxStock);
  }

  // --- CART, SUBMIT ---
  function adj(id, v, max) {
     let i = items.find(x=>x.itemId==id); if(!i) return;
     let n = i.req + v; if(n<1)n=1; if(max && n>max) { n=max; Swal.fire({toast:true,position:'top',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); }
     i.req = n; document.getElementById(`qty-${id}`).value = n;
  }
  function addCart(id) {
     let i = items.find(x=>x.itemId==id); let ex = cart.find(x=>x.itemId==id);
     if(ex) { if(ex.qty+i.req > i.amount) return Swal.fire('‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'); ex.qty+=i.req; } else cart.push({...i, qty:i.req});
     badge(); 
     const b=document.querySelector('.fa-shopping-basket'); b.style.transform='scale(1.4)'; setTimeout(()=>b.style.transform='scale(1)',200);
     i.req=1; document.getElementById(`qty-${id}`).value=1;
  }
  function badge() { let n=cart.length; document.getElementById('badge').innerText=n; n>0?document.getElementById('badge').classList.remove('hidden'):document.getElementById('badge').classList.add('hidden'); }
  function openCart(){ if(!cart.length) return Swal.fire('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); renderCart(); offC.show(); setTimeout(fixCvs,500); }
  function renderCart(){
     let sum=0;
     document.getElementById('cart-list').innerHTML=cart.map((c,i)=>{ sum+=c.price*c.qty; return `<div class="bg-white p-3 mb-2 rounded border position-relative"><div class="fw-bold pe-4">${c.name}</div><div class="d-flex justify-content-between mt-2 small text-muted"><span>${c.price} x ${c.qty}</span> <span class="text-primary fw-bold">${(c.price*c.qty).toFixed(2)} ‡∏ö.</span></div><i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3 cursor-pointer" onclick="cart.splice(${i},1);renderCart();badge();if(!cart.length)offC.hide()"></i></div>`; }).join('');
     document.getElementById('cart-sum').innerText = sum.toFixed(2);
  }
  async function submitOrder() {
     if(isCanvasBlank(canvas)) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠');
     Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen:()=>Swal.showLoading()});
     const sign = canvas.toDataURL();
     const res = await callApi('submitOrder', { orderData: { user: currentUser.name, box: curBoxOrder, items: cart, signature: sign } });
     if(res.status) { cart=[]; badge(); offC.hide(); clrCvs(); Swal.fire({icon:'success', html:`<a href="${res.pdfUrl}" target="_blank" class="btn btn-primary w-100">‡∏î‡∏π‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (PDF)</a>`}); } else Swal.fire('Error', res.message, 'error');
  }

  // --- HELPERS ---
  function editStk(id,n,a,e) { document.getElementById('ed-id').value=id; document.getElementById('ed-name').innerText=n; document.getElementById('ed-amt').value=a; document.getElementById('ed-exp').value=e; mdlEdit.show(); }
  async function saveEdit() { const pl = { invId:document.getElementById('ed-id').value, amount:document.getElementById('ed-amt').value, expire:document.getElementById('ed-exp').value }; const res = await callApi('saveEditItem', pl); if(res.status) { mdlEdit.hide(); loadStockItems(curBoxStock); } }
  function doGlobal() { const k=document.getElementById('kw-global').value; if(!k)return; document.getElementById('search-res').innerHTML='Searching...'; callApi('searchGlobal', {kw:k}).then(res=>{ if(res.status) { document.getElementById('search-res').innerHTML = res.data.map(r=>`<div class="list-group-item"><strong>${r.name}</strong><br><small>${r.box} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${r.amount}</small></div>`).join('') || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; } }); }
  
  function loadHist() { 
     document.getElementById('hist-res').innerHTML='Loading...'; 
     // Pass substock to filter history
     callApi('getHistory', {user:currentUser.name, substock:currentUser.substock}).then(res=>{ 
        if(res.status) { 
           document.getElementById('hist-res').innerHTML = res.data.map(r=>`
           <div class="card mb-2 p-2 shadow-sm border-start border-4 border-${r.status=='‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤'?'warning':'success'}">
              <div class="d-flex justify-content-between align-items-center">
                 <strong class="text-primary">${r.box}</strong>
                 <small class="text-muted">${r.time}</small>
              </div>
              <div class="d-flex justify-content-between mt-2 align-items-end">
                 <small>${r.status}</small>
                 <a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill"><i class="fas fa-file-pdf"></i> PDF</a>
              </div>
           </div>`).join(''); 
        } 
     }); 
  }
  function filterOrder(){ renderOrder(); }
  
  function lazyLoad() {
     document.querySelectorAll('img.lazy').forEach(img => {
        if(img.dataset.loaded) return;
        const raw = img.dataset.raw;
        if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; }
        if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; }
        callApi('resolveImage', { input: raw }).then(res => { if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; } });
     });
  }

  let canvas, ctx, isDraw=false;
  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>