<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="referrer" content="no-referrer">
  <title>Sawee Rxfill 2.0</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --font-main: "Sarabun", sans-serif;
      --primary: #003d82; 
      --primary-light: #0d6efd; 
      --bg: #f4f6f9;
      --text: #2c3e50;
      --ha-color: #ffebee;
      --cool-color: #e3f2fd;
    }
    
    body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); padding-bottom: 50px; user-select: none; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes blink { 50% { opacity: 0.5; } }
    .blink { animation: blink 1s linear infinite; background: red; color: white; border-radius: 4px; padding: 2px 4px; }

    #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; }

    /* Navbar */
    .app-nav { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--primary); color: white; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .nav-brand { font-weight: 600; font-size: 1.1rem; }
    .profile-mini { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
    .profile-mini img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid white; }
    
    /* Box Scroller */
    .box-scroller { display: flex; overflow-x: auto; padding: 10px; gap: 8px; scrollbar-width: none; }
    .box-btn { 
      min-width: 85px; padding: 8px; 
      background: var(--primary); 
      color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; 
      text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; position: relative;
    }
    .box-btn.active { 
        background: white; color: var(--primary); border: 2px solid var(--primary); transform: scale(1.05); 
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .box-icon { font-size: 2.2rem; margin-bottom: 0px; display: block; line-height: 1; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }
    .box-btn .badge-exp { position: absolute; top: -5px; right: -5px; font-size: 9px; padding: 2px 4px; border-radius: 4px; background: red; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }

    /* Grid & Cards */
    .drug-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
    .drug-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; display: flex; flex-direction: column; }
    .drug-img-wrap { 
        width: 100%; aspect-ratio: 1/1; 
        background: #bebdbe; 
        display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #f8f8f8; padding: 5px; 
    }
    .drug-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; background: white; }
    .drug-img.loading { opacity: 0.5; filter: blur(2px); }
    .drug-info { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; background: white; }
    
    /* Bottom Nav */
    .btm-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 50px; background: var(--primary); display: flex; justify-content: space-around; align-items: flex-end; z-index: 1000; padding-bottom: 2px; }
    .nav-item { text-align: center; color: rgba(255,255,255,0.6); font-size: 0.7rem; width: 25%; cursor: pointer; transition: 0.2s; padding-bottom: 4px; }
    .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 0; }
    .nav-item.active { color: white; font-weight: 600; }
    .nav-badge { position: absolute; top: 2px; right: 15px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 1px solid white; }

    /* Stock View */
    .shelf-row-label { 
        font-weight: bold; margin: 10px 0; padding-left: 10px; 
        border-left: 4px solid var(--primary); color: #333; 
        width: 100%; border-bottom: 2px solid #555; padding-bottom: 5px; 
    }
    .shelf-item { 
        position: relative; border:1px solid #eee; border-radius:8px; padding:5px; text-align:center; background: white; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.08); width: 31%; max-width: 130px; margin-bottom: 5px; 
    }
    .shelf-item img { width: 90px; height: 90px; object-fit: cover; border-radius: 6px; margin-bottom: 5px; background: #bebdbe; }
    .bg-ha { background-color: var(--ha-color); border: 1px solid red; }
    .bg-cool { background-color: var(--cool-color); border: 1px solid #2196f3; }
    .exp-badge-stock { position: absolute; top: 0; right: 0; font-size: 10px; padding: 2px 4px; border-radius: 0 8px 0 4px; color: white; font-weight: bold; z-index: 5; }

    .row-expired { background-color: #ffebee; border-left: 3px solid red; color: red; font-weight: bold; }
    
    .fab-print { position: fixed; bottom: 70px; left: 15px; background: #333; color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    .fab-edit-lg { position: fixed; bottom: 70px; right: 15px; background: var(--primary); color: white; border-radius: 30px; padding: 8px 16px; display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.3); font-weight: bold; z-index: 900; cursor: pointer; }
    
    .card-wait { background-color: #fffde7; border-left: 4px solid #fbc02d; }
    .card-done { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
    .card-recv { background-color: #e3f2fd; border-left: 4px solid #2196f3; }

    .qty-wrap { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 20px; padding: 2px; margin-top: auto; }
    .btn-qty { width: 32px; height: 32px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--primary); font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; user-select: none; }
    .btn-qty:active { background: #eee; }
    .inp-qty { width: 40px; border: none; background: transparent; text-align: center; font-weight: bold; font-size: 1.1rem; }
  </style>
</head>
<body>

  <div id="login-overlay"><div class="text-center fade-in"><div style="font-size:3rem;color:var(--primary);margin-bottom:10px">üíä</div><h4 class="fw-bold mb-1">Sawee Rxfill 2.0</h4><div id="status-text" class="text-primary small mt-3 fw-bold">Connecting...</div></div></div>

  <!-- Profile Modal -->
  <div class="modal fade" id="mdlProfile"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div class="mb-2"><label class="small">Username</label><input id="pf-user" class="form-control"></div>
    <div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input id="pf-name" class="form-control"></div>
    <div class="mb-2"><label class="small">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Substock)</label><textarea id="pf-sub" class="form-control" rows="2"></textarea></div>
    <div class="mb-2"><label class="small">Password</label><input id="pf-pass" class="form-control"></div>
    <div class="mb-2"><label class="small">Email</label><input id="pf-email" class="form-control"></div>
    <button onclick="saveProfile()" class="btn btn-primary w-100 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div></div></div></div>

  <!-- App Main -->
  <div id="app-main" class="hidden">
    <nav class="app-nav">
      <div class="nav-brand">Sawee Rxfill 2.0</div>
      <div class="d-flex align-items-center gap-2">
         <div class="profile-mini" onclick="openProfile()"><img id="nav-img" src="" referrerpolicy="no-referrer"><span id="nav-name">User</span></div>
         <div style="position:relative;padding:5px;" onclick="openStickerModal()">
            <i class="fas fa-print" style="font-size:1.3rem;"></i>
            <div id="badge-sticker" class="badge bg-warning text-dark rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
         <div style="position:relative;padding:5px;" onclick="openCart()">
            <i class="fas fa-shopping-basket" style="font-size:1.3rem;"></i>
            <div id="badge" class="badge bg-danger rounded-circle position-absolute top-0 end-0 hidden" style="font-size:9px">0</div>
         </div>
      </div>
    </nav>

    <div class="tab-content" style="padding-top:60px">
      <!-- Order Tab -->
      <div id="tab-order" class="page-sec">
        <div id="box-scroller-order" class="box-scroller"></div>
        <div class="px-3 py-2 sticky-top bg-white shadow-sm" style="top:50px;z-index:900">
           <input type="text" id="order-search" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ..." onkeyup="filterOrder()">
        </div>
        <div id="order-grid" class="drug-grid"><div class="text-center w-100 mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div></div>
      </div>

      <!-- Stock Tab -->
      <div id="tab-stock" class="page-sec hidden">
        <div id="group-filter" class="d-flex gap-2 px-3 pb-2 overflow-auto" style="white-space:nowrap"></div>
        <div id="box-scroller-stock" class="box-scroller"></div>
        <div id="stock-content" class="pb-5 px-3 d-flex flex-wrap gap-2 justify-content-start">
           <div class="text-center w-100 mt-5 text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
        </div>
        <div id="fab-print" class="fab-print hidden" onclick="openPrintLabel()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
        <div id="fab-edit" class="fab-edit-lg hidden" onclick="openBoxEditor()"><i class="fas fa-edit"></i> ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
      </div>

      <!-- Search Tab -->
      <div id="tab-search" class="page-sec hidden container pt-3">
         <h5 class="fw-bold text-primary mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤</h5>
         <div class="d-flex gap-2 mb-3">
             <div class="input-group shadow-sm rounded-pill flex-grow-1">
                <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                <input id="kw-realtime" class="form-control border-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤...">
             </div>
             <button class="btn btn-outline-primary rounded-pill px-3" onclick="doRealtimeSearch('SHOW_ALL')">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
         </div>
         <div id="realtime-res" class="bg-white rounded shadow-sm p-2"></div>
         <div class="fab-edit-lg" onclick="openMasterEdit({isNew:true})"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
      </div>

      <!-- History Tab -->
      <div id="tab-hist" class="page-sec hidden container pt-2">
         <ul class="nav nav-tabs nav-fill mb-3">
            <li class="nav-item"><a class="nav-link active" onclick="filterHist('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤',this)">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ <span id="bg-wait" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',this)">‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à <span id="bg-done" class="tab-badge">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="filterHist('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß',this)">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß <span id="bg-recv" class="tab-badge">0</span></a></li>
         </ul>
         <div id="hist-msg" class="alert alert-info text-center small py-2 mb-2"></div>
         <div id="hist-res"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="btm-nav">
    <div class="nav-item active" onclick="nav('tab-order', this)"><i class="fas fa-pills"></i>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤</div>
    <div class="nav-item" onclick="nav('tab-stock', this)"><i class="fas fa-cubes"></i>‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    <div class="nav-item" onclick="nav('tab-search', this)"><i class="fas fa-search"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
    <div class="nav-item" style="position:relative" onclick="nav('tab-hist', this); loadHist()">
        <i class="fas fa-history"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å
        <div id="nav-badge-hist" class="nav-badge hidden"></div>
    </div>
  </div>

  <!-- Cart Offcanvas -->
  <div class="offcanvas offcanvas-bottom rounded-top-4" id="cartSheet" style="height:85vh;z-index:2000"><div class="offcanvas-header border-bottom"><h5 class="fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5><button class="btn-close" data-bs-dismiss="offcanvas"></button></div><div class="offcanvas-body d-flex flex-column p-0 bg-light"><div id="cart-list" class="flex-grow-1 overflow-auto p-3"></div><div class="p-3 bg-white shadow-lg mt-auto"><div class="d-flex justify-content-between fw-bold mb-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-primary" id="cart-sum">0.00</span></div><div class="border rounded p-2 mb-3 bg-white"><small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</small><canvas id="cvs" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvs()">‡∏•‡πâ‡∏≤‡∏á</small></div></div><button id="btn-submit-order" onclick="submitOrder()" class="btn btn-primary w-100 rounded-pill py-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button></div></div></div>

  <!-- Sticker Modal -->
  <div class="modal fade" id="mdlSticker"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤ (Sticker Pool)</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="sticker-list" class="list-group mb-3"></div><button onclick="generateStickerPdf()" class="btn btn-warning w-100 text-dark fw-bold"><i class="fas fa-print"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF</button></div></div></div></div>

  <!-- MODALS -->
  <div class="modal fade" id="mdlRegister" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-light border-0"><h5 class="fw-bold text-primary">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h5></div><div class="modal-body p-4"><div class="text-center mb-3"><img id="reg-img" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)"></div><form id="form-reg"><input id="reg-username" class="form-control mb-3" placeholder="Username *" required><input id="reg-name" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *" required><input id="reg-email" class="form-control mb-3" placeholder="Email"><div class="mb-3"><label class="small fw-bold text-muted">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label><div class="p-2 border rounded bg-white" style="max-height:150px;overflow-y:auto"><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤ER</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤LR</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏ä‡∏≤‡∏¢</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤WARD‡∏´‡∏ç‡∏¥‡∏á</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏¢‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢</label></div><div class="form-check"><input class="form-check-input chk-sub" type="checkbox" value="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å"><label>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</label></div></div></div><button type="submit" class="btn btn-primary w-100 rounded-pill">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button></form></div></div></div></div>
  <div class="modal fade" id="mdlBoxEdit" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><div class="card p-3 mb-3 border-0 shadow-sm"><label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á</label><input id="edit-box-name" class="form-control fw-bold mb-2"><label class="small text-muted">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πà‡∏≠‡∏á</label><div class="d-flex gap-2"><input type="file" id="inp-box-file" class="form-control" accept="image/*" onchange="uploadBoxImg(this)"><input id="edit-box-img" type="hidden"><img id="preview-box-img" src="" referrerpolicy="no-referrer" style="width:40px;height:40px;border-radius:4px;object-fit:cover;border:1px solid #ddd"></div><button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveBoxInfo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πà‡∏≠‡∏á</button></div><div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</h6><button class="btn btn-sm btn-success rounded-pill" onclick="mdlAddItem.show()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button></div><div id="edit-box-items" class="row g-2"></div></div></div></div></div>
  <div class="modal fade" id="mdlMasterEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h6 class="fw-bold m-0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (Master)</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="mst-isnew"><div class="mb-2"><label class="small">Item ID</label><input id="mst-id" class="form-control fw-bold"></div><div class="mb-2 text-center"><img id="mst-img-preview" src="" referrerpolicy="no-referrer" style="height:100px;border-radius:8px;background:#bebdbe"><input type="file" class="form-control mt-2" accept="image/*" onchange="uploadMasterImg(this)"><input type="hidden" id="mst-img-path"></div><div class="mb-2"><label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input id="mst-name" class="form-control"></div><div class="row g-2 mb-2"><div class="col-6"><label class="small">Unit</label><input id="mst-unit" class="form-control"></div><div class="col-6"><label class="small">Price</label><input id="mst-price" type="number" class="form-control"></div></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-ha"><label class="form-check-label text-danger fw-bold">High Alert</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-pl"><label class="form-check-label text-warning fw-bold">Protect Light</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="mst-kc"><label class="form-check-label text-info fw-bold">Keep Cool (2-8¬∞C)</label></div><button class="btn btn-primary w-100 mt-3" onclick="saveMasterItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>
  <div class="modal fade" id="mdlEdit"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 shadow"><div class="modal-body text-center p-4"><input type="hidden" id="ed-id"><input type="hidden" id="ed-itemid"><h6 id="ed-name" class="mb-3 text-primary fw-bold text-start"></h6><div class="row g-2 mb-3"><div class="col-6"><label class="small text-muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="ed-amt" class="form-control fw-bold text-center text-primary"></div><div class="col-6"><label class="small text-muted">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="date" id="ed-exp" class="form-control text-center" onchange="calcExpDays()"></div></div><div class="mt-2 text-center" id="ed-days-left"></div><div class="mt-2 small text-muted text-center">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <span id="ed-change" class="fw-bold">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="ed-time">-</span>)</div><button onclick="saveEdit()" class="btn btn-primary w-100 rounded-pill mt-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><div class="border-top mt-3 pt-3"><div class="d-flex gap-2"><input id="stk-qty" type="number" class="form-control" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå"><button class="btn btn-warning" onclick="addToStickerCartFromEdit()"><i class="fas fa-print"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div></div></div></div></div></div>
  <div class="modal fade" id="mdlAddItem" style="z-index:2100"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="search-master" class="form-control mb-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." onkeyup="searchMasterDebounce()"><div id="master-res" class="list-group" style="max-height:250px;overflow-y:auto"></div></div></div></div></div>
  
  <!-- Sign Label Modal -->
  <div class="modal fade" id="mdlSignLabel" style="z-index:2200"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h6><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><small class="text-muted d-block">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£:</small><canvas id="cvs-label" style="width:100%;height:100px;background:#f8f9fa;border-radius:8px;border:1px dashed #ccc"></canvas><div class="text-center my-2 text-primary" id="lbl-signer"></div><div class="text-end"><small class="text-danger cursor-pointer" onclick="clrCvsLabel()">‡∏•‡πâ‡∏≤‡∏á</small></div><button onclick="submitLabel()" class="btn btn-success w-100 mt-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</button><button id="btn-prev-label" class="btn btn-outline-secondary w-100 mt-2" style="display:none"></button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwNMk59pHTzZJTCUZfGoFd_NmjdYrwyTesFqMz4DriMnHFCIr_NMrrpBsp_p4zq7inN1A/exec';
  const DEFAULT_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
  let liffId = "2008862022-cDOpEP9z";
  let currentUser = {}, items=[], cart=[], stickerCart=[], curBoxOrder='', curBoxStock='';
  let allBoxes = [], allHistory = [];
  let offC, mdlEdit, mdlReg, mdlBoxEdit, mdlAddItem, mdlMasterEdit, mdlProfile, mdlSignLabel, mdlSticker;
  let searchTimeout;

  async function callApi(action, payload = {}) {
     try {
       const res = await fetch(GAS_URL, { method: 'POST', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, ...payload }) });
       const text = await res.text();
       try { return JSON.parse(text); } catch(e) { if(text.includes("Service is")) throw new Error("DEPLOYMENT_ERR"); throw new Error(text.substr(0,50)); }
     } catch(e) {
       if(e.message=="DEPLOYMENT_ERR") Swal.fire('Error','Deploy ‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Execute as Me / Anyone','error');
       return { status: 'error', message: e.message };
     }
  }

  // --- INIT ---
  window.onload = async () => {
     offC = new bootstrap.Offcanvas('#cartSheet'); mdlEdit = new bootstrap.Modal('#mdlEdit'); mdlReg = new bootstrap.Modal('#mdlRegister'); 
     mdlBoxEdit = new bootstrap.Modal('#mdlBoxEdit'); mdlAddItem = new bootstrap.Modal('#mdlAddItem'); mdlMasterEdit = new bootstrap.Modal('#mdlMasterEdit'); 
     mdlProfile = new bootstrap.Modal('#mdlProfile'); mdlSignLabel = new bootstrap.Modal('#mdlSignLabel'); mdlSticker = new bootstrap.Modal('#mdlSticker');
     
     if(document.getElementById('form-reg')) document.getElementById('form-reg').onsubmit = async (e) => { e.preventDefault(); const subs = Array.from(document.querySelectorAll('.chk-sub:checked')).map(c=>c.value); if(!subs.length) return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'); Swal.showLoading(); const res = await callApi('registerUser', { username: document.getElementById('reg-username').value, name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value, substock: subs, userId: currentUser.userId, photo: currentUser.photo }); if(res.status) location.reload(); };
     document.getElementById('kw-realtime').addEventListener('keyup', (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => doRealtimeSearch(e.target.value), 500); });
     initCvs(); initCvsLabel();
     
     const params = new URLSearchParams(window.location.search);
     const boxIdParam = params.get('boxId');

     try { await liff.init({ liffId }); if(!liff.isLoggedIn()) liff.login(); else { const profile = await liff.getProfile(); currentUser.photo = profile.pictureUrl; checkUser(profile.userId, boxIdParam); } } catch(e) { document.getElementById('status-text').innerHTML = `<span class="text-danger">${e.message}</span>`; }
  };

  async function checkUser(uid, boxParam) {
     const res = await callApi('checkUserLIFF', { userId: uid });
     if (res.status === 'NOT_FOUND') { document.getElementById('login-overlay').classList.add('hidden'); document.getElementById('reg-img').src = currentUser.photo || DEFAULT_IMG; mdlReg.show(); }
     else if (res.status === 'FOUND') { currentUser = { ...res.userData, userId: uid }; startApp(boxParam); }
  }

  function openProfile() {
     document.getElementById('pf-user').value = currentUser.username;
     document.getElementById('pf-name').value = currentUser.name;
     document.getElementById('pf-sub').value = currentUser.substock;
     document.getElementById('pf-pass').value = currentUser.password;
     document.getElementById('pf-email').value = currentUser.email;
     mdlProfile.show();
  }
  async function saveProfile() {
     const pl = { userId: currentUser.userId, username: document.getElementById('pf-user').value, name: document.getElementById('pf-name').value, substock: document.getElementById('pf-sub').value, password: document.getElementById('pf-pass').value, email: document.getElementById('pf-email').value };
     const res = await callApi('updateUserProfile', pl);
     if(res.status) location.reload(); else Swal.fire(res.message);
  }

  async function startApp(boxParam) {
     document.getElementById('login-overlay').classList.add('hidden'); document.getElementById('app-main').classList.remove('hidden');
     document.getElementById('nav-img').src = currentUser.photo || DEFAULT_IMG; document.getElementById('nav-name').innerText = currentUser.name.split(' ')[0];
     
     const resOrder = await callApi('getBoxes', { substock: currentUser.substock, showAll: false });
     if(resOrder.status) renderBoxScroller('order', resOrder.boxes);
     const resStock = await callApi('getBoxes', { showAll: true });
     if(resStock.status) { allBoxes = resStock.boxes; renderBoxScroller('stock', allBoxes); }
     const resGroups = await callApi('getBoxGroups');
     if(resGroups.status) { document.getElementById('group-filter').innerHTML = `<div class="badge rounded-pill bg-primary cursor-pointer p-2" onclick="filterStockBox('ALL',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>` + resGroups.groups.map(g=>`<div class="badge rounded-pill bg-white text-dark border cursor-pointer p-2" onclick="filterStockBox('${g}',this)">${g}</div>`).join(''); }
     
     loadHist(); 

     if(boxParam) {
        if(allBoxes.length) {
            const box = allBoxes.find(b=>b.id===boxParam);
            if(box) { nav('tab-stock', document.querySelectorAll('.nav-item')[1]); selBox(box.name, null, 'stock', box.imageRaw); }
        }
     }
  }

  function getBoxIcon(type) {
     const t = (type || "").toLowerCase();
     if(t.includes('cart') || t.includes('‡∏£‡∏ñ')) return 'üõí';
     if(t.includes('fridge') || t.includes('‡πÄ‡∏¢‡πá‡∏ô')) return 'üßä';
     if(t.includes('carbinet') || t.includes('cabinet') || t.includes('‡∏ï‡∏π‡πâ')) return 'üóÑÔ∏è';
     return 'üì¶';
  }

  function renderBoxScroller(mode, boxes) {
     const el = document.getElementById(`box-scroller-${mode}`);
     el.innerHTML = boxes.map(b=>`
       <div class="box-btn" onclick="selBox('${b.name}', this, '${mode}', '${b.imageRaw}')">
          <span class="box-icon">${getBoxIcon(b.type)}</span>
          <span style="font-size:0.75rem;line-height:1.1;font-weight:600">${b.name}</span>
          ${b.hasExpired ? '<span class="badge-exp blink">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>' : ''}
       </div>`).join('');
  }

  function filterStockBox(group, el) {
      const p = el.parentElement; Array.from(p.children).forEach(x=> { x.classList.remove('bg-primary','text-white'); x.classList.add('bg-white','text-dark'); });
      el.classList.remove('bg-white','text-dark'); el.classList.add('bg-primary','text-white');
      const filtered = (group==='ALL') ? allBoxes : allBoxes.filter(b=>b.group===group);
      renderBoxScroller('stock', filtered);
  }

  function nav(pid, el){
     document.querySelectorAll('.page-sec').forEach(x=>x.classList.add('hidden')); document.getElementById(pid).classList.remove('hidden');
     document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active');
  }

  async function selBox(name, el, mode, imgRaw) {
     document.querySelectorAll(`#box-scroller-${mode} .box-btn`).forEach(x=>x.classList.remove('active')); 
     if(el) el.classList.add('active');
     if(mode==='order') {
        if(cart.length && curBoxOrder!=name && !confirm('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á?')) return;
        if(cart.length && curBoxOrder!=name) { cart=[]; badge(); }
        curBoxOrder = name; loadOrderItems(name);
     } else {
        curBoxStock = name;
        document.getElementById('fab-edit').classList.remove('hidden');
        document.getElementById('fab-print').classList.remove('hidden');
        document.getElementById('edit-box-name').value = name;
        document.getElementById('edit-box-img').value = imgRaw;
        document.getElementById('preview-box-img').src = DEFAULT_IMG;
        if(imgRaw) callApi('resolveImage',{input:imgRaw}).then(r=>{if(r.status) document.getElementById('preview-box-img').src=r.src});
        
        const boxObj = allBoxes.find(b=>b.name === name);
        const prevBtn = document.getElementById('btn-prev-label');
        if(boxObj && boxObj.lastPdf) {
           prevBtn.style.display = 'block';
           prevBtn.onclick = () => window.open(boxObj.lastPdf, '_blank');
           prevBtn.innerHTML = `‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${boxObj.lastCheck || '-'})`;
        } else { prevBtn.style.display = 'none'; }

        loadStockItems(name);
     }
  }

  async function loadOrderItems(box) {
     document.getElementById('order-grid').innerHTML = Array(4).fill('<div class="skeleton mb-2"></div>').join('');
     const res = await callApi('getItems', { boxName: box });
     items = res.status ? res.data.map(x=>({...x, req:1})) : [];
     renderOrder(); lazyLoad();
  }
  
  async function loadStockItems(box) {
      const el = document.getElementById('stock-content'); el.innerHTML = '<div class="text-center mt-5 text-muted">Loading...</div>';
      const res = await callApi('getItems', { boxName: box });
      if(!res.status) return el.innerHTML = 'Error';
      
      let totalChanges = 0;
      let lastCheck = '-';
      const boxObj = allBoxes.find(b=>b.name === box);
      if(boxObj) { lastCheck = boxObj.lastCheck; }
      res.data.forEach(i => totalChanges += (i.changeCount || 0));

      let h = `<div class="h5 fw-bold text-dark mb-1 w-100"><i class="fas fa-box"></i> ${box}</div>
               <div class="small text-muted mb-3 border-bottom pb-2 w-100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${totalChanges} | ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastCheck}</div>`;
      
      let rows={}; res.data.forEach(i=>{ let k=i.row||'Other'; if(!rows[k])rows[k]=[]; rows[k].push(i); });
      Object.keys(rows).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true})).forEach(r=>{
         h+=`<div class="shelf-row-label">‡∏ä‡∏±‡πâ‡∏ô/‡πÅ‡∏ñ‡∏ß: ${r}</div><div class="d-flex flex-wrap gap-2 mt-2 w-100">`;
         h+=rows[r].map(i=> {
           let cls = i.highAlert ? 'bg-ha' : (i.keepCool ? 'bg-cool' : '');
           let icon = i.protectLight ? '<i class="fas fa-sun icon-protect"></i>' : '';
           let expTag = '';
           if(i.expire) {
              const diff = (new Date(i.expire) - new Date())/(1000*3600*24);
              if(diff < 0) expTag = '<span class="exp-badge-stock bg-danger blink">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>';
              else if(diff < 30) expTag = '<span class="exp-badge-stock bg-danger">Exp<30d</span>';
              else if(diff < 180) expTag = '<span class="exp-badge-stock bg-warning text-dark">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>';
           }
           return `<div class="shelf-item ${cls}" style="width:31%;max-width:130px;" onclick="editStk('${i.invId}','${i.name}','${i.itemId}',${i.amount},'${i.expire}',${i.changeCount},'${i.lastChange}')">${i.highAlert ? '<div class="badge-ha">HA</div>' : ''}${expTag}<img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer"><div class="small text-truncate fw-bold" style="font-size:0.75rem">${i.name}</div><div class="d-flex justify-content-between align-items-center mt-1"><span class="badge bg-secondary">${i.amount}</span><span class="text-muted" style="font-size:9px">${i.expire || '-'} ${icon}</span></div></div>`
         }).join('');
         h+='</div>';
      });
      el.innerHTML = h || '<div class="text-center mt-5 text-muted">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>';
      
      const editHtml = res.data.map(i=>`<div class="col-12 d-flex align-items-center bg-white border p-2 rounded mb-1"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="lazy" referrerpolicy="no-referrer" style="width:40px;height:40px;object-fit:cover;border-radius:4px;background:#bebdbe"><div class="flex-grow-1 ms-2 small"><div class="fw-bold text-truncate">${i.name}</div><div class="d-flex gap-2 align-items-center mt-1"><input class="form-control form-control-sm" style="width:70px" type="number" value="${i.amount}" onchange="updateInv('${i.invId}', 'amount', this.value)" placeholder="Qty"><input class="form-control form-control-sm" style="width:120px" value="${i.location}" onchange="updateInv('${i.invId}', 'location', this.value)" placeholder="Loc"></div></div><button class="btn btn-sm btn-outline-danger ms-2" onclick="removeBoxItem('${i.invId}')"><i class="fas fa-trash"></i></button></div>`).join('');
      document.getElementById('edit-box-items').innerHTML = editHtml;
      lazyLoad();
  }

  async function updateInv(id, field, val) { let pl = {invId:id}; pl[field]=val; await callApi('updateInventoryDetail', pl); }

  function renderOrder() {
     const kw = document.getElementById('order-search').value.toLowerCase();
     const html = items.filter(i=>i.name.toLowerCase().includes(kw)).map(i=>`<div class="drug-card"><div class="drug-img-wrap"><img src="${DEFAULT_IMG}" data-raw="${i.imageRaw}" class="drug-img lazy loading" referrerpolicy="no-referrer"></div><div class="drug-info"><div class="drug-name">${i.name}</div><div class="d-flex justify-content-between small text-muted mb-2"><span>‡∏°‡∏µ: ${i.amount}</span><span class="text-primary fw-bold">${i.price} ‡∏ö.</span></div><div class="qty-wrap"><div class="btn-qty" onclick="adj('${i.itemId}',-1)">-</div><input class="inp-qty" id="qty-${i.itemId}" value="${i.req}" readonly><div class="btn-qty" onclick="adj('${i.itemId}',1,${i.amount})">+</div></div><button class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold" onclick="addCart('${i.itemId}')">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button></div></div>`).join('');
     document.getElementById('order-grid').innerHTML = html || '<div class="text-center mt-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤</div>';
  }

  // --- Sticker Pool Logic ---
  function openStickerModal() {
     const list = document.getElementById('sticker-list');
     if(stickerCart.length === 0) list.innerHTML = '<div class="text-center p-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</div>';
     else {
        list.innerHTML = stickerCart.map((s,i) => `
          <div class="list-group-item d-flex justify-content-between align-items-center">
             <div>${s.name} <span class="badge bg-secondary">x${s.qty}</span></div>
             <i class="fas fa-trash text-danger cursor-pointer" onclick="stickerCart.splice(${i},1); updateStickerBadge(); openStickerModal()"></i>
          </div>
        `).join('');
     }
     mdlSticker.show();
  }
  
  function addToStickerCartFromEdit() {
     const id = document.getElementById('ed-itemid').value;
     const name = document.getElementById('ed-name').innerText;
     const qty = document.getElementById('stk-qty').value;
     if(!qty || qty <= 0) return Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
     
     stickerCart.push({ itemId: id, name: name, qty: qty });
     updateStickerBadge();
     Swal.fire({icon:'success', title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß', timer:1000, showConfirmButton:false});
  }

  function updateStickerBadge() {
     const b = document.getElementById('badge-sticker');
     b.innerText = stickerCart.length;
     if(stickerCart.length > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
  }

  async function generateStickerPdf() {
     if(stickerCart.length === 0) return;
     Swal.fire({title:'Generating PDF...', didOpen:()=>Swal.showLoading()});
     // Expand cart based on qty? Or just pass as list? The requirement implies "1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏≠ 1 ‡∏´‡∏ô‡πâ‡∏≤"
     // If user inputs "5", does it mean 5 pages? Or just "Amount: 5" on sticker? 
     // "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏à‡∏ô‡∏û‡∏≠‡πÉ‡∏à... 1 ‡∏¢‡∏≤‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô" -> Likely separate pages. 
     // We'll pass the list to backend, backend loops.
     let expandList = [];
     stickerCart.forEach(s => {
         for(let i=0; i<s.qty; i++) expandList.push({ itemId: s.itemId, name: s.name });
     });
     
     const res = await callApi('generateLabelPdf', { items: expandList });
     if(res.status) {
         stickerCart = []; updateStickerBadge(); mdlSticker.hide();
         Swal.fire({ icon:'success', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary w-100">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏â‡∏•‡∏≤‡∏Å</a>` });
     } else Swal.fire('Error', res.message, 'error');
  }

  async function doRealtimeSearch(kw) {
     if(!kw) return document.getElementById('realtime-res').innerHTML = '';
     const res = await callApi('searchDrugDetails', { kw });
     if(res.status) {
        document.getElementById('realtime-res').innerHTML = res.data.map(d => {
           let rows = d.locations.map(l => {
              let cls = ''; const diff = (new Date(l.expire) - new Date())/(1000*3600*24);
              if(diff < 0) cls = 'row-expired'; 
              return `<tr class="${cls}"><td>${l.box}</td><td>${l.amount}</td><td>${l.expire}</td></tr>`;
           }).join('');
           return `<div class="mb-3 border-bottom pb-2"><div class="d-flex gap-2"><img src="${DEFAULT_IMG}" data-raw="${d.imageRaw}" class="lazy" referrerpolicy="no-referrer" style="width:60px;height:60px;border-radius:4px;object-fit:cover;background:#bebdbe"><div class="flex-grow-1"><div class="fw-bold text-primary">${d.name} <span class="badge bg-info text-dark">‡∏£‡∏ß‡∏° ${d.totalQty}</span></div><div class="small text-muted mb-1">${d.itemId}</div><table class="table table-sm table-custom mb-0"><thead><tr><th>‡∏Å‡∏•‡πà‡∏≠‡∏á</th><th>‡∏à‡∏ô.</th><th>Exp</th></tr></thead><tbody>${rows}</tbody></table></div><button class="btn btn-sm btn-outline-secondary align-self-start" onclick='openMasterEdit(${JSON.stringify(d).replace(/'/g, "&apos;")})'><i class="fas fa-edit"></i></button></div></div>`;
        }).join('');
        lazyLoad();
     }
  }

  function openMasterEdit(item) {
     document.getElementById('mst-isnew').value = item.isNew ? 'true' : 'false';
     document.getElementById('mst-id').value = item.itemId || ''; document.getElementById('mst-id').disabled = !item.isNew;
     document.getElementById('mst-name').value = item.name || ''; document.getElementById('mst-img-path').value = item.imageRaw || ''; document.getElementById('mst-unit').value = item.unit || ''; document.getElementById('mst-price').value = item.price || '';
     document.getElementById('mst-ha').checked = item.highAlert; document.getElementById('mst-pl').checked = item.protectLight; document.getElementById('mst-kc').checked = item.keepCool;
     const imgEl = document.getElementById('mst-img-preview'); imgEl.src = DEFAULT_IMG;
     if(item.imageRaw) callApi('resolveImage',{input:item.imageRaw}).then(r=>{if(r.status) imgEl.src=r.src});
     mdlMasterEdit.show();
  }

  async function uploadMasterImg(input) {
     const file = input.files[0]; if(!file) return;
     const reader = new FileReader();
     reader.onload = async (e) => {
        document.getElementById('mst-img-preview').src = e.target.result;
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'DRUG', name: file.name });
        if(res.status) { document.getElementById('mst-img-path').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
     }; reader.readAsDataURL(file);
  }

  async function saveMasterItem() {
     const payload = { isNew: document.getElementById('mst-isnew').value==='true', itemId: document.getElementById('mst-id').value, name: document.getElementById('mst-name').value, image: document.getElementById('mst-img-path').value, unit: document.getElementById('mst-unit').value, price: document.getElementById('mst-price').value, highAlert: document.getElementById('mst-ha').checked, protectLight: document.getElementById('mst-pl').checked, keepCool: document.getElementById('mst-kc').checked };
     const res = await callApi('updateMasterItem', payload); if(res.status) { Swal.fire('Saved'); mdlMasterEdit.hide(); }
  }

  function openBoxEditor() { mdlBoxEdit.show(); }
  async function uploadBoxImg(input) {
     const file = input.files[0]; if(!file) return;
     const reader = new FileReader();
     reader.onload = async (e) => {
        document.getElementById('preview-box-img').src = e.target.result;
        Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
        const res = await callApi('uploadImage', { base64: e.target.result, folderType: 'BOX', name: file.name });
        if(res.status) { document.getElementById('edit-box-img').value = res.path; Swal.close(); } else Swal.fire('Upload Failed');
     }; reader.readAsDataURL(file);
  }
  async function saveBoxInfo() {
     if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?')) return;
     const newN = document.getElementById('edit-box-name').value; const newI = document.getElementById('edit-box-img').value;
     const res = await callApi('updateBoxInfo', { oldName: curBoxStock, newName: newN, newImage: newI });
     if(res.status) { Swal.fire('Saved'); curBoxStock=newN; location.reload(); }
  }
  async function searchMasterDebounce() { clearTimeout(searchTimeout); searchTimeout = setTimeout(searchMaster, 500); }
  async function searchMaster() {
     const k = document.getElementById('search-master').value; 
     const res = await callApi('searchMasterItems', { kw: k || "" });
     if(res.data) {
        document.getElementById('master-res').innerHTML = res.data.map(i=>`<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="addItemToBox('${i.id}')"><div class="d-flex align-items-center gap-2"><img src="${DEFAULT_IMG}" data-raw="${i.image}" class="lazy" referrerpolicy="no-referrer" style="width:30px;height:30px;border-radius:4px;object-fit:cover;background:#bebdbe"><span class="small">${i.name}</span></div><i class="fas fa-plus-circle text-success"></i></button>`).join('');
        lazyLoad();
     }
  }
  async function addItemToBox(itemId) { 
      const amt = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', '1'); 
      if(!amt) return; 
      const res = await callApi('addBoxItem', { boxName: curBoxStock, itemId, amount: amt }); 
      if(res.status) { loadStockItems(curBoxStock); mdlAddItem.hide(); } 
  }
  async function removeBoxItem(invId) { if(!confirm('‡∏•‡∏ö‡∏¢‡∏≤‡∏ô‡∏µ‡πâ?')) return; const res = await callApi('removeBoxItem', { invId }); if(res.status) loadStockItems(curBoxStock); }
  function adj(id, v, max) { let i = items.find(x=>x.itemId==id); if(!i) return; let n = i.req + v; if(n<1)n=1; if(max && n>max) { n=max; Swal.fire({toast:true,position:'center',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); } i.req = n; document.getElementById(`qty-${id}`).value = n; }
  function addCart(id) { let i = items.find(x=>x.itemId==id); let ex = cart.find(x=>x.itemId==id); if(ex) { if(ex.qty+i.req > i.amount) return Swal.fire({toast:true,position:'center',icon:'warning',title:'‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'}); ex.qty+=i.req; } else cart.push({...i, qty:i.req}); badge(); const b=document.querySelector('.fa-shopping-basket'); b.style.transform='scale(1.4)'; setTimeout(()=>b.style.transform='scale(1)',200); i.req=1; document.getElementById(`qty-${id}`).value=1; }
  function badge() { let n=cart.length; document.getElementById('badge').innerText=n; n>0?document.getElementById('badge').classList.remove('hidden'):document.getElementById('badge').classList.add('hidden'); }
  function openCart(){ if(!cart.length) return Swal.fire('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); renderCart(); offC.show(); setTimeout(fixCvs,500); }
  function renderCart(){ let sum=0; document.getElementById('cart-list').innerHTML=cart.map((c,i)=>{ sum+=c.price*c.qty; return `<div class="bg-white p-3 mb-2 rounded border position-relative"><div class="fw-bold pe-4">${c.name}</div><div class="d-flex justify-content-between mt-2 small text-muted"><span>${c.price} x ${c.qty}</span> <span class="text-primary fw-bold">${(c.price*c.qty).toFixed(2)} ‡∏ö.</span></div><i class="fas fa-trash text-danger position-absolute top-0 end-0 m-3 cursor-pointer" onclick="cart.splice(${i},1);renderCart();badge();if(!cart.length)offC.hide()"></i></div>`; }).join(''); document.getElementById('cart-sum').innerText = sum.toFixed(2); }
  
  async function submitOrder() { 
     if(isCanvasBlank(canvas)) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠'); 
     const btn = document.getElementById('btn-submit-order'); btn.disabled=true;
     
     callApi('submitOrder', { orderData: { user: currentUser.name, box: curBoxOrder, items: cart, signature: canvas.toDataURL() } });
     
     cart=[]; badge(); offC.hide(); clrCvs(); btn.disabled=false;
     // Refresh History Badge & List
     loadHist();
     Swal.fire({
         icon:'success',
         title: '‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
         text: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å"',
         showConfirmButton: true
     });
  }
  
  function editStk(id,n,itm,a,e,cnt,time) { 
      document.getElementById('ed-id').value=id; 
      document.getElementById('ed-itemid').value=itm; 
      document.getElementById('ed-name').innerText=n; 
      document.getElementById('ed-amt').value=a; 
      document.getElementById('ed-exp').value=e; 
      document.getElementById('ed-change').innerText=cnt;
      document.getElementById('ed-time').innerText=time;
      calcExpDays();
      mdlEdit.show(); 
  }
  function calcExpDays() {
      const exp = document.getElementById('ed-exp').value;
      if(!exp) return document.getElementById('ed-days-left').innerText = "";
      const diff = Math.ceil((new Date(exp) - new Date()) / (1000 * 60 * 60 * 24));
      document.getElementById('ed-days-left').innerHTML = `‡∏≠‡∏µ‡∏Å <span class="${diff<0?'text-danger fw-bold':''}">${diff}</span> ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏`;
  }
  async function saveEdit() { const pl = { invId:document.getElementById('ed-id').value, amount:document.getElementById('ed-amt').value, expire:document.getElementById('ed-exp').value }; const res = await callApi('saveEditItem', pl); if(res.status) { mdlEdit.hide(); loadStockItems(curBoxStock); } }
  
  function loadHist() { 
     //document.getElementById('hist-res').innerHTML='Loading...'; 
     callApi('getHistory', {user:currentUser.name, substock:currentUser.substock}).then(res=>{ 
         if(res.status) { 
             allHistory = res.data; 
             const wait = allHistory.filter(r=>r.status.includes('‡∏£‡∏≠')).length;
             const done = allHistory.filter(r=>r.status.includes('‡πÄ‡∏™‡∏£‡πá‡∏à')).length;
             const recv = allHistory.filter(r=>r.status.includes('‡∏£‡∏±‡∏ö')).length;
             document.getElementById('bg-wait').innerText = wait; document.getElementById('bg-done').innerText = done; document.getElementById('bg-recv').innerText = recv;
             if(done > 0) { document.getElementById('nav-badge-hist').classList.remove('hidden'); document.getElementById('nav-badge-hist').innerText = done; } else { document.getElementById('nav-badge-hist').classList.add('hidden'); }
             renderHist('‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤'); 
         } 
     }); 
  }
  function filterHist(status, el) {
     document.querySelectorAll('.nav-tabs .nav-link').forEach(x=>x.classList.remove('active')); el.classList.add('active');
     renderHist(status);
  }
  function renderHist(status) {
     let filtered = allHistory;
     let msg = "";
     if(status === '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤') { filtered = allHistory.filter(r => r.status.includes('‡∏£‡∏≠')); msg = "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏£‡∏±‡∏ö order ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'"; }
     else if(status === '‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') { filtered = allHistory.filter(r => r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')); msg = "‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"; }
     else { filtered = allHistory.filter(r => r.status.includes('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö')); }
     
     document.getElementById('hist-msg').innerText = msg; document.getElementById('hist-msg').classList.toggle('hidden', msg === "");

     document.getElementById('hist-res').innerHTML = filtered.map(r=>{
        let action = ''; if(r.status.includes('‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à')) action = `<button class="btn btn-success w-100 fw-bold py-2 mt-2" style="font-size:1.2rem;" onclick="receiveOrder('${r.id}')">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>`;
        let itemList = r.items.map(i=> `<li>${i.name} (${i.qty}) - ${i.price}</li>`).join('').slice(0, 200) + (r.items.length > 5 ? '...' : '');
        let cardClass = r.status.includes('‡∏£‡∏≠') ? 'card-wait' : (r.status.includes('‡∏£‡∏±‡∏ö') ? 'card-recv' : 'card-done');
        
        return `<div class="card mb-2 p-2 shadow-sm ${cardClass}"><div class="d-flex justify-content-between align-items-center"><strong class="text-primary small text-truncate w-75">${r.id}</strong><small class="text-muted" style="font-size:10px">${r.time}</small></div><div class="small text-muted my-1"><i class="fas fa-box"></i> ${r.box}</div><ul class="small text-muted ps-3 mb-1" style="max-height:100px;overflow-y:auto">${itemList}</ul><div class="d-flex flex-column align-items-stretch"><div class="d-flex justify-content-between align-items-center"><small class="badge bg-light text-dark border">${r.status}</small><a href="${r.pdf}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill"><i class="fas fa-file-pdf"></i> PDF</a></div>${action}</div></div>`;
     }).join('') || '<div class="text-center text-muted mt-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
  }
  async function receiveOrder(oid) {
     if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô?')) return;
     const res = await callApi('updateOrderStatus', { orderId: oid, user: currentUser.name });
     if(res.status) { Swal.fire('Success'); loadHist(); }
  }

  // --- PRINT LABEL ---
  function openPrintLabel() { 
      document.getElementById('lbl-signer').innerText = currentUser.name;
      mdlSignLabel.show(); setTimeout(fixCvsLabel, 500); 
  }
  async function submitLabel() {
     if(isCanvasBlank(cvsLabel)) return Swal.fire('‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
     
     mdlSignLabel.hide(); // Close modal immediately
     Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', didOpen:()=>Swal.showLoading()});
     
     const sign = cvsLabel.toDataURL();
     const res = await callApi('generateBoxLabel', { boxName: curBoxStock, signBase64: sign, user: currentUser.name });
     if(res.status) {
        clrCvsLabel();
        Swal.fire({ icon:'success', title:'‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', html:`<a href="${res.pdf}" target="_blank" class="btn btn-primary">‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏õ‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á</a>` });
     } else Swal.fire('Error', res.message, 'error');
  }

  function filterOrder(){ renderOrder(); }
  function lazyLoad() { document.querySelectorAll('img.lazy').forEach(img => { if(img.dataset.loaded) return; const raw = img.dataset.raw; if(!raw || raw==='undefined' || raw==='') { img.classList.remove('loading'); return; } if(raw.startsWith('http')) { img.src=raw; img.classList.remove('loading'); img.dataset.loaded=true; return; } callApi('resolveImage', { input: raw }).then(res => { if(res.status) { img.src = res.src; img.classList.remove('loading'); img.dataset.loaded=true; } }); }); }
  
  let canvas, ctx, isDraw=false;
  let cvsLabel, ctxLabel, isDrawLabel=false;
  function initCvs(){ canvas=document.getElementById('cvs'); ctx=canvas.getContext('2d'); ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,s,{passive:false})); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,d,{passive:false})); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,()=>isDraw=false)); }
  function initCvsLabel(){ cvsLabel=document.getElementById('cvs-label'); ctxLabel=cvsLabel.getContext('2d'); ['mousedown','touchstart'].forEach(e=>cvsLabel.addEventListener(e,sL,{passive:false})); ['mousemove','touchmove'].forEach(e=>cvsLabel.addEventListener(e,dL,{passive:false})); ['mouseup','touchend'].forEach(e=>cvsLabel.addEventListener(e,()=>isDrawLabel=false)); }
  function fixCvs(){ canvas.width=canvas.offsetWidth; canvas.height=100; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; }
  function fixCvsLabel(){ cvsLabel.width=cvsLabel.offsetWidth; cvsLabel.height=100; ctxLabel.lineWidth=2; ctxLabel.lineCap='round'; ctxLabel.strokeStyle='#000'; }
  
  function s(e){ e.preventDefault(); isDraw=true; let r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function d(e){ if(!isDraw)return; e.preventDefault(); let r=canvas.getBoundingClientRect(); ctx.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctx.stroke(); }
  function sL(e){ e.preventDefault(); isDrawLabel=true; let r=cvsLabel.getBoundingClientRect(); ctxLabel.beginPath(); ctxLabel.moveTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); }
  function dL(e){ if(!isDrawLabel)return; e.preventDefault(); let r=cvsLabel.getBoundingClientRect(); ctxLabel.lineTo((e.touches?e.touches[0].clientX:e.clientX)-r.left, (e.touches?e.touches[0].clientY:e.clientY)-r.top); ctxLabel.stroke(); }
  
  function clrCvs(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
  function clrCvsLabel(){ ctxLabel.clearRect(0,0,cvsLabel.width,cvsLabel.height); }
  function isCanvasBlank(cv) { return !cv.getContext('2d').getImageData(0, 0, cv.width, cv.height).data.some(channel => channel !== 0); }
</script>
</body>
</html>