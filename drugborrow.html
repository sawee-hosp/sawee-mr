<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; padding-bottom: 80px; }
    .header-gradient { background: linear-gradient(135deg, #00416A 0%, #E4E5E6 100%); color: white; padding: 15px 0; margin-bottom: 20px; }
    .text-shadow { text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .hidden { display: none !important; }
    .btn-glam { background: linear-gradient(90deg, #1CB5E0 0%, #000851 100%); color: white; border: none; }
    
    /* Drug Row */
    .drug-row { background: #f8f9fa; border-left: 4px solid #0d6efd; padding: 10px; margin-bottom: 10px; border-radius: 5px; position: relative; }
    .remove-btn { position: absolute; top: 5px; right: 5px; color: red; cursor: pointer; }
    
    #sig-canvas { border: 2px dashed #999; border-radius: 5px; background: #fff; width: 100%; cursor: crosshair; }
    
    /* Loading */
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="loading" class="hidden">
  <div class="spinner-border text-primary"></div>
</div>

<div class="header-gradient sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="fw-bold fs-5 text-shadow"><i class="bi bi-hospital"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏Ø ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
    <div class="d-flex gap-2">
       <button class="btn btn-sm btn-outline-light rounded-pill" onclick="app.openHelp()"><i class="bi bi-info-circle"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
       <button id="btnLogin" class="btn btn-sm btn-light text-primary fw-bold rounded-pill" onclick="app.login()"><i class="bi bi-line"></i> Login</button>
    </div>
  </div>
</div>

<div class="container">
  <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded shadow-sm">
    <li class="nav-item"><button class="nav-link active" onclick="app.show('doctor')">1. ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('pharmacy')">2. ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏¢‡∏∑‡∏°‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('receive')">3. ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('history')">4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></li>
  </ul>

  <div id="doctor" class="section">
    <form id="reqForm">
      <div class="row">
        <div class="col-12"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</label><input type="text" class="form-control" id="doctorName"></div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
         <label class="m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</label>
         <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" onclick="app.addDrugRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏≠‡∏µ‡∏Å</button>
      </div>
      <div id="drugListContainer"></div>

      <div class="row">
         <div class="col-6"><label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (‡∏ß‡∏±‡∏ô)</label><input type="text" class="form-control" id="duration"></div>
         <div class="col-6"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏£‡∏ß‡∏°)</label><input type="text" class="form-control" id="amount"></div>
      </div>
      <div class="text-muted small">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</div>

      <hr class="my-4">

      <div class="row">
         <div class="col-6"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)</label><input type="text" class="form-control" id="patientName"></div>
         <div class="col-6"><label>HN</label><input type="text" class="form-control" id="hn"></div>
      </div>
      <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input type="text" class="form-control" id="diagnosis">
      <label>‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</label><input type="text" class="form-control" id="indication">
      <label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label><input type="text" class="form-control" id="staffName">
      <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><input type="text" class="form-control" id="suggestion">

      <label class="mt-3">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ç‡πâ‡∏≠)</label>
      <div class="card p-3 bg-light border-0">
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="A" id="rA"><label class="form-check-label" for="rA">A. ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≤/‡πÅ‡∏û‡πâ‡∏¢‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="B" id="rB"><label class="form-check-label" for="rB">B. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="C" id="rC"><label class="form-check-label" for="rC">C. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ ‡∏≠‡∏¢.</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="D" id="rD"><label class="form-check-label" for="rD">D. ‡∏°‡∏µ contraindication ‡∏´‡∏£‡∏∑‡∏≠ Drug Interaction ‡∏Å‡∏±‡∏ö‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="E" id="rE"><label class="form-check-label" for="rE">E. ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤)</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="F" id="rF"><label class="form-check-label" for="rF">F. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label></div>
        <input type="text" class="form-control mt-1" id="reasonText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
      </div>

      <label class="mt-3">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (300 x 150 px)</label>
      <div class="border p-1 bg-white rounded">
         <canvas id="sig-canvas" height="150"></canvas>
      </div>
      <button type="button" class="btn btn-secondary btn-sm mt-1" onclick="app.clearSig()">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

      <button type="button" class="btn btn-glam w-100 mt-4 py-3 fs-5 rounded-pill shadow" onclick="app.submitData()">
         <i class="bi bi-send"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </form>
  </div>

  <div id="pharmacy" class="section hidden">
    <div id="pendingList"></div>
  </div>

  <div id="receive" class="section hidden">
    <div id="approvedList"></div>
  </div>

  <div id="history" class="section hidden">
    <div class="row mb-3">
        <div class="col-5"><input type="date" id="filterStart" class="form-control"></div>
        <div class="col-5"><input type="date" id="filterEnd" class="form-control"></div>
        <div class="col-2"><button class="btn btn-primary w-100" onclick="app.loadHistory()"><i class="bi bi-search"></i></button></div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white"><h5 class="modal-title">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <h6>1. ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</h6>
        <ul>
           <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</li>
           <li>‡∏Å‡∏î <b>"+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏≠‡∏µ‡∏Å"</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏¢‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
           <li>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
           <li>‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
        </ul>
        <hr>
        <h6>2. ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h6>
        <ul>
           <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</li>
           <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</li>
           <li>‡∏Å‡∏î <b>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡∏∞ PDF</li>
           <li>‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
        </ul>
        <hr>
        <h6>3. ‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h6>
        <ul>
           <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
           <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>‡∏£‡∏±‡∏ö‡∏¢‡∏≤</b> ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</li>
           <li>‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="approveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning"><h5 class="modal-title">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
         <input type="hidden" id="ap_reqId">
         <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
         <textarea class="form-control" id="ap_drugList" rows="5"></textarea>
         <label>‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏¢‡∏∑‡∏°</label>
         <select class="form-select" id="ap_pharmacistName"><option value="">Loading...</option></select>
      </div>
      <div class="modal-footer justify-content-between">
         <button type="button" class="btn btn-outline-danger" onclick="app.deleteRequest()">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
         <button type="button" class="btn btn-success" onclick="app.confirmApprove()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="receiveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white"><h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
         <input type="hidden" id="rc_reqId">
         <p id="rc_display" class="fw-bold"></p>
         <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</label><input type="text" class="form-control" id="rc_amount">
         <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="number" class="form-control" id="rc_cost">
         <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="form-control" id="rc_note">
      </div>
      <div class="modal-footer">
         <button type="button" class="btn btn-success w-100" onclick="app.confirmReceive()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const LIFF_ID = "2008862022-AUe9BjR5";
var app = {};
var pendingData = [];
var helpModal, approveModal, receiveModal;

// 1. UTILS
app.toThaiDigit = function(n) {
    return String(n).replace(/[0-9]/g, d => "‡πê‡πë‡πí‡πì‡πî‡πï‡πñ‡πó‡πò‡πô"[d]);
};

app.show = function(id) {
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    
    if(id==='doctor') app.checkRows();
    if(id==='pharmacy') app.loadPending();
    if(id==='receive') app.loadApproved();
    if(id==='history') app.loadHistory();
};

app.openHelp = function() { helpModal.show(); };
app.login = function() { if(liff) liff.login(); };

app.share = function(drug, doc, url) {
    if(!liff.isLoggedIn()) { alert("Login LINE ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
    const msg = {
       type: "flex", altText: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤",
       contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: [
           { type: "text", text: "‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß", weight: "bold", color: "#1DB446" },
           { type: "text", text: drug, size: "sm", wrap: true },
           { type: "text", text: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: " + doc, size: "xs", color: "#666" }
       ]}, footer: { type: "box", layout: "vertical", contents: [{ type: "button", action: { type: "uri", label: "üìÑ ‡πÄ‡∏õ‡∏¥‡∏î PDF", uri: url }, style: "primary" }] } }
    };
    liff.shareTargetPicker([msg]).catch(e => alert("‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e));
};

// 2. DOCTOR
app.addDrugRow = function() {
    const id = 'row_' + Date.now();
    const html = `
    <div class="drug-row" id="${id}">
        <i class="bi bi-x-circle-fill remove-btn" onclick="document.getElementById('${id}').remove()"></i>
        <div class="row g-2">
            <div class="col-8"><input type="text" class="form-control form-control-sm d-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ + dosage form"></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm d-strength" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á"></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm d-qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm d-unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm d-regimen" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ"></div>
        </div>
    </div>`;
    document.getElementById('drugListContainer').insertAdjacentHTML('beforeend', html);
};

app.checkRows = function() {
    if(document.getElementById('drugListContainer').children.length === 0) app.addDrugRow();
};

app.submitData = function() {
    // Collect Data
    let drugs = [];
    document.querySelectorAll('.drug-row').forEach((r, i) => {
        let n = r.querySelector('.d-name').value;
        let s = r.querySelector('.d-strength').value;
        let q = r.querySelector('.d-qty').value;
        let u = r.querySelector('.d-unit').value;
        let reg = r.querySelector('.d-regimen').value;
        if(n) {
            // FORMAT: ‡πë. Name Strength ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πë Unit [Regimen]
            let str = `${app.toThaiDigit(i+1)}. ${n} ${s} \t‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${app.toThaiDigit(q)} ${u}`;
            if(reg) str += ` [${reg}]`;
            drugs.push(str);
        }
    });

    if(drugs.length === 0) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

    const cvs = document.getElementById('sig-canvas');
    const sigData = cvs.toDataURL("image/png");
    
    // Get Radio
    let rCode = "";
    const radios = document.getElementsByName('reasonCode');
    for(let r of radios) if(r.checked) rCode = r.value;

    const payload = {
        doctorName: document.getElementById('doctorName').value,
        drugListFormatted: drugs.join('\n'), // ‡∏™‡πà‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        strength: "-", // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏ß‡∏°‡πÉ‡∏ô string
        regimen: "-", 
        quantity: "-",
        
        staffName: document.getElementById('staffName').value,
        patientName: document.getElementById('patientName').value,
        hn: document.getElementById('hn').value,
        diagnosis: document.getElementById('diagnosis').value,
        indication: document.getElementById('indication').value,
        suggestion: document.getElementById('suggestion').value,
        duration: document.getElementById('duration').value,
        amount: document.getElementById('amount').value,
        reasonCode: rCode,
        reasonText: document.getElementById('reasonText').value,
        signatureData: sigData,
        imageFile: null
    };

    document.getElementById('loading').classList.remove('hidden');
    google.script.run.withSuccessHandler(res => {
        document.getElementById('loading').classList.add('hidden');
        alert(res);
        document.getElementById('reqForm').reset();
        document.getElementById('drugListContainer').innerHTML = '';
        app.checkRows();
        app.clearSig();
    }).submitRequest(payload);
};

app.clearSig = function() {
    const cvs = document.getElementById('sig-canvas');
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0, 0, cvs.width, cvs.height);
};

// 3. PHARMACY
app.loadPending = function() {
    document.getElementById('loading').classList.remove('hidden');
    google.script.run.withSuccessHandler(data => {
        document.getElementById('loading').classList.add('hidden');
        if(!data) data = []; pendingData = data;
        let html = '';
        if(data.length === 0) html = "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>";
        else {
            data.forEach((item, i) => {
                let showDrug = item.drugList.replace(/\n/g, '<br>');
                html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-warning">
                   <div class="fw-bold text-primary">${item.doctorName}</div>
                   <div class="small text-muted mb-2">${item.patientName}</div>
                   <div class="bg-light p-2 rounded mb-2">${showDrug}</div>
                   <button class="btn btn-outline-primary btn-sm w-100" onclick="app.openApprove(${i})">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                </div>`;
            });
        }
        document.getElementById('pendingList').innerHTML = html;
        
        // Load Pharmacist
        google.script.run.withSuccessHandler(list => {
            const sel = document.getElementById('ap_pharmacistName');
            sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
            list.forEach(p => sel.add(new Option(p, p)));
        }).getPharmacistList();

    }).getPendingRequests();
};

app.openApprove = function(i) {
    const item = pendingData[i];
    document.getElementById('ap_reqId').value = item.reqId;
    document.getElementById('ap_drugList').value = item.drugList;
    approveModal.show();
};

app.deleteRequest = function() {
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?")) return;
    const id = document.getElementById('ap_reqId').value;
    google.script.run.withSuccessHandler(res => {
        alert(res);
        approveModal.hide();
        app.loadPending();
    }).deleteRequest(id);
};

app.confirmApprove = function() {
    const phar = document.getElementById('ap_pharmacistName').value;
    if(!phar) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£");
    
    // Find original to keep other data
    const org = pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value);
    
    const payload = {
        reqId: org.reqId,
        drugName: document.getElementById('ap_drugList').value, // Edited list
        pharmacistName: phar,
        // Pass essential data for PDF logic
        quantity: "-", 
        strength: "-",
        regimen: "-",
        reason: org.reason,
        reasonCode: org.reasonCode,
        imageId: org.imageId,
        signatureId: org.signatureId
    };

    approveModal.hide();
    document.getElementById('loading').classList.remove('hidden');
    google.script.run.withSuccessHandler(res => {
        document.getElementById('loading').classList.add('hidden');
        if(res.status === 'error') { alert(res.message); return; }
        
        alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß: " + res.docNum);
        app.share("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏£‡∏û.‡πÉ‡∏´‡∏°‡πà (" + res.drugName + ")", res.docNum, res.pdfUrl);
        app.loadPending();
    }).approveAndGeneratePDF(payload);
};

// 4. RECEIVE
app.loadApproved = function() {
    google.script.run.withSuccessHandler(data => {
        let html = '';
        if(data.length === 0) html = "<div class='text-center mt-4'>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>";
        else {
            data.forEach(item => {
                html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-success">
                   <div class="fw-bold text-success">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${item.docNum}</div>
                   <div class="small text-truncate my-1">${item.drug}</div>
                   <div class="d-flex gap-2 mt-2">
                      <a href="${item.pdfUrl}" target="_blank" class="btn btn-sm btn-secondary flex-fill">PDF</a>
                      <button class="btn btn-sm btn-success flex-fill" onclick="app.openReceive('${item.reqId}', '${item.drug}')">‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>
                      <button class="btn btn-sm btn-outline-success" onclick="app.share('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤', '${item.docNum}', '${item.pdfUrl}')"><i class="bi bi-share"></i></button>
                   </div>
                </div>`;
            });
        }
        document.getElementById('approvedList').innerHTML = html;
    }).getApprovedRequests();
};

app.openReceive = function(id, name) {
    document.getElementById('rc_reqId').value = id;
    document.getElementById('rc_display').innerText = name;
    receiveModal.show();
};

app.confirmReceive = function() {
    const id = document.getElementById('rc_reqId').value;
    const amt = document.getElementById('rc_amount').value;
    const c = document.getElementById('rc_cost').value;
    const n = document.getElementById('rc_note').value;
    
    receiveModal.hide();
    google.script.run.withSuccessHandler(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        app.loadApproved();
    }).completeRequest(id, amt, c, n);
};

// 5. HISTORY
app.loadHistory = function() {
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    document.getElementById('historyTableBody').innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    
    google.script.run.withSuccessHandler(data => {
        let html = '';
        data.forEach(d => {
            let pdf = d.pdfUrl ? `<a href="${d.pdfUrl}" target="_blank"><i class="bi bi-file-pdf text-danger"></i></a>` : '';
            let share = d.pdfUrl ? `<i class="bi bi-share text-success ms-2" style="cursor:pointer" onclick="app.share('${d.drug}', '${d.docNum}', '${d.pdfUrl}')"></i>` : '';
            html += `<tr>
               <td>${d.date}</td>
               <td><div class="text-truncate" style="max-width:150px">${d.drug}</div>${pdf}${share}</td>
               <td>${d.status}</td>
            </tr>`;
        });
        document.getElementById('historyTableBody').innerHTML = html;
    }).getAllHistory(s, e);
};

// INIT
window.onload = function() {
    helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));

    // Canvas
    const cvs = document.getElementById('sig-canvas');
    const ctx = cvs.getContext('2d');
    let isDrawing = false;
    
    const resize = () => { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; };
    setTimeout(resize, 500);
    
    const getPos = (e) => {
        const r = cvs.getBoundingClientRect();
        const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
        const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
        return {x,y};
    };
    
    const start = (e) => { isDrawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e) => { if(!isDrawing)return; const p=getPos(e); ctx.lineWidth=2; ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
    const end = () => { isDrawing=false; };
    
    ['mousedown','touchstart'].forEach(e => cvs.addEventListener(e, start, {passive:false}));
    ['mousemove','touchmove'].forEach(e => cvs.addEventListener(e, move, {passive:false}));
    ['mouseup','touchend'].forEach(e => cvs.addEventListener(e, end));

    // LIFF
    liff.init({ liffId: LIFF_ID }).then(() => {
        if(liff.isLoggedIn()) {
            document.getElementById('btnLogin').classList.add('hidden');
            document.getElementById('txtLoggedIn').classList.remove('hidden');
        }
    });
    
    app.checkRows();
};
</script>

</body>
</html>