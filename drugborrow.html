<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; padding-bottom: 80px; font-size: 16px; }
    .header-glam { background: linear-gradient(135deg, #0056b3 0%, #004494 100%); color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .hidden { display: none !important; }
    label { font-weight: 600; color: #2c3e50; margin-top: 10px; font-size: 1rem; }
    .drug-row { background: #f8f9fa; border-left: 5px solid #0056b3; padding: 15px; margin-bottom: 10px; border-radius: 8px; position: relative; }
    .remove-btn { position: absolute; top: 10px; right: 10px; color: #dc3545; cursor: pointer; font-size: 1.2rem; }
    #sig-canvas, #car-sig-canvas { border: 2px dashed #bbb; border-radius: 8px; background: #fff; width: 100%; cursor: crosshair; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .form-check-label { font-weight: normal; font-size: 0.95rem; }
    .profile-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
    .text-green-glam { color: #198754; font-weight: bold; font-size: 1.1rem; }
    
    /* üî• New Badge Style: Inside Button */
    .nav-link { position: relative; }
    .badge-notify {
        position: absolute;
        top: 2px;
        right: 5px;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.65rem;
        display: none;
        box-shadow: 0 0 2px white;
    }
    
    /* Animation Ambulance */
    @keyframes drive {
        from { transform: translateX(100%); }
        to { transform: translateX(-100%); }
    }
    .ambulance-anim { animation: drive 4s linear infinite; display: inline-block; font-size: 2rem; color: #dc3545; }
    
    /* Phone Box */
    .phone-box {
        border: 2px solid #0d6efd;
        border-radius: 15px;
        padding: 10px;
        text-align: center;
        margin-top: 15px;
        background-color: #f0f8ff;
    }
    .phone-number { font-size: 1.5rem; font-weight: bold; color: #0d6efd; }
  </style>
</head>
<body>

<div id="loading" class="hidden">
  <div class="text-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-primary fs-5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
  </div>
</div>

<div class="header-glam sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="fw-bold fs-5"><i class="bi bi-hospital"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏Ø ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
    <div class="d-flex align-items-center gap-2">
       <button class="btn btn-sm btn-outline-light rounded-pill" onclick="app.openHelp()">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
       <button id="btnLogin" class="btn btn-sm btn-light text-primary fw-bold rounded-pill hidden" onclick="app.login()">Login</button>
       <div id="userProfile" class="hidden d-flex align-items-center gap-2 text-white pointer" onclick="app.openRegisterModal(true)">
           <span class="small fw-bold">Login: <span id="userName"></span></span>
           <img id="userPic" class="profile-img" src="">
       </div>
    </div>
  </div>
  <div id="alertReg" class="container mt-2 hidden">
      <div class="alert alert-warning py-1 small mb-0 text-center pointer" onclick="app.openRegisterModal()">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å)</div>
  </div>
</div>

<div class="container mt-3">
  <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm">
    <li class="nav-item">
        <button class="nav-link active fw-bold" onclick="app.show('doctor')">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" onclick="app.show('pharmacy')">
            ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏¢‡∏∑‡∏°‡∏¢‡∏≤
            <span id="badge-phar" class="badge-notify">0</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" onclick="app.show('receive')">
            ‡∏•‡∏á‡∏£‡∏±‡∏ö‡∏¢‡∏≤
            <span id="badge-rcv" class="badge-notify">0</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" onclick="app.show('history')">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </li>
  </ul>

  <div id="doctor" class="section">
    <h4 class="text-primary border-bottom pb-2 mb-3">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</h4>
    <form id="reqForm">
      <div class="row"><div class="col-12"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ *</label><input type="text" class="form-control" id="doctorName" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏ï‡πá‡∏°‡∏¢‡∏® ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏û.‡πÉ‡∏à‡∏î‡∏µ ‡∏£‡∏±‡∏Å‡∏™‡∏ß‡∏µ" required></div></div>
      <div class="d-flex justify-content-between align-items-center mt-4 mb-2"><label class="m-0 text-dark fs-5">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ *</label><button type="button" class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="app.addDrugRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏≠‡∏µ‡∏Å</button></div>
      <div id="drugListContainer"></div>
      <div class="alert alert-secondary mt-2 small"><i class="bi bi-info-circle"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡∏´‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</div>
      <hr class="my-4">
      <div class="row"><div class="col-6"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠) *</label><input type="text" class="form-control" id="patientName" required></div><div class="col-6"><label>HN *</label><input type="text" class="form-control" id="hn" required></div></div>
      <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input type="text" class="form-control" id="diagnosis">
      <label>‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</label><input type="text" class="form-control" id="indication">
      <label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ *</label><input type="text" class="form-control" id="staffName" required>
      <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><input type="text" class="form-control" id="suggestion">
      <label class="mt-4 bg-light p-2 rounded w-100 fw-bold border text-primary">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ç‡πâ‡∏≠)</label>
      <div class="ps-1">
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="A" id="rA"><label class="form-check-label" for="rA">A ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≤/‡πÅ‡∏û‡πâ‡∏¢‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="B" id="rB"><label class="form-check-label" for="rB">B ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡πâ‡∏ß</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="C" id="rC"><label class="form-check-label" for="rC">C ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö ‡∏≠‡∏¢.</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="D" id="rD"><label class="form-check-label" for="rD">D ‡∏°‡∏µ contraindication ‡∏´‡∏£‡∏∑‡∏≠ Drug Interaction ‡∏Å‡∏±‡∏ö‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="E" id="rE"><label class="form-check-label" for="rE">E ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡πÉ‡∏ô‡πÅ‡∏á‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤)</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="F" id="rF"><label class="form-check-label" for="rF">F ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label></div>
        <input type="text" class="form-control mt-1 ms-4 w-75" id="reasonText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...">
      </div>
      <label class="mt-4">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå * (‡πÄ‡∏ã‡πá‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label>
      <ul class="nav nav-tabs" id="sigTab"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-draw">‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-upload">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</a></li></ul>
      <div class="tab-content border border-top-0 p-3 bg-white mb-3"><div class="tab-pane active" id="tab-draw"><div class="border p-1 bg-white rounded shadow-sm"><canvas id="sig-canvas" height="150"></canvas></div><button type="button" class="btn btn-secondary btn-sm mt-1" onclick="app.clearSig()">‡∏•‡πâ‡∏≤‡∏á</button></div><div class="tab-pane" id="tab-upload"><input type="file" class="form-control" id="sigFile" accept="image/*"><div class="small text-muted mt-1">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏à‡∏£‡∏¥‡∏á</div></div></div>
      <button type="button" class="btn btn-glam w-100 mt-4 py-3 fs-5 rounded-pill shadow fw-bold" onclick="app.submitData()"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>
  </div>

  <div id="pharmacy" class="section hidden">
    <div id="pharmacy-loader" class="text-center py-5 hidden"><div class="spinner-border text-primary"></div></div>
    <div id="pendingList"></div>
  </div>

  <div id="receive" class="section hidden">
    <div id="receive-loader" class="text-center py-5 hidden"><div class="spinner-border text-success"></div></div>
    <div id="approvedList"></div>
  </div>

  <div id="history" class="section hidden">
    <div class="row mb-3 g-2"><div class="col-5"><input type="date" id="filterStart" class="form-control"></div><div class="col-5"><input type="date" id="filterEnd" class="form-control"></div><div class="col-2"><button class="btn btn-primary w-100" onclick="app.loadHistory()">üîç</button></div></div>
    <div class="table-responsive"><table class="table table-striped align-middle"><thead class="table-primary"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÅ‡∏û‡∏ó‡∏¢‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="historyTableBody"></tbody><tfoot class="table-dark"><tr><td colspan="3" class="text-end">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td><td colspan="2" id="totalPrice">0.00</td></tr></tfoot></table></div>
  </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)</label>
          <input type="text" id="regName" class="form-control" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏ï‡πá‡∏°‡∏¢‡∏® ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏û.‡πÉ‡∏à‡∏î‡∏µ ‡∏£‡∏±‡∏Å‡∏™‡∏ß‡∏µ">
          <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
          <input type="text" id="regJob" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input type="text" id="regPhone" class="form-control" placeholder="08x-xxxxxxx">
      </div>
      <div class="modal-footer"><button class="btn btn-primary w-100" onclick="app.register()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="summaryModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white"><h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h5></div>
      <div class="modal-body">
        <p id="summaryText"></p>
        <div class="phone-box">
            <div class="small text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°</div>
            <div class="phone-number">#113</div>
            <div class="small mt-2">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≤<br>‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        </div>
        <div class="text-center mt-3" style="overflow:hidden">
            <i class="bi bi-truck ambulance-anim"></i>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="window.location.reload()">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="approveModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="ap_reqId"><div id="ap_drugInputs"></div><label class="mt-3">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤</label><input type="file" class="form-control" id="ap_imageFile" accept="image/*"><label class="mt-3">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</label><select class="form-select" id="ap_pharmacistName"><option value="">Loading...</option></select></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-secondary" onclick="app.cancelRequest()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏¢‡∏∑‡∏°</button><button type="button" class="btn btn-success" onclick="app.confirmApprove()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button></div></div></div></div>
<div class="modal fade" id="receiveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">‡∏•‡∏á‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="rc_reqId"><p id="rc_display" class="text-green-glam"></p><label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="form-control mb-3" id="rc_cost"><label class="fw-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><div class="form-check"><input class="form-check-input" type="radio" name="rc_note_opt" value="‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß" checked><label class="form-check-label">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</label></div><div class="form-check"><input class="form-check-input" type="radio" name="rc_note_opt" value="storage"><label class="form-check-label">‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà <input type="text" class="form-control form-control-sm d-inline w-50" id="rc_note_storage"></label></div><div class="form-check"><input class="form-check-input" type="radio" name="rc_note_opt" value="incomplete"><label class="form-check-label">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô <input type="text" class="form-control form-control-sm d-inline w-50" id="rc_note_incomplete"></label></div><div class="form-check"><input class="form-check-input" type="radio" name="rc_note_opt" value="‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"><label class="form-check-label">‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label></div></div><div class="modal-footer" id="rc_footer"><button type="button" class="btn btn-success w-100" onclick="app.confirmReceive()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button></div></div></div></div>

<div class="modal fade" id="carModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="bi bi-ambulance"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Ç‡∏≠‡∏£‡∏ñ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <input type="hidden" id="car_ref_reqId">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</label><input type="text" id="car_requester" class="form-control">
    <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label><input type="text" id="car_job" class="form-control">
    <div class="row">
        <div class="col-6"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label><input type="date" id="car_date" class="form-control"></div>
        <div class="col-3"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="car_start" class="form-control"></div>
        <div class="col-3"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="time" id="car_end" class="form-control"></div>
    </div>
    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><input type="text" id="car_place" class="form-control" value="‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤ ‡∏£‡∏û.‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÄ‡∏Ç‡∏ï‡∏£‡∏≠‡∏∏‡∏î‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå">
    <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label><textarea id="car_reason" class="form-control" rows="2"></textarea>
    <label class="mt-3">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ã‡πá‡∏ô)</label>
    <div class="border p-1 bg-white rounded"><canvas id="car-sig-canvas" height="300"></canvas></div>
    <button type="button" class="btn btn-sm btn-secondary mt-1" onclick="app.clearCarSig()">‡∏•‡πâ‡∏≤‡∏á</button>
</div><div class="modal-footer"><button class="btn btn-success w-100" onclick="app.submitCarRequest()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏£‡∏ñ</button></div></div></div></div>

<div class="modal fade" id="helpModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <h6>1. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h6>
    <ul><li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° Login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏î‡∏à‡∏≥‡πÑ‡∏ß‡πâ)</li></ul>
    <hr>
    <h6>2. ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</h6>
    <ul><li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢/‡∏¢‡∏≤ -> ‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ -> ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li><li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤ (#113)</li></ul>
    <hr>
    <h6>3. ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h6>
    <ul><li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Tab 2 (‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</li><li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ -> ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -> ‡πÅ‡∏ä‡∏£‡πå PDF</li><li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>"‡∏Ç‡∏≠‡∏£‡∏ñ"</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li></ul>
    <hr>
    <h6>4. ‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h6>
    <ul><li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡πÄ‡∏Ç‡πâ‡∏≤ Tab 3 -> ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏¢‡∏≤ -> ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤ -> ‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°</li></ul>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ‚ö†Ô∏è Update URL
const API_URL = "https://script.google.com/macros/s/AKfycbxwYS5eJYtTgKikbQ3_8LyuuG1Byw--1ojCUVRafpk3_yY9ncW9AD12XFUcYyn-i9mY/exec";
const LIFF_ID = "2008862022-AUe9BjR5";

var app = {};
var pendingData = [], approvedData = [];
var helpModal, approveModal, receiveModal, summaryModal, registerModal, carModal;
var currentUser = null;

// API
app.callApi = async function(action, payload = {}) {
    if(['submitRequest', 'approveAndGeneratePDF', 'registerUser', 'submitCarRequest'].includes(action)) document.getElementById('loading').classList.remove('hidden');
    try {
        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: action, data: payload }) });
        const result = await response.json();
        document.getElementById('loading').classList.add('hidden');
        if(result.status === 'error') throw new Error(result.message);
        return result.data;
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        alert("System Error: " + e.message);
        throw e;
    }
};

// USER & AUTO FILL
app.checkUser = async function() {
    let uid = null, dName = "", pUrl = "";
    if(liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        uid = profile.userId; dName = profile.displayName; pUrl = profile.pictureUrl;
    }

    if(uid) {
        document.getElementById('btnLogin').classList.add('hidden');
        document.getElementById('userProfile').classList.remove('hidden');
        document.getElementById('userPic').src = pUrl;
        document.getElementById('userName').innerText = dName;
        
        const user = await app.callApi('checkUser', { userId: uid });
        if(user) {
            currentUser = user;
            if(document.getElementById('doctorName')) document.getElementById('doctorName').value = user.name;
        } else {
            document.getElementById('alertReg').classList.remove('hidden');
            app.openRegisterModal();
        }
    }
    app.updateBadges();
};

app.updateBadges = async function() {
    try {
        const counts = await app.callApi('getBadgeCounts');
        const bPhar = document.getElementById('badge-phar');
        const bRcv = document.getElementById('badge-rcv');
        if(counts.pending > 0) { bPhar.innerText = counts.pending; bPhar.style.display = 'block'; } 
        else bPhar.style.display = 'none';
        if(counts.approved > 0) { bRcv.innerText = counts.approved; bRcv.style.display = 'block'; } 
        else bRcv.style.display = 'none';
    } catch(e) {}
};

app.openRegisterModal = function(isEdit = false) {
    if(currentUser) {
        document.getElementById('regName').value = currentUser.name;
        document.getElementById('regJob').value = currentUser.job;
        document.getElementById('regPhone').value = currentUser.phone || "";
    }
    registerModal.show();
};

app.register = async function() {
    const name = document.getElementById('regName').value;
    const job = document.getElementById('regJob').value;
    const phone = document.getElementById('regPhone').value;
    if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠");
    let uid = "browser_user";
    if(liff.isLoggedIn()) { const p = await liff.getProfile(); uid = p.userId; }
    
    const res = await app.callApi('registerUser', { userId: uid, name: name, job: job, phone: phone });
    currentUser = res;
    registerModal.hide();
    document.getElementById('alertReg').classList.add('hidden');
    alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    if(document.getElementById('doctorName')) document.getElementById('doctorName').value = name;
};

app.show = function(id) {
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.nav-link');
    if(id==='doctor') { btns[0].classList.add('active'); app.checkRows(); }
    if(id==='pharmacy') { btns[1].classList.add('active'); app.loadPharmacy(); }
    if(id==='receive') { btns[2].classList.add('active'); app.loadApproved(); }
    if(id==='history') { btns[3].classList.add('active'); app.loadHistory(); }
};

app.openHelp = function() { helpModal.show(); };
app.login = function() { if(!liff.isLoggedIn()) liff.login(); else app.checkUser(); };

app.share = function(text, url) {
    if(!liff.isLoggedIn()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login LINE");
    if(liff.isApiAvailable('shareTargetPicker')) {
        let contents = [ { type: "text", text: text, weight: "bold", color: "#1DB446", wrap: true } ];
        if(url) contents.push({ type: "button", action: { type: "uri", label: "‡πÄ‡∏õ‡∏¥‡∏î PDF", uri: url }, style: "primary", margin: "md" });
        liff.shareTargetPicker([{ type: "flex", altText: "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å", contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: contents }} }]).catch(e => alert("‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e));
    } else { window.open('https://line.me/R/msg/text/?' + encodeURIComponent(text + " " + (url||""))); }
};

app.getDrugs = function(json) { try { const d = JSON.parse(json); return Array.isArray(d) ? d : [{name: json, strength:"", quantity:""}]; } catch(e) { return [{name: json, strength:"", quantity:""}]; } };

app.addDrugRow = function() {
    const id = 'row_' + Date.now();
    const html = `<div class="drug-row" id="${id}"><i class="bi bi-x-circle-fill remove-btn" onclick="document.getElementById('${id}').remove()"></i><div class="row g-2"><div class="col-8"><label class="m-0 small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input type="text" class="form-control form-control-sm d-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô Levofloxacin injection"></div><div class="col-4"><label class="m-0 small">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á(+‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label><input type="text" class="form-control form-control-sm d-strength" placeholder="‡πÄ‡∏ä‡πà‡∏ô 750mg"></div><div class="col-4"><label class="m-0 small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(+‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label><input type="text" class="form-control form-control-sm d-qty" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20 vials"></div><div class="col-4"><label class="m-0 small">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</label><input type="text" class="form-control form-control-sm d-regimen"></div><div class="col-4"><label class="m-0 small">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤(‡∏ß‡∏±‡∏ô)</label><input type="number" class="form-control form-control-sm d-duration" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15"></div></div></div>`;
    document.getElementById('drugListContainer').insertAdjacentHTML('beforeend', html);
};
app.checkRows = function() { if(document.getElementById('drugListContainer').children.length === 0) app.addDrugRow(); };
app.submitData = async function() {
    const req = ['doctorName', 'patientName', 'hn', 'staffName'];
    for(let id of req) { if(!document.getElementById(id).value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); }
    let drugs = [], drugSummary = "";
    document.querySelectorAll('.drug-row').forEach(r => {
        let n = r.querySelector('.d-name').value;
        if(n) { drugs.push({ name: n, strength: r.querySelector('.d-strength').value, quantity: r.querySelector('.d-qty').value, regimen: r.querySelector('.d-regimen').value, duration: r.querySelector('.d-duration').value }); drugSummary += `- ${n} (${r.querySelector('.d-qty').value})<br>`; }
    });
    if(drugs.length === 0) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    let sigData = null;
    const fileInput = document.getElementById('sigFile');
    if(fileInput.files.length > 0) { const reader = new FileReader(); reader.readAsDataURL(fileInput.files[0]); await new Promise(resolve => reader.onload = () => { sigData = reader.result; resolve(); }); } 
    else { const cvs = document.getElementById('sig-canvas'); if(cvs.toDataURL() !== document.createElement('canvas').toDataURL()) sigData = cvs.toDataURL("image/png"); }
    if(!sigData) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ");
    const rEl = document.querySelector('input[name="reasonCode"]:checked');
    const payload = { doctorName: document.getElementById('doctorName').value, drugs: drugs, staffName: document.getElementById('staffName').value, patientName: document.getElementById('patientName').value, hn: document.getElementById('hn').value, diagnosis: document.getElementById('diagnosis').value, indication: document.getElementById('indication').value, suggestion: document.getElementById('suggestion').value, reasonCode: rEl ? rEl.value : "", reasonText: document.getElementById('reasonText').value, signatureData: sigData, imageFile: null };
    try { await app.callApi('submitRequest', payload); document.getElementById('summaryText').innerHTML = `<b>‡πÅ‡∏û‡∏ó‡∏¢‡πå ${payload.doctorName}</b> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤:<br>${drugSummary}`; summaryModal.show(); app.updateBadges(); } catch(e) {}
};
app.clearSig = function() { const ctx = document.getElementById('sig-canvas').getContext('2d'); ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); document.getElementById('sigFile').value = ""; };

app.loadPharmacy = async function() {
    document.getElementById('pharmacy-loader').classList.remove('hidden');
    document.getElementById('pendingList').innerHTML = "";
    try {
        pendingData = await app.callApi('getPharmacyDashboard');
        document.getElementById('pharmacy-loader').classList.add('hidden');
        if(pendingData.length === 0) { document.getElementById('pendingList').innerHTML = "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</div>"; return; }
        let html = '';
        pendingData.forEach((item, i) => {
            let drugs = app.getDrugs(item.drugJson);
            let drugDisplay = drugs.map(d => `- ${d.name} (${d.quantity})`).join('<br>');
            let firstDrug = drugs[0] ? drugs[0].name : "‡∏¢‡∏≤";
            let carAction = `<button class="btn btn-sm btn-warning py-0" onclick="app.openCarModal(${i})"><i class="bi bi-ambulance"></i> ‡∏Ç‡∏≠‡∏£‡∏ñ</button>`;
            if(item.carPdfUrl) carAction = `<a href="${item.carPdfUrl}" target="_blank" class="btn btn-sm btn-info py-0 text-white"><i class="bi bi-file-earmark-pdf"></i> ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏£‡∏ñ</a>`;
            let buttons = '';
            if (item.status === 'Pending') buttons = `<button class="btn btn-outline-primary w-100 btn-sm" onclick="app.openApprove(${i})">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`;
            else if (item.status === 'Approved') buttons = `<div class="d-flex gap-2"><a href="${item.pdfUrl}" target="_blank" class="btn btn-sm btn-secondary flex-fill">‡∏î‡∏π PDF</a><button class="btn btn-sm btn-success flex-fill" onclick="app.share('‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å ‡∏£‡∏û.‡∏™‡∏ß‡∏µ (${firstDrug})', '${item.pdfUrl}')">‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°</button></div><div class="mt-2 text-end d-flex justify-content-between"><button class="btn btn-sm btn-danger py-0" onclick="app.cancelRequest('${item.reqId}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏¢‡∏∑‡∏°</button>${carAction}</div>`;
            html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 ${item.status==='Pending'?'border-warning':'border-success'}"><div class="d-flex justify-content-between"><span class="fw-bold text-primary">${item.doctorName}</span><span class="badge badge-status ${item.status==='Pending'?'bg-warning text-dark':'bg-success'}">${item.status}</span></div><div class="small text-muted mb-2">${item.patientName} (${item.hn})</div><div class="bg-light p-2 rounded mb-2 small">${drugDisplay}</div>${buttons}</div>`;
        });
        document.getElementById('pendingList').innerHTML = html;
        const list = await app.callApi('getUserList');
        const sel = document.getElementById('ap_pharmacistName');
        sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
        list.forEach(p => sel.add(new Option(p, p)));
        if(currentUser) sel.value = currentUser.name;
    } catch(e) {}
};
app.openApprove = function(i) {
    const item = pendingData[i];
    document.getElementById('ap_reqId').value = item.reqId;
    const container = document.getElementById('ap_drugInputs');
    container.innerHTML = "";
    app.getDrugs(item.drugJson).forEach((d, idx) => {
        container.insertAdjacentHTML('beforeend', `<div class="border p-2 mb-2 rounded bg-light drug-edit-row"><div class="fw-bold small text-primary mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}</div><div class="row g-1"><div class="col-12"><label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input type="text" class="form-control form-control-sm ap-name" value="${d.name}"></div><div class="col-6"><label class="small">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á</label><input type="text" class="form-control form-control-sm ap-strength" value="${d.strength}"></div><div class="col-6"><label class="small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="text" class="form-control form-control-sm ap-qty" value="${d.quantity}"></div><div class="col-6"><label class="small">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</label><input type="text" class="form-control form-control-sm ap-regimen" value="${d.regimen}"></div><div class="col-6"><label class="small">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label><input type="text" class="form-control form-control-sm ap-duration" value="${d.duration}"></div></div></div>`);
    });
    approveModal.show();
};
app.cancelRequest = async function(reqId) { if(!reqId) reqId = document.getElementById('ap_reqId').value; if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?")) return; try { await app.callApi('cancelRequest', {reqId: reqId}); alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); approveModal.hide(); app.loadPharmacy(); app.updateBadges(); } catch(e) {} };
app.confirmApprove = async function() {
    const phar = document.getElementById('ap_pharmacistName').value;
    if(!phar) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£");
    let editedDrugs = [];
    document.querySelectorAll('.drug-edit-row').forEach(row => { editedDrugs.push({ name: row.querySelector('.ap-name').value, strength: row.querySelector('.ap-strength').value, quantity: row.querySelector('.ap-qty').value, regimen: row.querySelector('.ap-regimen').value, duration: row.querySelector('.ap-duration').value }); });
    const org = pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value);
    const payload = { reqId: org.reqId, drugs: editedDrugs, pharmacistName: phar, reason: org.reason, reasonCode: org.reasonCode, signatureId: org.signatureId, imageFile: null };
    const fInput = document.getElementById('ap_imageFile');
    if(fInput.files.length > 0) { const reader = new FileReader(); reader.onload = async (e) => { payload.imageFile = e.target.result; app._sendApprove(payload); }; reader.readAsDataURL(fInput.files[0]); } else { app._sendApprove(payload); }
};
app._sendApprove = async function(pl) { approveModal.hide(); try { const res = await app.callApi('approveAndGeneratePDF', pl); alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß: " + res.docNum); if(liff.isLoggedIn() && confirm("‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE Group?")) app.share("‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å ‡∏£‡∏û.‡∏™‡∏ß‡∏µ (" + res.drugName + ")", res.pdfUrl); app.loadPharmacy(); app.updateBadges(); } catch(e) {} };

app.openCarModal = function(i) {
    const item = pendingData[i];
    const drugs = app.getDrugs(item.drugJson);
    const firstDrug = drugs[0] ? drugs[0].name : "‡∏¢‡∏≤";
    document.getElementById('car_ref_reqId').value = item.reqId;
    document.getElementById('car_date').valueAsDate = new Date();
    if(currentUser) {
        document.getElementById('car_requester').value = currentUser.name;
        document.getElementById('car_job').value = currentUser.job;
    }
    document.getElementById('car_reason').value = `‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ ${firstDrug} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠ ${item.patientName}`;
    carModal.show();
};
// üî• Car Canvas Resize Logic
document.getElementById('carModal').addEventListener('shown.bs.modal', function () {
    const cvs = document.getElementById('car-sig-canvas');
    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
});
app.clearCarSig = function() { const ctx = document.getElementById('car-sig-canvas').getContext('2d'); ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); };
app.submitCarRequest = async function() {
    const req = document.getElementById('car_requester').value;
    const job = document.getElementById('car_job').value;
    const date = document.getElementById('car_date').value;
    const start = document.getElementById('car_start').value;
    const end = document.getElementById('car_end').value;
    const place = document.getElementById('car_place').value;
    const reason = document.getElementById('car_reason').value;
    const refId = document.getElementById('car_ref_reqId').value;
    if(!req || !date || !start || !end || !place || !reason) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    const cvs = document.getElementById('car-sig-canvas');
    if(cvs.toDataURL() === document.createElement('canvas').toDataURL()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô");
    const payload = { refReqId: refId, requester: req, job: job, useDate: date, timeStart: start, timeEnd: end, place: place, reason: reason, signatureData: cvs.toDataURL("image/png") };
    carModal.hide();
    try { const res = await app.callApi('submitCarRequest', payload); alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); app.loadPharmacy(); } catch(e) {}
};

app.loadApproved = async function() {
    document.getElementById('receive-loader').classList.remove('hidden');
    document.getElementById('approvedList').innerHTML = "";
    const urlParams = new URLSearchParams(window.location.search);
    const directReqId = urlParams.get('reqId');
    try {
        approvedData = await app.callApi('getApprovedRequests'); 
        document.getElementById('receive-loader').classList.add('hidden');
        if(directReqId) { const idx = approvedData.findIndex(d => d.reqId === directReqId); if(idx !== -1) app.openReceive(idx); }
        if(approvedData.length === 0) { document.getElementById('approvedList').innerHTML = "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</div>"; return; }
        let html = '';
        approvedData.forEach((item, i) => { html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-success"><div class="fw-bold text-dark" style="font-weight:normal">${item.docNum} (${item.date})</div><div class="small my-1 text-green-glam fs-6">${item.drug}</div><div class="d-flex gap-2 mt-2"><button class="btn btn-sm btn-secondary flex-fill" onclick="app.openPdf('${item.pdfUrl}')">PDF</button><button class="btn btn-sm btn-success flex-fill" onclick="app.openReceive(${i})">‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button><button class="btn btn-sm btn-outline-success" onclick="app.share('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß (${item.drug})', '')">‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°</button></div></div>`; });
        document.getElementById('approvedList').innerHTML = html;
    } catch(e) {}
};
app.openPdf = function(url) { if(!url) return alert("No PDF"); if(liff.isInClient()) liff.openWindow({ url: url, external: true }); else window.open(url, '_blank'); };
app.openReceive = function(index) {
    const item = approvedData[index];
    document.getElementById('rc_reqId').value = item.reqId;
    document.getElementById('rc_display').innerText = item.drug;
    document.getElementById('rc_cost').value = "";
    document.querySelector('input[name="rc_note_opt"][value="‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß"]').checked = true;
    document.getElementById('rc_footer').innerHTML = `<button type="button" class="btn btn-success w-100" onclick="app.confirmReceive()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>`;
    receiveModal.show();
};
app.confirmReceive = async function() {
    const cost = document.getElementById('rc_cost').value;
    let note = "";
    const radio = document.querySelector('input[name="rc_note_opt"]:checked');
    if(radio.value === 'storage') note = "‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà " + document.getElementById('rc_note_storage').value;
    else if(radio.value === 'incomplete') note = "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô " + document.getElementById('rc_note_incomplete').value;
    else note = radio.value;
    const payload = { reqId: document.getElementById('rc_reqId').value, amount: "", cost: cost, note: note };
    try { await app.callApi('completeRequest', payload); const msg = `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ ${document.getElementById('rc_display').innerText} (${note}) ‡πÅ‡∏•‡πâ‡∏ß`; document.getElementById('rc_footer').innerHTML = `<div class="w-100 text-center text-success mb-2 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div><button class="btn btn-primary w-100" onclick="app.share('${msg}', '')">‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°</button>`; app.loadApproved(); app.updateBadges(); } catch(e) {}
};

app.loadHistory = async function() {
    document.getElementById('historyTableBody').innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    try {
        const data = await app.callApi('getAllHistory', {startDate:s, endDate:e});
        let html = '', total = 0;
        data.forEach(d => {
            let cost = parseFloat(d.cost) || 0;
            total += cost;
            let pdf = d.pdfUrl ? `<button class="btn btn-sm btn-link p-0" onclick="app.openPdf('${d.pdfUrl}')"><i class="bi bi-file-pdf text-danger"></i></button>` : '';
            html += `<tr><td>${d.date}</td><td><div class="text-truncate" style="max-width:100px">${d.doctor}</div></td><td><div class="text-truncate" style="max-width:120px">${d.drug}</div>${pdf}</td><td class="text-end">${cost.toLocaleString()}</td><td><span class="badge badge-status bg-secondary">${d.status}</span></td></tr>`;
        });
        document.getElementById('historyTableBody').innerHTML = html;
        document.getElementById('totalPrice').innerText = total.toLocaleString();
    } catch(e) {}
};

window.onload = function() {
    helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));
    summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
    registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
    carModal = new bootstrap.Modal(document.getElementById('carModal'));

    const cvs = document.getElementById('sig-canvas');
    
    [cvs].forEach(c => {
        let isD = false;
        const resize = () => { c.width = c.offsetWidth; c.height = c.offsetHeight; };
        setTimeout(resize, 500);
        const getP = (e) => { const r = c.getBoundingClientRect(); return {x: (e.touches?e.touches[0].clientX:e.clientX)-r.left, y: (e.touches?e.touches[0].clientY:e.clientY)-r.top}; };
        const start = (e) => { isD=true; const p=getP(e); const cx = c.getContext('2d'); cx.beginPath(); cx.moveTo(p.x,p.y); e.preventDefault(); };
        const move = (e) => { if(!isD)return; const p=getP(e); const cx = c.getContext('2d'); cx.lineWidth=2; cx.lineTo(p.x,p.y); cx.stroke(); e.preventDefault(); };
        const end = () => { isD=false; };
        ['mousedown','touchstart'].forEach(ev => c.addEventListener(ev, start, {passive:false}));
        ['mousemove','touchmove'].forEach(ev => c.addEventListener(ev, move, {passive:false}));
        ['mouseup','touchend'].forEach(ev => c.addEventListener(ev, end));
    });

    // Add Signature Logic to Car Canvas
    const carCvs = document.getElementById('car-sig-canvas');
    // Using same logic for simplicity (duplicated for clarity inside loop above if wanted, or specific here)
    let isD2 = false;
    const getP2 = (e) => { const r = carCvs.getBoundingClientRect(); return {x: (e.touches?e.touches[0].clientX:e.clientX)-r.left, y: (e.touches?e.touches[0].clientY:e.clientY)-r.top}; };
    const start2 = (e) => { isD2=true; const p=getP2(e); const cx = carCvs.getContext('2d'); cx.beginPath(); cx.moveTo(p.x,p.y); e.preventDefault(); };
    const move2 = (e) => { if(!isD2)return; const p=getP2(e); const cx = carCvs.getContext('2d'); cx.lineWidth=2; cx.lineTo(p.x,p.y); cx.stroke(); e.preventDefault(); };
    const end2 = () => { isD2=false; };
    ['mousedown','touchstart'].forEach(ev => carCvs.addEventListener(ev, start2, {passive:false}));
    ['mousemove','touchmove'].forEach(ev => carCvs.addEventListener(ev, move2, {passive:false}));
    ['mouseup','touchend'].forEach(ev => carCvs.addEventListener(ev, end2));

    liff.init({ liffId: LIFF_ID }).then(() => { 
        if(!liff.isLoggedIn()) { document.getElementById('btnLogin').classList.remove('hidden'); }
        else { app.checkUser(); }
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('page') === 'receive') app.show('receive');
    });
    app.checkRows();
};
</script>

</body>
</html>