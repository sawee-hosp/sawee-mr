<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; padding-bottom: 80px; }
    /* UI ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏û. */
    .header-main { background-color: #0056b3; color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .hidden { display: none !important; }
    label { font-weight: 600; font-size: 0.9rem; margin-top: 8px; color: #444; }
    .form-control, .form-select { font-size: 0.95rem; }
    
    /* Drug Row Item */
    .drug-item { background: #eef2f7; border: 1px solid #ced4da; padding: 10px; margin-bottom: 10px; border-radius: 6px; position: relative; }
    .remove-btn { position: absolute; top: 5px; right: 5px; color: #dc3545; cursor: pointer; font-size: 1.1rem; }
    
    #sig-canvas { border: 2px dashed #999; border-radius: 5px; background: #fff; width: 100%; cursor: crosshair; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; display:flex; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="loading" class="hidden">
  <div class="text-center">
    <div class="spinner-border text-primary"></div>
    <div class="mt-2 fw-bold text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>
</div>

<div class="header-main sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="fw-bold fs-5"><i class="bi bi-hospital"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏Ø ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
    <div class="d-flex gap-2">
       <button class="btn btn-sm btn-outline-light" onclick="app.openHelp()">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</button>
       <button id="btnLogin" class="btn btn-sm btn-light text-primary fw-bold hidden" onclick="app.login()">Login LINE</button>
    </div>
  </div>
</div>

<div class="container mt-3">
  <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded shadow-sm">
    <li class="nav-item"><button class="nav-link active" onclick="app.show('doctor')">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('pharmacy')">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏¢‡∏∑‡∏°‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('receive')">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('history')">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></li>
  </ul>

  <div id="doctor" class="section">
    <h5 class="text-primary border-bottom pb-2">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå</h5>
    <form id="reqForm">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</label><input type="text" class="form-control" id="doctorName">

      <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
         <label class="m-0 text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
         <button type="button" class="btn btn-sm btn-primary" onclick="app.addDrugRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button>
      </div>
      <div id="drugListContainer"></div>
      
      <hr>
      <div class="row">
         <div class="col-6"><label>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label><input type="text" class="form-control" id="patientName"></div>
         <div class="col-6"><label>HN</label><input type="text" class="form-control" id="hn"></div>
      </div>
      <label>‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input type="text" class="form-control" id="diagnosis">
      <label>Indication</label><input type="text" class="form-control" id="indication">
      <label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label><input type="text" class="form-control" id="staffName">
      <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><input type="text" class="form-control" id="suggestion">

      <label class="mt-3 bg-light p-2 rounded w-100 border">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ç‡πâ‡∏≠)</label>
      <div class="ps-2">
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="A" id="rA"><label class="form-check-label" for="rA">A. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="B" id="rB"><label class="form-check-label" for="rB">B. ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="C" id="rC"><label class="form-check-label" for="rC">C. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="D" id="rD"><label class="form-check-label" for="rD">D. Contraindication / Drug Interaction</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="E" id="rE"><label class="form-check-label" for="rE">E. ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤)</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="F" id="rF"><label class="form-check-label" for="rF">F. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label></div>
        <input type="text" class="form-control mt-1" id="reasonText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
      </div>

      <label class="mt-3">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
      <div class="border p-1 bg-white rounded"><canvas id="sig-canvas" height="150"></canvas></div>
      <button type="button" class="btn btn-secondary btn-sm mt-1" onclick="app.clearSig()">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

      <label class="mt-3">‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <input type="file" class="form-control" id="imageFile" accept="image/*">

      <button type="button" class="btn btn-primary w-100 mt-4 py-3 fw-bold shadow-sm" onclick="app.submitData()">
         ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </form>
  </div>

  <div id="pharmacy" class="section hidden">
    <div id="pendingList"></div>
  </div>

  <div id="receive" class="section hidden">
    <div id="approvedList"></div>
  </div>

  <div id="history" class="section hidden">
    <div class="row mb-3">
        <div class="col-5"><input type="date" id="filterStart" class="form-control"></div>
        <div class="col-5"><input type="date" id="filterEnd" class="form-control"></div>
        <div class="col-2"><button class="btn btn-primary w-100" onclick="app.loadHistory()">üîç</button></div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6>1. ‡πÅ‡∏û‡∏ó‡∏¢‡πå</h6><ul><li>‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</li><li>‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</li><li>‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li></ul><hr><h6>2. ‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h6><ul><li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</li><li><b>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ</b></li><li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"</li></ul></div></div></div></div>

<div class="modal fade" id="approveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="ap_reqId"><div id="ap_drugInputs"></div><label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</label><select class="form-select" id="ap_pharmacistName"><option value="">Loading...</option></select></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" onclick="app.deleteRequest()">‡∏•‡∏ö</button><button type="button" class="btn btn-success" onclick="app.confirmApprove()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div></div>

<div class="modal fade" id="receiveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="rc_reqId"><p id="rc_display" class="fw-bold text-primary"></p><label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="form-control" id="rc_cost"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="form-control" id="rc_note"></div><div class="modal-footer"><button type="button" class="btn btn-success w-100" onclick="app.confirmReceive()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const API_URL = "https://script.google.com/macros/s/AKfycbxwYS5eJYtTgKikbQ3_8LyuuG1Byw--1ojCUVRafpk3_yY9ncW9AD12XFUcYyn-i9mY/exec";
const LIFF_ID = "2008862022-AUe9BjR5";

var app = {};
var pendingData = [];
var helpModal, approveModal, receiveModal;

// --- API FETCH ---
app.callApi = async function(action, payload = {}) {
    document.getElementById('loading').classList.remove('hidden');
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: action, data: payload })
        });
        const result = await response.json();
        document.getElementById('loading').classList.add('hidden');
        if(result.status === 'error') throw new Error(result.message);
        return result.data;
    } catch(e) {
        document.getElementById('loading').classList.add('hidden');
        alert("Error: " + e.message);
        throw e;
    }
};

// --- UI ---
app.show = function(id) {
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    
    if(id==='doctor') app.checkRows();
    if(id==='pharmacy') app.loadPending();
    if(id==='receive') app.loadApproved();
    if(id==='history') app.loadHistory();
};

app.openHelp = function() { helpModal.show(); };
app.login = function() { if(liff) liff.login(); };

app.share = function(text, url) {
    if(!liff.isLoggedIn()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login LINE");
    if(liff.isApiAvailable('shareTargetPicker')) {
        liff.shareTargetPicker([{
            type: "flex", altText: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤",
            contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: [
                { type: "text", text: text, weight: "bold", color: "#1DB446" },
                { type: "button", action: { type: "uri", label: "‡πÄ‡∏õ‡∏¥‡∏î PDF", uri: url }, style: "primary", margin: "md" }
            ]}} 
        }]);
    } else {
        window.open('https://line.me/R/msg/text/?' + encodeURIComponent(text + " " + url));
    }
};

// --- DOCTOR ---
app.addDrugRow = function(data = {}) {
    const id = 'row_' + Date.now() + Math.random().toString(16).slice(2);
    const html = `
    <div class="drug-item" id="${id}">
        <i class="bi bi-x-circle-fill remove-btn" onclick="document.getElementById('${id}').remove()"></i>
        <div class="row g-2">
            <div class="col-8"><label class="m-0 small">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input type="text" class="form-control form-control-sm d-name" value="${data.name||''}"></div>
            <div class="col-4"><label class="m-0 small">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á</label><input type="text" class="form-control form-control-sm d-strength" value="${data.strength||''}"></div>
            <div class="col-4"><label class="m-0 small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="text" class="form-control form-control-sm d-qty" value="${data.qty||''}"></div>
            <div class="col-4"><label class="m-0 small">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</label><input type="text" class="form-control form-control-sm d-regimen" value="${data.regimen||''}"></div>
            <div class="col-4"><label class="m-0 small">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label><input type="text" class="form-control form-control-sm d-duration" value="${data.duration||''}"></div>
        </div>
    </div>`;
    document.getElementById('drugListContainer').insertAdjacentHTML('beforeend', html);
};

app.checkRows = function() {
    if(document.getElementById('drugListContainer').children.length === 0) app.addDrugRow();
};

app.submitData = async function() {
    let drugs = [];
    document.querySelectorAll('.drug-item').forEach(r => {
        let name = r.querySelector('.d-name').value;
        if(name) {
            drugs.push({
                name: name,
                strength: r.querySelector('.d-strength').value,
                qty: r.querySelector('.d-qty').value,
                regimen: r.querySelector('.d-regimen').value,
                duration: r.querySelector('.d-duration').value
            });
        }
    });

    if(drugs.length === 0) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

    const cvs = document.getElementById('sig-canvas');
    const rEl = document.querySelector('input[name="reasonCode"]:checked');

    const payload = {
        doctorName: document.getElementById('doctorName').value,
        drugs: drugs, // Send Array of Objects!
        staffName: document.getElementById('staffName').value,
        patientName: document.getElementById('patientName').value,
        hn: document.getElementById('hn').value,
        diagnosis: document.getElementById('diagnosis').value,
        indication: document.getElementById('indication').value,
        suggestion: document.getElementById('suggestion').value,
        reasonCode: rEl ? rEl.value : "",
        reasonText: document.getElementById('reasonText').value,
        signatureData: cvs.toDataURL("image/png"),
        imageFile: null
    };

    const fInput = document.getElementById('imageFile');
    if(fInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            payload.imageFile = e.target.result;
            await app._send(payload);
        };
        reader.readAsDataURL(fInput.files[0]);
    } else {
        await app._send(payload);
    }
};

app._send = async function(pl) {
    try {
        await app.callApi('submitRequest', pl);
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.getElementById('reqForm').reset();
        document.getElementById('drugListContainer').innerHTML = '';
        app.checkRows();
        app.clearSig();
    } catch(e) {}
};

app.clearSig = function() {
    const ctx = document.getElementById('sig-canvas').getContext('2d');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
};

// --- PHARMACY ---
app.loadPending = async function() {
    document.getElementById('pendingList').innerHTML = "Loading...";
    try {
        pendingData = await app.callApi('getPendingRequests');
        if(pendingData.length === 0) { 
            document.getElementById('pendingList').innerHTML = "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>"; 
            return; 
        }
        
        let html = '';
        pendingData.forEach((item, i) => {
            // Parse JSON back to list display
            let drugListDisplay = "";
            try {
                const dList = JSON.parse(item.drugJson);
                drugListDisplay = dList.map(d => `- ${d.name} (${d.qty})`).join('<br>');
            } catch(e) { drugListDisplay = "Error loading drugs"; }

            html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-warning">
               <div class="fw-bold text-primary">${item.doctorName}</div>
               <div class="small text-muted mb-2">${item.patientName} (${item.hn})</div>
               <div class="bg-light p-2 rounded mb-2 small">${drugListDisplay}</div>
               <button class="btn btn-outline-primary w-100 btn-sm" onclick="app.openApprove(${i})">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>`;
        });
        document.getElementById('pendingList').innerHTML = html;
        
        // Load Pharmacist List
        const list = await app.callApi('getPharmacistList');
        const sel = document.getElementById('ap_pharmacistName');
        sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
        list.forEach(p => sel.add(new Option(p, p)));
    } catch(e) {}
};

app.openApprove = function(i) {
    const item = pendingData[i];
    document.getElementById('ap_reqId').value = item.reqId;
    
    // Create Inputs for EACH Drug item
    const container = document.getElementById('ap_drugInputs');
    container.innerHTML = "";
    
    try {
        const drugs = JSON.parse(item.drugJson);
        drugs.forEach((d, idx) => {
            const html = `
            <div class="border p-2 mb-2 rounded bg-light drug-edit-row">
                <div class="fw-bold small text-primary mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}</div>
                <div class="row g-1">
                    <div class="col-8"><input type="text" class="form-control form-control-sm ap-name" value="${d.name}"></div>
                    <div class="col-4"><input type="text" class="form-control form-control-sm ap-qty" value="${d.qty}"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm ap-strength" value="${d.strength}"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm ap-regimen" value="${d.regimen}"></div>
                    <div class="col-6"><input type="text" class="form-control form-control-sm ap-duration" value="${d.duration}"></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    } catch(e) { container.innerHTML = "Error parsing data"; }
    
    approveModal.show();
};

app.deleteRequest = async function() {
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?")) return;
    try {
        await app.callApi('deleteRequest', {reqId: document.getElementById('ap_reqId').value});
        approveModal.hide();
        app.loadPending();
    } catch(e) {}
};

app.confirmApprove = async function() {
    const phar = document.getElementById('ap_pharmacistName').value;
    if(!phar) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£");
    
    // Collect Edited Drugs
    let editedDrugs = [];
    document.querySelectorAll('.drug-edit-row').forEach(row => {
        editedDrugs.push({
            name: row.querySelector('.ap-name').value,
            qty: row.querySelector('.ap-qty').value,
            strength: row.querySelector('.ap-strength').value,
            regimen: row.querySelector('.ap-regimen').value,
            duration: row.querySelector('.ap-duration').value
        });
    });

    const org = pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value);
    const payload = {
        reqId: org.reqId,
        drugs: editedDrugs, // Send Array back
        pharmacistName: phar,
        reason: org.reason, reasonCode: org.reasonCode, imageId: org.imageId, signatureId: org.signatureId
    };

    approveModal.hide();
    try {
        const res = await app.callApi('approveAndGeneratePDF', payload);
        alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß: " + res.docNum);
        app.share("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (" + res.drugName + ")", res.pdfUrl);
        app.loadPending();
    } catch(e) {}
};

// --- RECEIVE & HISTORY (No change in logic, just fix errors) ---
app.loadApproved = async function() {
    document.getElementById('approvedList').innerHTML = "Loading...";
    try {
        const data = await app.callApi('getApprovedRequests');
        let html = '';
        if(data.length === 0) html = "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>";
        else {
            data.forEach(item => {
                html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-success">
                   <div class="fw-bold text-success">${item.docNum}</div>
                   <div class="small my-1">${item.drug}</div>
                   <div class="d-flex gap-2 mt-2">
                      <button class="btn btn-sm btn-secondary flex-fill" onclick="app.openPdf('${item.pdfUrl}')">PDF</button>
                      <button class="btn btn-sm btn-success flex-fill" onclick="app.openReceive('${item.reqId}', '${item.drug}')">‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>
                   </div>
                </div>`;
            });
        }
        document.getElementById('approvedList').innerHTML = html;
    } catch(e) {}
};

app.openReceive = function(id, name) {
    document.getElementById('rc_reqId').value = id;
    document.getElementById('rc_display').innerText = name;
    receiveModal.show();
};

app.confirmReceive = async function() {
    const payload = {
        reqId: document.getElementById('rc_reqId').value,
        cost: document.getElementById('rc_cost').value,
        note: document.getElementById('rc_note').value
    };
    receiveModal.hide();
    try {
        await app.callApi('completeRequest', payload);
        alert("‚úÖ ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        app.loadApproved();
    } catch(e) {}
};

app.loadHistory = async function() {
    document.getElementById('historyTableBody').innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    try {
        const data = await app.callApi('getAllHistory', {startDate:s, endDate:e});
        let html = '';
        data.forEach(d => {
            let pdf = d.pdfUrl ? `<a href="#" onclick="app.openPdf('${d.pdfUrl}')"><i class="bi bi-file-pdf text-danger"></i></a>` : '';
            html += `<tr><td>${d.date}</td><td><div class="text-truncate" style="max-width:120px">${d.drug}</div>${pdf}</td><td>${d.status}</td></tr>`;
        });
        document.getElementById('historyTableBody').innerHTML = html;
    } catch(e) {}
};

// INIT
window.onload = function() {
    helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));

    const cvs = document.getElementById('sig-canvas');
    const ctx = cvs.getContext('2d');
    const resize = () => { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; };
    setTimeout(resize, 500);
    
    let isD = false;
    const getP = (e) => { const r = cvs.getBoundingClientRect(); return {x: (e.touches?e.touches[0].clientX:e.clientX)-r.left, y: (e.touches?e.touches[0].clientY:e.clientY)-r.top}; };
    const start = (e) => { isD=true; const p=getP(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e) => { if(!isD)return; const p=getP(e); ctx.lineWidth=2; ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
    const end = () => { isD=false; };
    ['mousedown','touchstart'].forEach(ev => cvs.addEventListener(ev, start, {passive:false}));
    ['mousemove','touchmove'].forEach(ev => cvs.addEventListener(ev, move, {passive:false}));
    ['mouseup','touchend'].forEach(ev => cvs.addEventListener(ev, end));

    liff.init({ liffId: LIFF_ID }).then(() => {
        if(!liff.isLoggedIn()) document.getElementById('btnLogin').classList.remove('hidden');
    });
    
    app.checkRows();
};
</script>

</body>
</html>