<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; font-size: 16px; padding-bottom: 80px; }
    
    /* Glamorous Gradient Header */
    .glam-header {
        background: linear-gradient(135deg, #004e92 0%, #000428 100%);
        color: white; padding: 15px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .btn-glam {
        background: linear-gradient(90deg, #1CB5E0 0%, #000851 100%);
        color: white; border: none;
    }
    
    /* Cards & Sections */
    .section { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    label { font-weight: 600; color: #333; margin-top: 12px; }
    
    /* Drug Row Item */
    .drug-item-card {
        border-left: 4px solid #004e92; background: #f8f9fa;
        padding: 15px; margin-bottom: 15px; border-radius: 8px; position: relative;
    }
    .remove-drug-btn { position: absolute; top: 10px; right: 10px; color: #dc3545; cursor: pointer; }

    /* Canvas */
    #sig-canvas { border: 2px dashed #bbb; border-radius: 10px; background: #fff; width: 100%; cursor: crosshair; }
    
    /* Loading */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.9); z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<div id="loadingOverlay" class="hidden">
    <div class="spinner-grow text-primary" role="status"></div>
    <div class="mt-3 fw-bold text-primary fs-5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
</div>

<div class="glam-header sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="fw-bold fs-5"><i class="bi bi-capsule"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏Ø ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
    <div>
       <button id="btnLogin" class="btn btn-sm btn-outline-light rounded-pill" onclick="app.loginLine()">
         <i class="bi bi-line"></i> Login
       </button>
       <span id="txtLoggedIn" class="badge bg-success hidden"><i class="bi bi-check"></i> LINE</span>
    </div>
  </div>
</div>

<div class="container">
  <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm">
    <li class="nav-item"><button class="nav-link active" onclick="app.show('doctor')">1. ‡πÅ‡∏û‡∏ó‡∏¢‡πå</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('pharmacy')">2. ‡πÄ‡∏†‡∏™‡∏±‡∏ä</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('receive')">3. ‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button></li>
    <li class="nav-item"><button class="nav-link" onclick="app.show('history')">4. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></li>
  </ul>

  <div id="doctor" class="section">
    <h5 class="text-primary border-bottom pb-2 mb-3">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</h5>
    <form id="reqForm">
      
      <div class="row">
         <div class="col-12"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</label><input type="text" class="form-control" name="doctorName" required></div>
      </div>

      <label class="d-flex justify-content-between align-items-center">
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤
          <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" onclick="app.addDrugRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button>
      </label>
      <div id="drugListContainer" class="mt-2">
         </div>

      <div class="row">
         <div class="col-6"><label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô)</label><input type="text" class="form-control" name="duration"></div>
         <div class="col-6"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢)</label><input type="text" class="form-control" name="quantity"></div>
      </div>
      <label class="text-muted small">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</label>

      <hr class="my-4">

      <div class="row">
         <div class="col-6"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label><input type="text" class="form-control" name="patientName"></div>
         <div class="col-6"><label>HN</label><input type="text" class="form-control" name="hn"></div>
      </div>
      <label>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</label><input type="text" class="form-control" name="diagnosis">
      <label>‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</label><input type="text" class="form-control" name="indication">
      <label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label><input type="text" class="form-control" name="staffName">
      <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><input type="text" class="form-control" name="suggestion">

      <label class="mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ç‡πâ‡∏≠)</label>
      <div class="bg-light p-3 rounded border">
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="A" id="rA"><label class="form-check-label mt-0" for="rA">A. ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="B" id="rB"><label class="form-check-label mt-0" for="rB">B. ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="C" id="rC"><label class="form-check-label mt-0" for="rC">C. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡πÉ‡∏ä‡πâ ‡∏≠‡∏¢.</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="D" id="rD"><label class="form-check-label mt-0" for="rD">D. ‡∏°‡∏µ Contraindication / Drug Interaction</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="E" id="rE"><label class="form-check-label mt-0" for="rE">E. ‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤)</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="reasonCode" value="F" id="rF"><label class="form-check-label mt-0" for="rF">F. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label></div>
        <input type="text" class="form-control mt-2" name="reasonText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
      </div>

      <label class="mt-4">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå (300x150px)</label>
      <canvas id="sig-canvas" height="150" class="shadow-sm"></canvas>
      <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="app.clearSig()">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>

      <button type="button" class="btn btn-glam w-100 mt-4 py-3 fs-5 rounded-pill shadow" onclick="app.submitData()">
         <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </form>
  </div>

  <div id="pharmacy" class="section hidden">
    <div id="pendingList"></div>
  </div>

  <div id="receive" class="section hidden">
    <div id="approvedList"></div>
  </div>

  <div id="history" class="section hidden">
    <div class="row mb-3">
        <div class="col-5"><input type="date" id="filterStart" class="form-control"></div>
        <div class="col-5"><input type="date" id="filterEnd" class="form-control"></div>
        <div class="col-2"><button class="btn btn-primary w-100" onclick="app.loadHistory()"><i class="bi bi-search"></i></button></div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<div class="modal fade" id="approveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark"><h5 class="modal-title">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
         <input type="hidden" id="ap_reqId">
         <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
         <textarea class="form-control" id="ap_drugName" rows="4"></textarea>
         <div class="row">
            <div class="col-6"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á</label><input type="text" class="form-control" id="ap_strength"></div>
            <div class="col-6"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="text" class="form-control" id="ap_quantity"></div>
         </div>
         <label>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</label><input type="text" class="form-control" id="ap_regimen">
         <label>‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏¢‡∏∑‡∏°</label>
         <select class="form-select" id="ap_pharmacistName"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" onclick="app.confirmDelete()">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        <button type="button" class="btn btn-success" onclick="app.confirmApprove()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="receiveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white"><h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
         <input type="hidden" id="rc_reqId">
         <p id="rc_drugDisplay" class="fw-bold"></p>
         <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</label><input type="text" class="form-control" id="rc_amount">
         <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="form-control" id="rc_cost">
         <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" class="form-control" id="rc_note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-success" onclick="app.confirmReceive()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ============================================
// üî• 1. CONFIG
// ============================================
const API_URL = "https://script.google.com/macros/s/AKfycbxwYS5eJYtTgKikbQ3_8LyuuG1Byw--1ojCUVRafpk3_yY9ncW9AD12XFUcYyn-i9mY/exec"; 
const LIFF_ID = "2008862022-AUe9BjR5";

var app = {};
var pendingData = [];
var approveModal, receiveModal; // Bootstrap Modal Instances

// ============================================
// üî• 2. API CALLER
// ============================================
app.callApi = async function(action, payload = {}) {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, data: payload })
        });
        const result = await response.json();
        document.getElementById('loadingOverlay').classList.add('hidden');
        if(result.status === 'error') throw new Error(result.message);
        return result.data;
    } catch(e) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        alert("System Error: " + e.message);
        throw e;
    }
};

// ============================================
// üî• 3. NAVIGATION & UI
// ============================================
app.show = function(id) {
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
    // Set Active UI logic here if needed
    
    if(id === 'doctor') { app.checkRows(); }
    if(id === 'pharmacy') app.loadPending();
    if(id === 'receive') app.loadApproved();
    if(id === 'history') app.loadHistory();
};

app.toggleType = function(val) {
    document.getElementById('imageGroup').classList.toggle('hidden', val !== 'IMAGE');
};

app.loginLine = function() {
    if (liff && !liff.isLoggedIn()) liff.login();
};

app.share = function(text, url) {
    if(!liff.isLoggedIn()) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login LINE"); return; }
    
    // Share Picker
    if(liff.isApiAvailable('shareTargetPicker')) {
        liff.shareTargetPicker([{
            type: "flex", altText: "‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å",
            contents: { type: "bubble", body: { type: "box", layout: "vertical", contents: [
                { type: "text", text: text, wrap: true, weight: "bold" },
                { type: "separator", margin: "md" },
                { type: "button", action: { type: "uri", label: "üìÑ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", uri: url }, margin: "md", style: "primary" }
            ]}}
        }]).catch(e => alert("Share Error: " + e));
    } else {
        // Fallback
        window.open('https://line.me/R/msg/text/?' + encodeURIComponent(text + " " + url));
    }
};

// ============================================
// üî• 4. DOCTOR LOGIC
// ============================================
app.addDrugRow = function() {
    const id = 'row_' + Date.now();
    const html = `
    <div class="drug-item-card" id="${id}">
        <i class="bi bi-trash remove-drug-btn" onclick="document.getElementById('${id}').remove()"></i>
        <div class="row g-2">
            <div class="col-12"><label class="mt-0">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label><input type="text" class="form-control drug-name"></div>
            <div class="col-6"><label class="mt-0">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á</label><input type="text" class="form-control drug-strength"></div>
            <div class="col-6"><label class="mt-0">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</label><input type="text" class="form-control drug-regimen"></div>
        </div>
    </div>`;
    document.getElementById('drugListContainer').insertAdjacentHTML('beforeend', html);
};

app.checkRows = function() {
    if(document.querySelectorAll('.drug-item-card').length === 0) app.addDrugRow();
};

app.collectDrugs = function() {
    const rows = document.querySelectorAll('.drug-item-card');
    let names = [], strengths = [], regimens = [];
    rows.forEach((r, i) => {
        let n = r.querySelector('.drug-name').value;
        let s = r.querySelector('.drug-strength').value;
        let reg = r.querySelector('.drug-regimen').value;
        if(n) {
            names.push(`${i+1}. ${n}`);
            strengths.push(`${i+1}. ${s}`);
            regimens.push(`${i+1}. ${reg}`);
        }
    });
    return { 
        name: names.join('\n'), 
        strength: strengths.join('\n'), 
        regimen: regimens.join('\n') 
    };
};

app.clearSig = function() {
    const cvs = document.getElementById('sig-canvas');
    const cx = cvs.getContext('2d');
    cx.clearRect(0, 0, cvs.width, cvs.height);
};

app.submitData = async function() {
    // Validate Form
    const f = document.getElementById('reqForm');
    if(!f.checkValidity()) { f.reportValidity(); return; }

    const drugs = app.collectDrugs();
    if(!drugs.name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

    // Canvas
    const cvs = document.getElementById('sig-canvas');
    const sigData = cvs.toDataURL("image/png");

    const payload = {
        doctorName: f.doctorName.value,
        staffName: f.staffName.value,
        patientName: f.patientName.value, hn: f.hn.value,
        diagnosis: f.diagnosis.value, indication: f.indication.value,
        suggestion: f.suggestion.value, 
        
        // Drugs Combined
        drugName: drugs.name, strength: drugs.strength, regimen: drugs.regimen,
        quantity: f.quantity.value, duration: f.duration.value, amount: f.amount.value,
        
        // Reason Logic
        reasonCode: f.querySelector('input[name="reasonCode"]:checked')?.value || "",
        reasonText: f.reason.value, // User fills text here for 'F' or extra info
        
        signatureData: sigData,
        imageFile: null
    };

    // File
    const fileInput = document.getElementById('imageFile');
    if(fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            payload.imageFile = e.target.result;
            await app._send(payload);
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        await app._send(payload);
    }
};

app._send = async function(pl) {
    try {
        await app.callApi('submitRequest', pl);
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.getElementById('reqForm').reset();
        document.getElementById('drugListContainer').innerHTML = '';
        app.checkRows();
        app.clearSig();
    } catch(e) {}
};

// ============================================
// üî• 5. PHARMACY LOGIC
// ============================================
app.loadPending = async function() {
    const div = document.getElementById('pendingList');
    div.innerHTML = "Loading...";
    try {
        pendingData = await app.callApi('getPendingRequests');
        if(pendingData.length === 0) { div.innerHTML = "<div class='text-center mt-4 text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>"; return; }
        
        let html = '';
        pendingData.forEach((item, index) => {
            html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-warning">
               <div class="d-flex justify-content-between">
                  <strong>${item.doctorName}</strong>
                  <span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
               </div>
               <div class="my-2" style="white-space: pre-line;">${item.drugName}</div>
               <button class="btn btn-outline-primary w-100 btn-sm" onclick="app.openApproveModal(${index})">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>`;
        });
        div.innerHTML = html;
        
        // Pre-load Pharmacist list
        const pharmacists = await app.callApi('getPharmacistList');
        const sel = document.getElementById('ap_pharmacistName');
        sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
        pharmacists.forEach(p => sel.add(new Option(p, p)));

    } catch(e) {}
};

app.openApproveModal = function(idx) {
    const item = pendingData[idx];
    document.getElementById('ap_reqId').value = item.reqId;
    document.getElementById('ap_drugName').value = item.drugName;
    document.getElementById('ap_strength').value = item.strength;
    document.getElementById('ap_quantity').value = item.quantity;
    document.getElementById('ap_regimen').value = item.regimen;
    
    approveModal.show();
};

app.confirmDelete = async function() {
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
    const id = document.getElementById('ap_reqId').value;
    try {
        await app.callApi('deleteRequest', {reqId: id});
        approveModal.hide();
        app.loadPending();
    } catch(e) {}
};

app.confirmApprove = async function() {
    const phar = document.getElementById('ap_pharmacistName').value;
    if(!phar) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£");
    
    const payload = {
        reqId: document.getElementById('ap_reqId').value,
        drugName: document.getElementById('ap_drugName').value,
        strength: document.getElementById('ap_strength').value,
        quantity: document.getElementById('ap_quantity').value,
        regimen: document.getElementById('ap_regimen').value,
        pharmacistName: phar,
        // Pass original values needed for PDF
        reason: pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value).reason,
        reasonCode: pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value).reasonCode,
        imageId: pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value).imageId,
        signatureId: pendingData.find(x => x.reqId == document.getElementById('ap_reqId').value).signatureId
    };
    
    approveModal.hide();
    try {
        const res = await app.callApi('approveAndGeneratePDF', payload);
        alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: " + res.docNum);
        app.share("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏£‡∏û.‡πÉ‡∏´‡∏°‡πà (" + res.drugName + ")", res.pdfUrl);
        app.loadPending();
    } catch(e) {}
};

// ============================================
// üî• 6. RECEIVE LOGIC
// ============================================
app.loadApproved = async function() {
    const div = document.getElementById('approvedList');
    div.innerHTML = "Loading...";
    try {
        const data = await app.callApi('getApprovedRequests');
        let html = '';
        data.forEach(item => {
            html += `<div class="card p-3 mb-3 shadow-sm border-start border-4 border-success">
               <div class="fw-bold text-success">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${item.docNum}</div>
               <div class="my-1 text-truncate">${item.drug}</div>
               <div class="small text-muted mb-2">‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ: ${item.patient}</div>
               <div class="d-flex gap-2">
                  <a href="${item.pdfUrl}" target="_blank" class="btn btn-sm btn-secondary flex-fill">PDF</a>
                  <button class="btn btn-sm btn-success flex-fill" onclick="app.openReceiveModal('${item.reqId}', '${item.drug}', '${item.qty}')">‡∏£‡∏±‡∏ö‡∏¢‡∏≤</button>
               </div>
            </div>`;
        });
        div.innerHTML = html || "<div class='text-center mt-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</div>";
    } catch(e) {}
};

app.openReceiveModal = function(id, drug, qty) {
    document.getElementById('rc_reqId').value = id;
    document.getElementById('rc_drugDisplay').innerText = drug;
    document.getElementById('rc_amount').value = qty; // Default to requested qty
    receiveModal.show();
};

app.confirmReceive = async function() {
    const payload = {
        reqId: document.getElementById('rc_reqId').value,
        amount: document.getElementById('rc_amount').value,
        cost: document.getElementById('rc_cost').value,
        note: document.getElementById('rc_note').value
    };
    
    receiveModal.hide();
    try {
        await app.callApi('completeRequest', payload);
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        
        const msg = `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ ${document.getElementById('rc_drugDisplay').innerText} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${payload.amount} ‡∏à‡∏≤‡∏Å ‡∏£‡∏û.‡∏ä‡∏∏‡∏°‡∏û‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleDateString('th-TH')} (${payload.note})`;
        if(liff.isLoggedIn()) {
             // Just send text message to chat
             if (liff.isInClient()) {
                 liff.sendMessages([{ type: 'text', text: msg }]).catch(console.error);
             } else {
                 alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (Share not avail in external browser)");
             }
        }
        
        app.loadApproved();
    } catch(e) {}
};

// ============================================
// üî• 7. HISTORY LOGIC
// ============================================
app.loadHistory = async function() {
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    
    try {
        const data = await app.callApi('getAllHistory', { startDate: s, endDate: e });
        let html = '';
        data.forEach(d => {
            let statusBadge = d.status === 'Received' ? '<span class="badge bg-success">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>' : `<span class="badge bg-secondary">${d.status}</span>`;
            let pdfBtn = d.pdfUrl ? `<a href="${d.pdfUrl}" target="_blank" class="btn btn-sm btn-link p-0"><i class="bi bi-file-pdf"></i></a>` : '';
            
            html += `<tr>
               <td>${d.date}</td>
               <td><div class="text-truncate" style="max-width: 150px;">${d.drug}</div>${pdfBtn}</td>
               <td>${statusBadge}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    } catch(e) {}
};

// ============================================
// üî• 8. INIT
// ============================================
window.onload = function() {
    // Init Modals
    approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));

    // Canvas
    const cvs = document.getElementById('sig-canvas');
    const ctx = cvs.getContext('2d');
    let isDrawing = false;
    
    // Resize
    const resize = () => {
       const ratio = Math.max(window.devicePixelRatio||1, 1);
       cvs.width = cvs.offsetWidth * ratio;
       cvs.height = cvs.offsetHeight * ratio;
       ctx.scale(ratio, ratio);
    };
    setTimeout(resize, 500);

    // Draw
    const getPos = (e) => {
        const rect = cvs.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };

    const start = (e) => { isDrawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); };
    const move = (e) => { if(!isDrawing) return; const p = getPos(e); ctx.lineWidth=2; ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
    const end = () => { isDrawing = false; };

    ['mousedown','touchstart'].forEach(ev => cvs.addEventListener(ev, start, {passive: false}));
    ['mousemove','touchmove'].forEach(ev => cvs.addEventListener(ev, move, {passive: false}));
    ['mouseup','touchend'].forEach(ev => cvs.addEventListener(ev, end));

    // LIFF
    liff.init({ liffId: LIFF_ID }).then(() => {
        if(liff.isLoggedIn()) {
            document.getElementById('btnLogin').classList.add('hidden');
            document.getElementById('txtLoggedIn').classList.remove('hidden');
        }
    });
    
    // Initial UI Setup
    app.checkRows();
};
</script>

</body>
</html>