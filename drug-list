<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฐานข้อมูลยา รพ.สวี</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery (Required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    
    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Styles for DataTables to blend with Tailwind */
        .dataTables_wrapper .dataTables_length select, 
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            outline: none;
        }
        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        table.dataTable.no-footer {
            border-bottom: 1px solid #e5e7eb;
        }
        table.dataTable thead th {
            background-color: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            color: #374151;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white flex items-center justify-between">
            <div class="flex items-center gap-4">
                <i class="fa-solid fa-pills text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold">ระบบฐานข้อมูลยา</h1>
                    <p class="text-blue-100 text-sm">โรงพยาบาลสวี (Sawi Hospital)</p>
                </div>
            </div>
            <button onclick="loadData()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded shadow transition-colors text-sm font-medium">
                <i class="fa-solid fa-rotate-right mr-2"></i> โหลดข้อมูลใหม่
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="p-12 text-center">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-gray-500">กำลังดึงข้อมูลและแปลงรูปภาพ... (อาจใช้เวลาสักครู่)</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden p-6 bg-red-50 text-red-600 border-l-4 border-red-500 m-6 rounded">
            <i class="fa-solid fa-circle-exclamation mr-2"></i> <span id="error-msg">เกิดข้อผิดพลาด</span>
        </div>

        <!-- Table Container -->
        <div id="table-container" class="hidden p-6 overflow-x-auto">
            <table id="drugTable" class="w-full text-sm text-left whitespace-nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>รูปภาพ</th>
                        <th>ชื่อยา</th>
                        <th>รหัสเบิก</th>
                        <th>รหัส HosXP</th>
                        <th>รหัส TMTID</th>
                        <th>บรรจุ</th>
                        <th>หน่วย</th>
                        <th>ชื่อการค้า</th>
                        <th>บริษัท</th>
                        <th>ราคา (฿)</th>
                        <th>กลุ่มยา</th>
                        <th>บัญชียา</th>
                        <th>บัญชีย่อย</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        // นำ URL ของ Web App ที่ Deploy จาก GAS มาใส่ตรงนี้
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxbljVfMbph_tJysEVEZ-EFyyvc25LQiGTnFmT771tHHziwujRmmv6zP96gTOsWbAmg/exec"; 

        let dataTable;

        $(document).ready(function() {
            if(GAS_URL !== "ใส่_WEB_APP_URL_ของคุณที่นี่") {
                loadData();
            } else {
                showError("กรุณาระบุ GAS_URL ในไฟล์ script ให้ถูกต้องก่อนใช้งาน");
                $('#loading').hide();
            }
        });

        function loadData() {
            $('#loading').show();
            $('#table-container').hide();
            $('#error').hide();

            fetch(GAS_URL)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        initTable(result.data);
                    } else {
                        showError("เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: " + result.message);
                    }
                })
                .catch(error => {
                    showError("ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้: " + error.message);
                })
                .finally(() => {
                    $('#loading').hide();
                });
        }

        function initTable(data) {
            // ทำลายตารางเดิมก่อน (ถ้ามี) เพื่อสร้างใหม่
            if ($.fn.DataTable.isDataTable('#drugTable')) {
                $('#drugTable').DataTable().destroy();
            }

            $('#table-container').show();

            dataTable = $('#drugTable').DataTable({
                data: data,
                pageLength: 20,
                lengthMenu: [10, 20, 50, 100],
                language: {
                    search: "ค้นหายา:",
                    lengthMenu: "แสดง _MENU_ รายการ",
                    info: "แสดงหน้า _PAGE_ จาก _PAGES_ (รวม _TOTAL_ รายการ)",
                    paginate: {
                        first: "หน้าแรก",
                        last: "หน้าสุดท้าย",
                        next: "ถัดไป",
                        previous: "ก่อนหน้า"
                    },
                    emptyTable: "ไม่พบข้อมูลยาในระบบ"
                },
                columns: [
                    { 
                        data: 'image',
                        render: function(data, type, row) {
                            if (data) {
                                return `<img src="${data}" alt="รูปยา" class="w-12 h-12 object-cover rounded border cursor-pointer hover:scale-150 transition-transform origin-left" loading="lazy">`;
                            }
                            return `<div class="w-12 h-12 bg-gray-100 border rounded flex items-center justify-center text-gray-400"><i class="fa-solid fa-image"></i></div>`;
                        },
                        orderable: false,
                        className: 'text-center'
                    },
                    { data: 'name', className: 'font-medium text-blue-600' },
                    { data: 'code' },
                    { data: 'working_code' },
                    { data: 'tmtid' },
                    { data: 'per_pack', className: 'text-center' },
                    { data: 'unit' },
                    { data: 'trade_name' },
                    { data: 'company' },
                    { 
                        data: 'price',
                        render: $.fn.dataTable.render.number(',', '.', 2, ''),
                        className: 'text-right text-green-600 font-medium'
                    },
                    { data: 'category' },
                    { 
                        data: 'ed',
                        render: function(data) {
                            if (data === 'E') return `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded border border-green-200">ED (ในบัญชี)</span>`;
                            if (data === 'N') return `<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded border border-red-200">NED (นอกบัญชี)</span>`;
                            return data;
                        },
                        className: 'text-center'
                    },
                    { data: 'list', className: 'text-center' }
                ],
                // ปรับแต่งการเรียงลำดับเริ่มต้น
                order: [[1, 'asc']], 
            });
        }

        function showError(msg) {
            $('#error-msg').text(msg);
            $('#error').show();
        }
    </script>
</body>
</html>